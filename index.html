<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltimateRECalc - Professional Calculator Suite by Zebari Group IT</title>
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- HTML2Canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #7c3aed;
            --accent-color: #ec4899;
            --text-color: #1f2937;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
        }
        
        .dark {
            --primary-color: #3b82f6;
            --secondary-color: #8b5cf6;
            --accent-color: #f472b6;
            --text-color: #f9fafb;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --border-color: #374151;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .mobile-menu-button {
            display: none;
            padding: 20px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
        }

        .mobile-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            padding: 10px 0;
        }

        .mobile-menu .tab {
            padding: 12px 20px;
            display: block;
            width: 100%;
            text-align: left;
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .mobile-menu-button {
                display: block;
            }

            .tabs {
                display: none;
            }

            .mobile-menu.show {
                display: block;
            }

            .actions {
                gap: 10px;
            }

            .actions .btn-export {
                display: none;
            }

            nav {
                padding: 15px;
            }
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .logo i {
            align-items: center;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-wrapper {
            position: relative;
            width: 48px;
            height: 24px;
            background-color: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
        }
        
        .toggle-dot {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .dark .toggle-dot {
            transform: translateX(24px);
        }
        
        .dark .toggle-wrapper {
            background-color: #4b5563;
        }
        
        /* Dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--card-bg);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            z-index: 10;
            border: 1px solid var(--border-color);
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .dropdown-content a {
            color: var(--text-color);
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .dropdown-content a:hover {
            background-color: var(--bg-color);
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-export {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-red {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-red:hover {
            background-color: #dc2626;
        }
        
        .btn-green {
            background-color: #10b981;
            color: white;
        }
        
        .btn-green:hover {
            background-color: #059669;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-top: 20px;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .calculator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 50px;
        }
        
        @media (max-width: 768px) {
            .calculator {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: right;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background-color: rgba(59, 130, 246, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .dark .stat-box {
            background-color: rgba(59, 130, 246, 0.2);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dark .stat-label {
            color: #9ca3af;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 25px;
        }
        
        .details-table {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .details-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .details-label {
            font-size: 0.875rem;
        }
        
        .details-value {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .hidden {
            display: none;
        }
        
        .report-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .report-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
        }
        
        .bg-blue-light {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .dark .bg-blue-light {
            background-color: rgba(59, 130, 246, 0.2);
        }
        
        .bg-green-light {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .dark .bg-green-light {
            background-color: rgba(16, 185, 129, 0.2);
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .report-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .report-charts {
                grid-template-columns: 1fr;
            }
        }
        
        .report-footer {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dark .report-footer {
            color: #9ca3af;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-color);
            color: var(--bg-color);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .closing-cost-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .closing-cost-item .label {
            flex: 1;
        }
        
        .closing-cost-item .amount {
            margin: 0 15px;
            font-weight: 500;
        }
        
        .closing-cost-item .split {
            display: flex;
            gap: 10px;
        }
        
        .split-option {
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .split-option.active {
            background-color: var(--primary-color);
            color: white;
        }

        .expense-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .expense-section h3 {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .expense-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                align-items: flex-start;
            }

            .actions {
                flex-direction: row-reverse;
                align-items: flex-start;
                gap: 10px;
            }

            .tabs {
                display: none;
                flex-direction: column;
                align-items: flex-start;
            }

            .tab {
                width: 100%;
                text-align: left;
                padding: 12px 10px;
            }

            .calculator {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .report-grid {
                grid-template-columns: 1fr;
            }

            .report-charts {
                grid-template-columns: 1fr;
            }

            .details-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .details-label, .details-value {
                width: 100%;
                text-align: left;
            }

            .details-value {
                margin-top: 5px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }

            .card-title {
                font-size: 1rem;
            }

            .form-group label {
                font-size: 0.875rem;
            }

            input[type="number"], select {
                padding: 8px 10px;
            }

            button {
                padding: 2px 6px;
            }

            .btn-primary, .btn-export {
                font-size: 0.875rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .details-label, .details-value {
                font-size: 0.75rem;
            }

            .report-header h1 {
                font-size: 1.5rem;
            }

            .report-header p {
                font-size: 0.75rem;
            }

            .report-section h2 {
                font-size: 1.125rem;
            }

            .report-section h3 {
                font-size: 1rem;
            }

            .report-footer p {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="dark">
    <!-- Navigation bar -->
    <nav>
        <div class="logo">
            <i class="fas fa-calculator"></i>
            <span>UltimateRECalc</span>
            <button class="mobile-menu-button">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        </div>
        


        <div class="mobile-menu">
            <div class="tab" data-tab="mortgage">Mortgage Calculator</div>
            <div class="tab" data-tab="investment">Investment Property</div>
            <div class="tab" data-tab="cashflow">Rental Cash Flow</div>
            <div class="tab" data-tab="closing">Closing Costs</div>
            <div class="tab" data-tab="buyer">Buyer Cost Sheet</div>
            <div class="tab" data-tab="report">Generated Report</div>
        </div>
        
        <div class="actions">
            <div class="theme-toggle">
                <i class="far fa-sun"></i>
                <div class="toggle-wrapper" id="theme-toggle">
                    <div class="toggle-dot"></div>
                </div>
                <i class="far fa-moon"></i>
            </div>
            
            <!-- Add logo upload button -->
            <div class="dropdown" style="margin-right: 15px;">
                <button class="btn-primary" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-cog"></i> Your Logo
                </button>
                <div class="dropdown-content" style="width: 250px; padding: 15px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px;">Company Logo</label>
                        <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                        <div id="logo-preview" style="width: 100%; height: 60px; border: 2px dashed var(--border-color); border-radius: 4px; display: flex; justify-content: center; align-items: center; margin-bottom: 8px; cursor: pointer; background-size: contain; background-repeat: no-repeat; background-position: center;">
                            <span id="logo-placeholder">Click to upload logo</span>
                        </div>
                        <button id="remove-logo" class="btn-red" style="width: 100%; display: none;">Remove Logo</button>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px;">Company Name</label>
                        <input type="text" id="company-name" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color);" placeholder="Enter company name">
                    </div>
                </div>
            </div>
            
            <span style="margin-right: 15px; font-size: 0.875rem; opacity: 0.8;">
                <a href="http://www.zebarigroup.com" target="_blank" style="color: inherit; text-decoration: none;">
                    Powered by Zebari Group IT Services
                </a>
            </span>
            
            <button id="export-pdf" class="btn-export btn-red">
                <i class="far fa-file-pdf"></i> PDF
            </button>
            <button id="export-jpg" class="btn-export btn-green">
                <i class="far fa-file-image"></i> JPG
            </button>
        </div>
    </nav>
    
    <!-- Main content -->
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab" data-tab="mortgage">Mortgage Calculator</div>
            <div class="tab" data-tab="investment">Investment Property</div>
            <div class="tab" data-tab="cashflow">Rental Cash Flow</div>
            <div class="tab" data-tab="closing">Closing Costs</div>
            <div class="tab" data-tab="buyer">Buyer Cost Sheet</div>
            <div class="tab" data-tab="report">Generated Report</div>
        </div>

        <!-- Mortgage Calculator -->
        <div id="mortgage-calculator" class="calculator fade-in">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-home"></i> Mortgage Calculator</h2>
                
                <div class="form-group">
                    <label for="property-price">Property Price ($)</label>
                    <input type="number" id="property-price" value="350000">
                </div>
                
                <div class="form-group">
                    <label for="down-payment-slider">Down Payment (%)</label>
                    <div class="slider-container">
                        <input type="range" id="down-payment-slider" min="0" max="50" step="1" value="20">
                        <span id="down-payment-value" class="slider-value">20%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="loan-term">Loan Term (years)</label>
                    <select id="loan-term">
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30" selected>30 years</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="interest-rate-slider">Interest Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="interest-rate-slider" min="2" max="10" step="0.1" value="4.5">
                        <span id="interest-rate-value" class="slider-value">4.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="property-tax">Property Tax ($/year)</label>
                    <input type="number" id="property-tax" value="3500">
                </div>
                
                <div class="form-group">
                    <label for="home-insurance">Home Insurance ($/year)</label>
                    <input type="number" id="home-insurance" value="1200">
                </div>
                
                <div class="form-group">
                    <label for="hoa">HOA Fees ($/month)</label>
                    <input type="number" id="hoa" value="0">
                </div>
                
                <button id="calculate-mortgage" class="btn-primary" style="width: 100%;">Calculate Mortgage</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="mortgage">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="mortgage">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="mortgage">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="mortgage" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Monthly Breakdown</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Principal & Interest</div>
                        <div class="stat-value" id="principal-interest">$1,425</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Total Monthly</div>
                        <div class="stat-value" id="total-monthly">$1,767</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="payment-chart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="amortization-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Loan Summary</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Loan Amount:</div>
                        <div class="details-value" id="loan-amount">$280,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Down Payment:</div>
                        <div class="details-value" id="down-payment-amount">$70,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Interest Paid:</div>
                        <div class="details-value" id="total-interest">$233,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Cost:</div>
                        <div class="details-value" id="total-cost">$583,000</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Investment Property Calculator -->
        <div id="investment-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Investment Property Analysis</h2>
                
                <div class="form-group">
                    <label for="inv-purchase-price">Purchase Price ($)</label>
                    <input type="number" id="inv-purchase-price" value="300000">
                </div>
                
                <div class="form-group">
                    <label for="annual-rent">Expected Annual Rent ($)</label>
                    <input type="number" id="annual-rent" value="24000">
                </div>
                
                <div class="form-group">
                    <label for="expenses-slider">Annual Property Expenses (%)</label>
                    <div class="slider-container">
                        <input type="range" id="expenses-slider" min="20" max="50" step="1" value="35">
                        <span id="expenses-value" class="slider-value">35%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vacancy-slider">Vacancy Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="vacancy-slider" min="0" max="15" step="1" value="5">
                        <span id="vacancy-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="appreciation-slider">Annual Appreciation Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="appreciation-slider" min="0" max="10" step="0.5" value="3.5">
                        <span id="appreciation-value" class="slider-value">3.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="holding-period">Holding Period (years)</label>
                    <select id="holding-period">
                        <option value="5">5 years</option>
                        <option value="10" selected>10 years</option>
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30">30 years</option>
                    </select>
                </div>
                
                <button id="calculate-investment" class="btn-primary" style="width: 100%;">Calculate Investment Returns</button>
                
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="investment">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="investment">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="investment">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="investment" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Investment Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Cash-on-Cash ROI</div>
                        <div class="stat-value" id="cash-on-cash">8.4%</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Cap Rate</div>
                        <div class="stat-value" id="cap-rate">6.2%</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="investment-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Monthly Cash Flow</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Monthly Rent:</div>
                        <div class="details-value" id="monthly-rent">$2,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Monthly Expenses:</div>
                        <div class="details-value" id="monthly-expenses">$700</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Monthly Cash Flow:</div>
                        <div class="details-value" id="monthly-cashflow">$1,300</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Annual Cash Flow:</div>
                        <div class="details-value" id="annual-cashflow">$15,600</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Future Value</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Property Value After <span id="period-label">10</span> Years:</div>
                        <div class="details-value" id="future-property-value">$423,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Rental Income:</div>
                        <div class="details-value" id="total-rental-income">$240,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Return:</div>
                        <div class="details-value" id="total-return">$363,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Annualized Return:</div>
                        <div class="details-value" id="annualized-return">12.1%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rental Cash Flow Calculator -->
        <div id="cashflow-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-money-bill-wave"></i> Rental Cash Flow Calculator</h2>
                
                <div class="form-group">
                    <label for="rental-income">Monthly Rental Income ($)</label>
                    <input type="number" id="rental-income" value="2000">
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1rem; font-weight: 500;">Monthly Expenses</h3>
                
                <div class="form-group">
                    <label for="mortgage-payment">Mortgage Payment ($)</label>
                    <input type="number" id="mortgage-payment" value="1200">
                </div>
                
                <div class="form-group">
                    <label for="rental-property-tax">Property Taxes ($)</label>
                    <input type="number" id="rental-property-tax" value="250">
                </div>
                
                <div class="form-group">
                    <label for="rental-insurance">Insurance ($)</label>
                    <input type="number" id="rental-insurance" value="100">
                </div>
                
                <div class="form-group">
                    <label for="management-slider">Property Management (%)</label>
                    <div class="slider-container">
                        <input type="range" id="management-slider" min="0" max="15" step="1" value="8">
                        <span id="management-value" class="slider-value">8%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="maintenance-slider">Maintenance Reserve (%)</label>
                    <div class="slider-container">
                        <input type="range" id="maintenance-slider" min="0" max="15" step="1" value="5">
                        <span id="maintenance-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="rental-vacancy-slider">Vacancy Reserve (%)</label>
                    <div class="slider-container">
                        <input type="range" id="rental-vacancy-slider" min="0" max="15" step="1" value="5">
                        <span id="rental-vacancy-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <button id="calculate-cashflow" class="btn-primary" style="width: 100%;">Calculate Cash Flow</button>
                
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="cashflow">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="cashflow">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="cashflow">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="cashflow" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Cash Flow Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Monthly Cash Flow</div>
                        <div class="stat-value" id="rental-monthly-cashflow">$160</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Annual Cash Flow</div>
                        <div class="stat-value" id="rental-annual-cashflow">$1,920</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="expense-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Cash Flow Details</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Monthly Rent:</div>
                        <div class="details-value" id="rent-display">$2,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Monthly Expenses:</div>
                        <div class="details-value" id="total-expenses">$1,840</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Cash-on-Cash Return:</div>
                        <div class="details-value" id="rental-coc-return">6.4%</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Expense Ratio:</div>
                        <div class="details-value" id="expense-ratio">92%</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">5-Year Projection</h3>
                <table id="projection-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.875rem;">
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <th style="text-align: left; padding: 8px 5px;">Year</th>
                        <th style="text-align: right; padding: 8px 5px;">Income</th>
                        <th style="text-align: right; padding: 8px 5px;">Expenses</th>
                        <th style="text-align: right; padding: 8px 5px;">Cash Flow</th>
                    </tr>
                    <!-- Projection data will be inserted here -->
                </table>
            </div>
        </div>

        <!-- Add the new Closing Costs Calculator section -->
        <div id="closing-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Closing Costs Calculator</h2>
                
                <div class="form-group">
                    <label for="closing-price">Sales Price ($) *</label>
                    <input type="number" id="closing-price" value="300000">
                </div>
                
                <div class="form-group">
                    <label for="closing-mortgage">Mortgage Amount ($) *</label>
                    <input type="number" id="closing-mortgage" value="240000">
                </div>
                
                <div class="form-group">
                    <label for="property-type">Property Type *</label>
                    <select id="property-type">
                        <option value="single">Single Family Residence</option>
                        <option value="condo">Condominium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="commission-rate">Real Estate Professional Service (%) *</label>
                    <input type="number" id="commission-rate" value="6" min="0" max="10" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="deed-pages">Number of Deed Pages *</label>
                    <input type="number" id="deed-pages" value="2" min="1">
                </div>
                
                <div class="form-group">
                    <label for="mortgage-pages">Number of Mortgage Pages *</label>
                    <input type="number" id="mortgage-pages" value="20" min="1">
                </div>
                
                <button id="calculate-closing" class="btn-primary" style="width: 100%;">Calculate Closing Costs</button>
                <button id="clear-closing" class="btn-red" style="width: 100%; margin-top: 10px;">Clear Form</button>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Closing Costs Breakdown</h2>
                
                <div class="closing-cost-item" style="margin-bottom: 20px;">
                    <div class="stat-box">
                        <div class="stat-label">Buyer Total</div>
                        <div class="stat-value" id="buyer-total">$0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Seller Total</div>
                        <div class="stat-value" id="seller-total">$0</div>
                    </div>
                </div>

                <div class="closing-costs-table">
                    <!-- Individual cost items will be inserted here by JavaScript -->
                </div>
                
                <p style="font-size: 0.875rem; color: var(--text-color); opacity: 0.7; margin-top: 20px;">
                    Note: This calculator is meant for estimate purposes only, and may not reflect final cost. 
                    Settlement fees vary widely by the services provided. Please contact your provider for a personalized quote.
                </p>
            </div>
        </div>

        <!-- Add the new Buyer Cost Sheet Calculator section -->
        <div id="buyer-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Buyer Cost Sheet Calculator</h2>
                
                <div class="form-group">
                    <label for="buyer-sales-price">Sales Price ($) *</label>
                    <input type="number" id="buyer-sales-price" value="300000">
                </div>
                
                <div class="form-group">
                    <label for="buyer-down-payment">Down Payment ($) *</label>
                    <input type="number" id="buyer-down-payment" value="60000">
                </div>
                
                <div class="form-group">
                    <label for="buyer-mortgage">Mortgage ($) *</label>
                    <input type="number" id="buyer-mortgage" value="240000">
                </div>
                
                <div class="form-group">
                    <label for="buyer-mortgage-rate">Mortgage Rate (%) *</label>
                    <input type="number" id="buyer-mortgage-rate" value="6.5" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="buyer-points">Points *</label>
                    <input type="number" id="buyer-points" value="0" step="0.125">
                </div>
                
                <div class="form-group">
                    <label for="buyer-days-interest">Days Interest Payable *</label>
                    <input type="number" id="buyer-days-interest" value="30">
                </div>

                <button id="calculate-buyer" class="btn-primary" style="width: 100%;">Calculate Cost Sheet</button>
                <button id="clear-buyer" class="btn-red" style="width: 100%; margin-top: 10px;">Clear Form</button>
            </div>
            
            <!-- Results -->
            <div class="card">
                <div class="expense-section">
                    <h3>Professional Fees</h3>
                    <div class="expense-grid">
                        <div class="form-group">
                            <label for="buyer-broker">Broker ($)</label>
                            <input type="number" id="buyer-broker" value="0">
                        </div>
                        <div class="form-group">
                            <label for="buyer-appraiser">Appraiser ($)</label>
                            <input type="number" id="buyer-appraiser" value="500">
                        </div>
                        <div class="form-group">
                            <label for="buyer-attorney">Attorney (Lender) ($)</label>
                            <input type="number" id="buyer-attorney" value="800">
                        </div>
                        <div class="form-group">
                            <label for="buyer-surveyor">Surveyor ($)</label>
                            <input type="number" id="buyer-surveyor" value="375">
                        </div>
                        <div class="form-group">
                            <label for="buyer-escrow-fee">Escrow Fee ($)</label>
                            <input type="number" id="buyer-escrow-fee" value="350">
                        </div>
                    </div>
                </div>

                <div class="expense-section">
                    <h3>Insurance</h3>
                    <div class="expense-grid">
                        <div class="form-group">
                            <label for="buyer-hazard">Hazard Insurance ($)</label>
                            <input type="number" id="buyer-hazard" value="1200">
                        </div>
                        <div class="form-group">
                            <label for="buyer-flood">Flood Insurance ($)</label>
                            <input type="number" id="buyer-flood" value="0">
                        </div>
                        <div class="form-group">
                            <label for="buyer-title">Title Insurance ($)</label>
                            <input type="number" id="buyer-title" value="1500">
                        </div>
                        <div class="form-group">
                            <label for="buyer-guaranty">Guaranty Fee ($)</label>
                            <input type="number" id="buyer-guaranty" value="0">
                        </div>
                    </div>
                </div>

                <div class="expense-section">
                    <h3>Mortgage Cost</h3>
                    <div class="expense-grid">
                        <div class="form-group">
                            <label for="buyer-discount">Discount ($)</label>
                            <input type="number" id="buyer-discount" value="0">
                        </div>
                        <div class="form-group">
                            <label for="buyer-points-cost">Points ($)</label>
                            <input type="number" id="buyer-points-cost" value="0" disabled>
                        </div>
                        <div class="form-group">
                            <label for="buyer-interest">Interest ($)</label>
                            <input type="number" id="buyer-interest" value="0" disabled>
                        </div>
                        <div class="form-group">
                            <label for="buyer-doc-fees">Document Fees ($)</label>
                            <input type="number" id="buyer-doc-fees" value="1200">
                        </div>
                        <div class="form-group">
                            <label for="buyer-origination">Origination Fees ($)</label>
                            <input type="number" id="buyer-origination" value="1500">
                        </div>
                    </div>
                </div>

                <div class="expense-section">
                    <h3>Estimated Net Payable at Closing</h3>
                    <div class="details-row" style="margin-top: 20px; font-size: 1.2em;">
                        <div class="details-label">Total Due:</div>
                        <div class="details-value" id="buyer-total-due">$0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Generated Report -->
        <div id="report-calculator" class="hidden">
            <div class="report-container" id="report-section">
                <div class="report-header">
                    <div>
                        <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 5px;">Real Estate Investment Analysis</h1>
                        <p id="report-date" style="color: #6b7280;">Generated on March 12, 2025</p>
                    </div>
                    <div style="width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-color); display: flex; justify-content: center; align-items: center;">
                        <i class="fas fa-home" style="font-size: 2rem; color: white;"></i>
                    </div>
                </div>
                
                <!-- Property Overview -->
                <div class="report-section bg-blue-light">
                    <h2 style="font-size: 1.375rem; font-weight: 600; margin-bottom: 15px;">Property Overview</h2>
                    <div class="report-grid">
                        <div>
                            <div class="details-table">
                                <div class="details-row">
                                    <div class="details-label">Purchase Price:</div>
                                    <div class="details-value" id="report-purchase-price">$350,000</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Down Payment:</div>
                                    <div class="details-value" id="report-down-payment">$70,000 (20%)</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Loan Amount:</div>
                                    <div class="details-value" id="report-loan-amount">$280,000</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Loan Term:</div>
                                    <div class="details-value" id="report-loan-term">30 years</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Interest Rate:</div>
                                    <div class="details-value" id="report-interest-rate">4.5%</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="details-table">
                                <div class="details-row">
                                    <div class="details-label">Monthly Payment:</div>
                                    <div class="details-value" id="report-monthly-payment">$1,425</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Annual Property Tax:</div>
                                    <div class="details-value" id="report-property-tax">$3,500</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Monthly Cash Flow:</div>
                                    <div class="details-value" id="report-cash-flow">$160</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Cash-on-Cash Return:</div>
                                    <div class="details-value" id="report-coc-return">6.4%</div>
                                </div>
                                <div class="details-row">
                                    <div class="details-label">Cap Rate:</div>
                                    <div class="details-value" id="report-cap-rate">6.2%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Key Financial Highlights -->
                <div style="margin: 30px 0;">
                    <h2 style="font-size: 1.375rem; font-weight: 600; margin-bottom: 15px;">Key Financial Highlights</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background-color: var(--bg-color); padding: 15px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 5px;">Monthly Payment</p>
                            <p style="font-size: 1.25rem; font-weight: 700;" id="report-highlight-payment">$1,767</p>
                        </div>
                        <div style="background-color: var(--bg-color); padding: 15px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 5px;">Total Interest</p>
                            <p style="font-size: 1.25rem; font-weight: 700;" id="report-highlight-interest">$233,000</p>
                        </div>
                        <div style="background-color: var(--bg-color); padding: 15px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 5px;">Future Value (10 Years)</p>
                            <p style="font-size: 1.25rem; font-weight: 700;" id="report-highlight-future-value">$423,000</p>
                        </div>
                    </div>
                </div>
                
                <!-- Visual Reports -->
                <div class="report-charts">
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 10px;">Monthly Payment Breakdown</h3>
                        <div style="height: 250px; position: relative;">
                            <canvas id="report-payment-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 10px;">Amortization Overview</h3>
                        <div style="height: 250px; position: relative;">
                            <canvas id="report-amortization-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="report-charts">
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 10px;">Investment Performance</h3>
                        <div style="height: 250px; position: relative;">
                            <canvas id="report-investment-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 10px;">Expense Breakdown</h3>
                        <div style="height: 250px; position: relative;">
                            <canvas id="report-expense-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Investment Summary -->
                <div class="report-section bg-green-light">
                    <h2 style="font-size: 1.375rem; font-weight: 600; margin-bottom: 15px;">Investment Summary</h2>
                    <div class="details-table">
                        <div class="details-row">
                            <div class="details-label">Total Investment:</div>
                            <div class="details-value" id="report-total-investment">$70,000</div>
                        </div>
                        <div class="details-row">
                            <div class="details-label">Total Return After 10 Years:</div>
                            <div class="details-value" id="report-total-return">$363,000</div>
                        </div>
                        <div class="details-row">
                            <div class="details-label">Annualized Return:</div>
                            <div class="details-value" id="report-annualized-return">12.1%</div>
                        </div>
                        <div class="details-row">
                            <div class="details-label">Total Rental Income:</div>
                            <div class="details-value" id="report-total-rental-income">$240,000</div>
                        </div>
                    </div>
                    
                    <div style="background-color: var(--card-bg); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h3 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 10px;">5-Year Projection</h3>
                        <table id="report-projection-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 8px 5px;">Year</th>
                                <th style="text-align: right; padding: 8px 5px;">Property Value</th>
                                <th style="text-align: right; padding: 8px 5px;">Annual Cash Flow</th>
                                <th style="text-align: right; padding: 8px 5px;">Cumulative Return</th>
                            </tr>
                            <!-- Projection data will be inserted here -->
                        </table>
                    </div>
                </div>
                
                <!-- Final Notes -->
                <div class="report-footer">
                    <p style="font-style: italic; margin-bottom: 15px;">This report is provided for informational purposes only and should not be considered financial advice. Actual results may vary.</p>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p style="font-weight: 500;">Prepared for: Client Name</p>
                            <p>Your Real Estate Professional</p>
                        </div>
                        <div>
                            <p>Powered by UltimateRECalc</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer style="margin-top: 50px; padding: 20px; text-align: center; border-top: 1px solid var(--border-color);">
            <div style="max-width: 600px; margin: 0 auto;">
                <p style="margin-bottom: 15px; font-size: 0.875rem; color: var(--text-color); opacity: 0.8;">
                    UltimateRECalc is provided free of charge for your use. While we strive for accuracy, we make no guarantees regarding the correctness of calculations or information provided. Please verify all calculations with appropriate professionals.
                </p>
                <p style="margin-bottom: 20px; font-size: 0.875rem; color: var(--text-color); opacity: 0.8;">
                    If you find this tool helpful, consider supporting its development:
                </p>
                <form action="https://www.paypal.com/donate" method="post" target="_blank">
                    <input type="hidden" name="business" value="matthew@zebarigroup.com">
                    <input type="hidden" name="no_recurring" value="0">
                    <input type="hidden" name="item_name" value="Support UltimateRECalc Development">
                    <button type="submit" class="btn-primary" style="display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fab fa-paypal"></i> Donate via PayPal
                    </button>
                </form>
            </div>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add logo handling code near the top
            const logoUpload = document.getElementById('logo-upload');
            const logoPreview = document.getElementById('logo-preview');
            const logoPlaceholder = document.getElementById('logo-placeholder');
            const removeLogoBtn = document.getElementById('remove-logo');
            const companyNameInput = document.getElementById('company-name');

            // Load saved logo and company name
            try {
                const savedLogo = localStorage.getItem('companyLogo');
                const savedCompanyName = localStorage.getItem('companyName');
                
                if (savedLogo) {
                    logoPreview.style.backgroundImage = `url(${savedLogo})`;
                    logoPlaceholder.style.display = 'none';
                    removeLogoBtn.style.display = 'block';
                }
                
                if (savedCompanyName) {
                    companyNameInput.value = savedCompanyName;
                }
            } catch (e) {
                console.warn('Unable to load saved logo:', e);
            }

            // Logo upload handling
            logoPreview.addEventListener('click', () => logoUpload.click());
            
            logoUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            localStorage.setItem('companyLogo', e.target.result);
                            logoPreview.style.backgroundImage = `url(${e.target.result})`;
                            logoPlaceholder.style.display = 'none';
                            removeLogoBtn.style.display = 'block';
                        } catch (err) {
                            console.warn('Unable to save logo:', err);
                            alert('Unable to save logo. The file might be too large.');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeLogoBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                try {
                    localStorage.removeItem('companyLogo');
                    logoPreview.style.backgroundImage = 'none';
                    logoPlaceholder.style.display = 'block';
                    removeLogoBtn.style.display = 'none';
                } catch (e) {
                    console.warn('Unable to remove logo:', e);
                }
            });

            companyNameInput.addEventListener('change', function() {
                try {
                    localStorage.setItem('companyName', this.value);
                } catch (e) {
                    console.warn('Unable to save company name:', e);
                }
            });

            // DOM Elements
            const themeToggle = document.getElementById('theme-toggle');
            const tabs = document.querySelectorAll('.tab');
            const calculators = ['mortgage-calculator', 'investment-calculator', 'cashflow-calculator', 'closing-calculator', 'buyer-calculator', 'report-calculator'];
            const exportPdfBtn = document.getElementById('export-pdf');
            const exportJpgBtn = document.getElementById('export-jpg');
            
            // Chart objects
            let paymentChart = null;
            let amortizationChart = null;
            let investmentChart = null;
            let expenseChart = null;
            let reportPaymentChart = null;
            let reportAmortizationChart = null;
            let reportInvestmentChart = null;
            let reportExpenseChart = null;
            
            // Try to use theme preference, with fallback if localStorage is unavailable
            let currentTheme = 'dark';
            try {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    document.body.classList.remove('dark');
                    currentTheme = 'light';
                }
            } catch (e) {
                // localStorage not available - just use the default theme
            }
            
            // More robust check for restricted environment
            const isRestricted = (() => {
                try {
                    // Test localStorage access
                    window.localStorage;
                    
                    // Also test cross-origin restrictions
                    try {
                        // Attempt to access parent document - will fail in restricted environments
                        if (window.parent && window.parent !== window) {
                            window.parent.document;
                        }
                        return false;
                    } catch (e) {
                        // Cross-origin restriction detected
                        return true;
                    }
                } catch (e) {
                    // localStorage restriction detected
                    return true;
                }
            })();

            // Add warning about export if in restricted environment
            if (isRestricted) {
                // Add a note about export limitations in this environment
                const actions = document.querySelector('.actions');
                const warningMsg = document.createElement('div');
                warningMsg.style.fontSize = '0.75rem';
                warningMsg.style.color = '#ef4444';
                warningMsg.style.marginRight = '10px';
                warningMsg.textContent = 'Export unavailable in preview';
                actions.insertBefore(warningMsg, document.getElementById('export-pdf'));
                
                // Replace export button functionality to avoid security errors
                document.getElementById('export-pdf').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('Export is not available in this preview environment. In a production environment, this would generate a PDF of the report.');
                }, true);
                
                document.getElementById('export-jpg').addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('Export is not available in this preview environment. In a production environment, this would generate a JPG of the report.');
                }, true);
            }
            
            // Initialize charts and calculator values
            initializeCharts();
            calculateMortgage();
            calculateInvestment();
            calculateCashFlow();
            generateReport();
            
            // Theme toggle functionality
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                currentTheme = isDark ? 'dark' : 'light';
                
                // Try to save to localStorage if available
                try {
                    localStorage.setItem('theme', currentTheme);
                } catch (e) {
                    // localStorage not available - just continue
                }
                
                reinitializeCharts();
            });
            
            // Tab switching functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all calculators
                    calculators.forEach(calc => {
                        document.getElementById(calc).classList.add('hidden');
                    });
                    
                    // Show the selected calculator
                    const tabId = tab.getAttribute('data-tab');
                    const selectedCalculator = document.getElementById(`${tabId}-calculator`);
                    if (selectedCalculator) {
                        selectedCalculator.classList.remove('hidden');
                        
                        // If showing the report tab, regenerate report
                        if (tabId === 'report') {
                            generateReport();
                        }
                    }
                });
            });
            
            // Slider value displays
            const sliders = [
                { slider: 'down-payment-slider', display: 'down-payment-value', suffix: '%' },
                { slider: 'interest-rate-slider', display: 'interest-rate-value', suffix: '%' },
                { slider: 'expenses-slider', display: 'expenses-value', suffix: '%' },
                { slider: 'vacancy-slider', display: 'vacancy-value', suffix: '%' },
                { slider: 'appreciation-slider', display: 'appreciation-value', suffix: '%' },
                { slider: 'management-slider', display: 'management-value', suffix: '%' },
                { slider: 'maintenance-slider', display: 'maintenance-value', suffix: '%' },
                { slider: 'rental-vacancy-slider', display: 'rental-vacancy-value', suffix: '%' }
            ];
            
            sliders.forEach(item => {
                const slider = document.getElementById(item.slider);
                const display = document.getElementById(item.display);
                
                if (slider && display) {
                    // Set initial value
                    display.textContent = slider.value + item.suffix;
                    
                    // Update value on slider change
                    slider.addEventListener('input', () => {
                        display.textContent = slider.value + item.suffix;
                    });
                }
            });
            
            // Calculator button event listeners
            document.getElementById('calculate-mortgage').addEventListener('click', calculateMortgage);
            document.getElementById('calculate-investment').addEventListener('click', calculateInvestment);
            document.getElementById('calculate-cashflow').addEventListener('click', calculateCashFlow);
            
            // Export buttons
            exportPdfBtn.addEventListener('click', exportToPDF);
            exportJpgBtn.addEventListener('click', exportToJPG);
            
            // Initialize charts
            function initializeCharts() {
                // Theme-aware colors
                const isDark = document.body.classList.contains('dark');
                const textColor = isDark ? '#f9fafb' : '#1f2937';
                const gridColor = isDark ? '#374151' : '#e5e7eb';
                
                // Default options for line/bar charts
                const defaultOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    }
                };
                
                // Default options for pie/doughnut charts
                const pieOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor
                            }
                        }
                    }
                };
                
                // Payment Breakdown Chart
                const paymentCtx = document.getElementById('payment-chart').getContext('2d');
                paymentChart = new Chart(paymentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Principal & Interest', 'Property Tax', 'Insurance', 'HOA'],
                        datasets: [{
                            data: [1425, 292, 100, 0],
                            backgroundColor: ['#3b82f6', '#7c3aed', '#ec4899', '#10b981']
                        }]
                    },
                    options: pieOptions
                });
                
                // Amortization Chart
                const amortizationCtx = document.getElementById('amortization-chart').getContext('2d');
                amortizationChart = new Chart(amortizationCtx, {
                    type: 'line',
                    data: {
                        labels: ['Year 5', 'Year 10', 'Year 15', 'Year 20', 'Year 25', 'Year 30'],
                        datasets: [
                            {
                                label: 'Principal',
                                data: [38000, 83000, 138000, 204000, 280000],
                                borderColor: '#3b82f6',
                                backgroundColor: '#3b82f6',
                                tension: 0.1
                            },
                            {
                                label: 'Interest',
                                data: [62000, 105000, 137000, 156000, 0],
                                borderColor: '#7c3aed',
                                backgroundColor: '#7c3aed',
                                tension: 0.1
                            }
                        ]
                    },
                    options: defaultOptions
                });
                
                // Investment Chart
                const investmentCtx = document.getElementById('investment-chart').getContext('2d');
                investmentChart = new Chart(investmentCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Year 0', 'Year 2', 'Year 4', 'Year 6', 'Year 8', 'Year 10'],
                        datasets: [
                            {
                                label: 'Property Value',
                                data: [300000, 321368, 344257, 368777, 395043, 423180],
                                backgroundColor: '#3b82f6'
                            },
                            {
                                label: 'Cumulative Cash Flow',
                                data: [0, 31824, 66211, 103288, 143195, 186095],
                                backgroundColor: '#10b981'
                            }
                        ]
                    },
                    options: defaultOptions
                });
                
                // Expense Chart
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                expenseChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mortgage', 'Property Tax', 'Insurance', 'Management', 'Maintenance', 'Vacancy'],
                        datasets: [{
                            data: [1200, 250, 100, 160, 100, 100],
                            backgroundColor: ['#3b82f6', '#7c3aed', '#ec4899', '#f59e0b', '#64748b', '#6366f1']
                        }]
                    },
                    options: pieOptions
                });
            }
            
            // Reinitialize charts when theme changes
            function reinitializeCharts() {
                // Destroy existing charts
                if (paymentChart) paymentChart.destroy();
                if (amortizationChart) paymentChart.destroy();
                if (investmentChart) paymentChart.destroy();
                if (expenseChart) paymentChart.destroy();
                if (reportPaymentChart) paymentChart.destroy();
                if (reportAmortizationChart) paymentChart.destroy();
                if (reportInvestmentChart) paymentChart.destroy();
                if (reportExpenseChart) paymentChart.destroy();
                
                // Initialize new charts
                initializeCharts();
                
                // Update charts with current data
                calculateMortgage();
                calculateInvestment();
                calculateCashFlow();
                generateReport();
            }
            
            // Calculate mortgage
            function calculateMortgage() {
                // Get input values
                const propertyPrice = parseFloat(document.getElementById('property-price').value);
                const downPaymentPercent = parseFloat(document.getElementById('down-payment-slider').value);
                const loanTerm = parseInt(document.getElementById('loan-term').value);
                const interestRate = parseFloat(document.getElementById('interest-rate-slider').value);
                const propertyTax = parseFloat(document.getElementById('property-tax').value);
                const homeInsurance = parseFloat(document.getElementById('home-insurance').value);
                const hoa = parseFloat(document.getElementById('hoa').value);
                
                // Calculate loan details
                const downPayment = propertyPrice * (downPaymentPercent / 100);
                const loanAmount = propertyPrice - downPayment;
                const monthlyInterestRate = interestRate / 100 / 12;
                const numberOfPayments = loanTerm * 12;
                
                // Calculate monthly principal and interest payment
                const monthlyPayment = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                    (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
                
                // Calculate total payment with taxes and insurance
                const monthlyPropertyTax = propertyTax / 12;
                const monthlyInsurance = homeInsurance / 12;
                const totalMonthlyPayment = monthlyPayment + monthlyPropertyTax + monthlyInsurance + hoa;
                
                // Calculate total interest over life of loan
                const totalInterest = (monthlyPayment * numberOfPayments) - loanAmount;
                
                // Update DOM elements
                document.getElementById('principal-interest').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
                document.getElementById('total-monthly').textContent = '$' + Math.round(totalMonthlyPayment).toLocaleString();
                document.getElementById('loan-amount').textContent = '$' + Math.round(loanAmount).toLocaleString();
                document.getElementById('down-payment-amount').textContent = '$' + Math.round(downPayment).toLocaleString();
                document.getElementById('total-interest').textContent = '$' + Math.round(totalInterest).toLocaleString();
                document.getElementById('total-cost').textContent = '$' + Math.round(propertyPrice + totalInterest).toLocaleString();
                
                // Update payment breakdown chart
                if (paymentChart) {
                    paymentChart.data.datasets[0].data = [
                        Math.round(monthlyPayment), 
                        Math.round(monthlyPropertyTax), 
                        Math.round(monthlyInsurance), 
                        Math.round(hoa)
                    ];
                    paymentChart.update();
                }
                
                // Update amortization chart
                if (amortizationChart) {
                    // Calculate amortization schedule for key years
                    const years = loanTerm > 15 ? [5, 10, 15, 20, 25, 30].filter(y => y <= loanTerm) : [Math.round(loanTerm/3), Math.round(2*loanTerm/3), loanTerm];
                    const principalPaid = [];
                    const interestPaid = [];
                    
                    years.forEach(year => {
                        const monthsPaid = year * 12;
                        let remainingBalance = loanAmount;
                        let totalInterestPaid = 0;
                        
                        for (let i = 1; i <= monthsPaid; i++) {
                            const interestPayment = remainingBalance * monthlyInterestRate;
                            const principalPayment = monthlyPayment - interestPayment;
                            
                            remainingBalance -= principalPayment;
                            totalInterestPaid += interestPayment;
                        }
                        
                        principalPaid.push(Math.round(loanAmount - remainingBalance));
                        interestPaid.push(Math.round(totalInterestPaid));
                    });
                    
                    // Update chart data
                    amortizationChart.data.labels = years.map(year => `Year ${year}`);
                    amortizationChart.data.datasets[0].data = principalPaid;
                    amortizationChart.data.datasets[1].data = interestPaid;
                    amortizationChart.update();
                }
            }
            
            // Calculate investment returns
            function calculateInvestment() {
                // Get input values
                const purchasePrice = parseFloat(document.getElementById('inv-purchase-price').value);
                const annualRent = parseFloat(document.getElementById('annual-rent').value);
                const expensesPercent = parseFloat(document.getElementById('expenses-slider').value);
                const vacancyRate = parseFloat(document.getElementById('vacancy-slider').value);
                const appreciationRate = parseFloat(document.getElementById('appreciation-slider').value);
                const holdingPeriod = parseInt(document.getElementById('holding-period').value);
                
                // Calculate investment metrics
                const monthlyRent = annualRent / 12;
                const effectiveAnnualRent = annualRent * (1 - vacancyRate / 100);
                const annualExpenses = effectiveAnnualRent * (expensesPercent / 100);
                const annualCashFlow = effectiveAnnualRent - annualExpenses;
                const monthlyCashFlow = annualCashFlow / 12;
                
                // Assume 25% down payment for cash-on-cash ROI calculation
                const downPayment = purchasePrice * 0.25;
                const cashOnCashROI = (annualCashFlow / downPayment) * 100;
                
                // Cap rate calculation (NOI / Purchase Price)
                const netOperatingIncome = effectiveAnnualRent - annualExpenses;
                const capRate = (netOperatingIncome / purchasePrice) * 100;
                
                // Update DOM elements
                document.getElementById('monthly-rent').textContent = '$' + Math.round(monthlyRent).toLocaleString();
                document.getElementById('monthly-expenses').textContent = '$' + Math.round(annualExpenses / 12).toLocaleString();
                document.getElementById('monthly-cashflow').textContent = '$' + Math.round(monthlyCashFlow).toLocaleString();
                document.getElementById('annual-cashflow').textContent = '$' + Math.round(annualCashFlow).toLocaleString();
                document.getElementById('cash-on-cash').textContent = cashOnCashROI.toFixed(1) + '%';
                document.getElementById('cap-rate').textContent = capRate.toFixed(1) + '%';
                document.getElementById('period-label').textContent = holdingPeriod;
                
                // Future value calculations
                const futurePropertyValue = purchasePrice * Math.pow(1 + appreciationRate / 100, holdingPeriod);
                const totalRentalIncome = annualCashFlow * holdingPeriod;
                const totalReturn = (futurePropertyValue - purchasePrice) + totalRentalIncome;
                const annualizedReturn = (Math.pow(1 + totalReturn / downPayment, 1 / holdingPeriod) - 1) * 100;
                
                document.getElementById('future-property-value').textContent = '$' + Math.round(futurePropertyValue).toLocaleString();
                document.getElementById('total-rental-income').textContent = '$' + Math.round(totalRentalIncome).toLocaleString();
                document.getElementById('total-return').textContent = '$' + Math.round(totalReturn).toLocaleString();
                document.getElementById('annualized-return').textContent = annualizedReturn.toFixed(1) + '%';
                
                // Update investment chart
                if (investmentChart) {
                    // Select appropriate year markers based on holding period
                    const yearSpacing = Math.max(1, Math.round(holdingPeriod / 5));
                    const yearLabels = [];
                    const propertyValues = [];
                    const cashFlows = [];
                    
                    for (let year = 0; year <= holdingPeriod; year += yearSpacing) {
                        yearLabels.push(`Year ${year}`);
                        propertyValues.push(Math.round(purchasePrice * Math.pow(1 + appreciationRate / 100, year)));
                        cashFlows.push(Math.round(year === 0 ? 0 : annualCashFlow * year));
                    }
                    
                    // Make sure the final year is included
                    if (yearLabels[yearLabels.length - 1] !== `Year ${holdingPeriod}`) {
                        yearLabels.push(`Year ${holdingPeriod}`);
                        propertyValues.push(Math.round(futurePropertyValue));
                        cashFlows.push(Math.round(totalRentalIncome));
                    }
                    
                    // Update chart data
                    investmentChart.data.labels = yearLabels;
                    investmentChart.data.datasets[0].data = propertyValues;
                    investmentChart.data.datasets[1].data = cashFlows;
                    investmentChart.update();
                }
            }
            
            // Calculate rental cash flow
            function calculateCashFlow() {
                // Get input values
                const rentalIncome = parseFloat(document.getElementById('rental-income').value);
                const mortgagePayment = parseFloat(document.getElementById('mortgage-payment').value);
                const propertyTax = parseFloat(document.getElementById('rental-property-tax').value);
                const insurance = parseFloat(document.getElementById('rental-insurance').value);
                const managementPercent = parseFloat(document.getElementById('management-slider').value);
                const maintenancePercent = parseFloat(document.getElementById('maintenance-slider').value);
                const vacancyPercent = parseFloat(document.getElementById('rental-vacancy-slider').value);
                
                // Calculate expense amounts
                const management = rentalIncome * (managementPercent / 100);
                const maintenance = rentalIncome * (maintenancePercent / 100);
                const vacancy = rentalIncome * (vacancyPercent / 100);
                
                // Calculate total expenses and cash flow
                const totalMonthlyExpenses = mortgagePayment + propertyTax + insurance + management + maintenance + vacancy;
                const monthlyCashFlow = rentalIncome - totalMonthlyExpenses;
                const annualCashFlow = monthlyCashFlow * 12;
                
                // Estimate purchase price and returns
                const estimatedPurchasePrice = mortgagePayment * 5 * 12; // Rough estimate based on monthly payment
                const downPayment = estimatedPurchasePrice * 0.25; // Assume 25% down
                const cocReturn = (annualCashFlow / downPayment) * 100;
                const expenseRatio = (totalMonthlyExpenses / rentalIncome) * 100;
                
                // Update DOM elements
                document.getElementById('rental-monthly-cashflow').textContent = '$' + Math.round(monthlyCashFlow).toLocaleString();
                document.getElementById('rental-annual-cashflow').textContent = '$' + Math.round(annualCashFlow).toLocaleString();
                document.getElementById('rent-display').textContent = '$' + rentalIncome.toLocaleString();
                document.getElementById('total-expenses').textContent = '$' + Math.round(totalMonthlyExpenses).toLocaleString();
                document.getElementById('rental-coc-return').textContent = isFinite(cocReturn) ? cocReturn.toFixed(1) + '%' : 'N/A';
                document.getElementById('expense-ratio').textContent = expenseRatio.toFixed(0) + '%';
                
                // Update expense chart
                if (expenseChart) {
                    expenseChart.data.datasets[0].data = [
                        Math.round(mortgagePayment),
                        Math.round(propertyTax),
                        Math.round(insurance),
                        Math.round(management),
                        Math.round(maintenance),
                        Math.round(vacancy)
                    ];
                    expenseChart.update();
                }
                
                // Update 5-year projection table
                const projectionTable = document.getElementById('projection-table');
                projectionTable.innerHTML = `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <th style="text-align: left; padding: 8px 5px;">Year</th>
                        <th style="text-align: right; padding: 8px 5px;">Income</th>
                        <th style="text-align: right; padding: 8px 5px;">Expenses</th>
                        <th style="text-align: right; padding: 8px 5px;">Cash Flow</th>
                    </tr>
                `;
                
                // Add projection rows
                for (let year = 1; year <= 5; year++) {
                    // Assume 3% annual growth
                    const growthFactor = Math.pow(1.03, year - 1);
                    const yearlyIncome = rentalIncome * 12 * growthFactor;
                    const yearlyExpenses = totalMonthlyExpenses * 12 * growthFactor;
                    const yearlyCashFlow = yearlyIncome - yearlyExpenses;
                    
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--border-color)';
                    row.innerHTML = `
                        <td style="padding: 8px 5px;">Year ${year}</td>
                        <td style="text-align: right; padding: 8px 5px;">$${Math.round(yearlyIncome).toLocaleString()}</td>
                        <td style="text-align: right; padding: 8px 5px;">$${Math.round(yearlyExpenses).toLocaleString()}</td>
                        <td style="text-align: right; padding: 8px 5px; color: ${yearlyCashFlow >= 0 ? '#10b981' : '#ef4444'};">$${Math.round(yearlyCashFlow).toLocaleString()}</td>
                    `;
                    projectionTable.appendChild(row);
                }
            }
            
            // Generate comprehensive report
            function generateReport() {
                // Get values from all calculators
                const propertyPrice = parseFloat(document.getElementById('property-price').value);
                const downPaymentPercent = parseFloat(document.getElementById('down-payment-slider').value);
                const loanTerm = parseInt(document.getElementById('loan-term').value);
                const interestRate = parseFloat(document.getElementById('interest-rate-slider').value);
                const propertyTax = parseFloat(document.getElementById('property-tax').value);
                
                const monthlyRent = parseFloat(document.getElementById('rental-income').value);
                const monthlyCashFlow = parseFloat(document.getElementById('rental-monthly-cashflow').textContent.replace('$', '').replace(',', ''));
                const cocReturn = parseFloat(document.getElementById('rental-coc-return').textContent.replace('%', ''));
                
                const capRate = parseFloat(document.getElementById('cap-rate').textContent.replace('%', ''));
                const futureValue = document.getElementById('future-property-value').textContent;
                const totalReturn = document.getElementById('total-return').textContent;
                const annualizedReturn = document.getElementById('annualized-return').textContent;
                
                // Calculate loan details for the report
                const downPayment = propertyPrice * (downPaymentPercent / 100);
                const loanAmount = propertyPrice - downPayment;
                const monthlyInterestRate = interestRate / 100 / 12;
                const numberOfPayments = loanTerm * 12;
                
                // Calculate monthly payments
                const monthlyPayment = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                    (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
                
                // Calculate total interest
                const totalInterest = (monthlyPayment * numberOfPayments) - loanAmount;
                
                // Update report DOM elements
                document.getElementById('report-purchase-price').textContent = '$' + propertyPrice.toLocaleString();
                document.getElementById('report-down-payment').textContent = '$' + Math.round(downPayment).toLocaleString() + ' (' + downPaymentPercent + '%)';
                document.getElementById('report-loan-amount').textContent = '$' + Math.round(loanAmount).toLocaleString();
                document.getElementById('report-loan-term').textContent = loanTerm + ' years';
                document.getElementById('report-interest-rate').textContent = interestRate + '%';
                document.getElementById('report-monthly-payment').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
                document.getElementById('report-property-tax').textContent = '$' + propertyTax.toLocaleString();
                document.getElementById('report-cash-flow').textContent = '$' + Math.round(monthlyCashFlow).toLocaleString();
                document.getElementById('report-coc-return').textContent = cocReturn.toFixed(1) + '%';
                document.getElementById('report-cap-rate').textContent = capRate.toFixed(1) + '%';
                
                // Highlights
                const monthlyPropertyTax = propertyTax / 12;
                const monthlyInsurance = 100; // Default value
                const totalMonthlyPayment = monthlyPayment + monthlyPropertyTax + monthlyInsurance;
                
                document.getElementById('report-highlight-payment').textContent = '$' + Math.round(totalMonthlyPayment).toLocaleString();
                document.getElementById('report-highlight-interest').textContent = '$' + Math.round(totalInterest).toLocaleString();
                document.getElementById('report-highlight-future-value').textContent = futureValue;
                
                // Investment summary
                document.getElementById('report-total-investment').textContent = '$' + Math.round(downPayment).toLocaleString();
                document.getElementById('report-total-return').textContent = totalReturn;
                document.getElementById('report-annualized-return').textContent = annualizedReturn;
                document.getElementById('report-total-rental-income').textContent = '$' + Math.round(monthlyRent * 12 * 10).toLocaleString();
                
                // Generate projection table
                const appreciationRate = parseFloat(document.getElementById('appreciation-slider').value);
                const reportProjectionTable = document.getElementById('report-projection-table');
                reportProjectionTable.innerHTML = `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <th style="text-align: left; padding: 8px 5px;">Year</th>
                        <th style="text-align: right; padding: 8px 5px;">Property Value</th>
                        <th style="text-align: right; padding: 8px 5px;">Annual Cash Flow</th>
                        <th style="text-align: right; padding: 8px 5px;">Cumulative Return</th>
                    </tr>
                `;
                
                let cumulativeReturn = 0;
                for (let year = 1; year <= 5; year++) {
                    const propertyGrowthFactor = Math.pow(1 + appreciationRate / 100, year);
                    const cashFlowGrowthFactor = Math.pow(1.03, year - 1);
                    
                    const propertyValueAtYear = propertyPrice * propertyGrowthFactor;
                    const annualCashFlowAtYear = monthlyCashFlow * 12 * cashFlowGrowthFactor;
                    
                    cumulativeReturn += annualCashFlowAtYear;
                    
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var (--border-color)';
                    row.innerHTML = `
                        <td style="padding: 8px 5px;">Year ${year}</td>
                        <td style="text-align: right; padding: 8px 5px;">$${Math.round(propertyValueAtYear).toLocaleString()}</td>
                        <td style="text-align: right; padding: 8px 5px;">$${Math.round(annualCashFlowAtYear).toLocaleString()}</td>
                        <td style="text-align: right; padding: 8px 5px;">$${Math.round(cumulativeReturn).toLocaleString()}</td>
                    `;
                    reportProjectionTable.appendChild(row);
                }
                
                // Create report charts
                createReportCharts();
            }
            
            // Create charts for the report
            function createReportCharts() {
                // Get theme-aware colors
                const isDark = document.body.classList.contains('dark');
                const textColor = isDark ? '#f9fafb' : '#1f2937';
                const gridColor = isDark ? '#374151' : '#e5e7eb';
                
                // Default options
                const defaultOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    }
                };
                
                const pieOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor
                            }
                        }
                    }
                };
                
                // Clone data from main charts to report charts
                
                // Payment chart
                if (reportPaymentChart) reportPaymentChart.destroy();
                const reportPaymentCtx = document.getElementById('report-payment-chart').getContext('2d');
                reportPaymentChart = new Chart(reportPaymentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: paymentChart.data.labels,
                        datasets: [{
                            data: [...paymentChart.data.datasets[0].data],
                            backgroundColor: ['#3b82f6', '#7c3aed', '#ec4899', '#10b981']
                        }]
                    },
                    options: pieOptions
                });
                
                // Amortization chart
                if (reportAmortizationChart) reportAmortizationChart.destroy();
                const reportAmortizationCtx = document.getElementById('report-amortization-chart').getContext('2d');
                reportAmortizationChart = new Chart(reportAmortizationCtx, {
                    type: 'line',
                    data: {
                        labels: [...amortizationChart.data.labels],
                        datasets: [
                            {
                                label: 'Principal',
                                data: [...amortizationChart.data.datasets[0].data],
                                borderColor: '#3b82f6',
                                backgroundColor: '#3b82f6',
                                tension: 0.1
                            },
                            {
                                label: 'Interest',
                                data: [...amortizationChart.data.datasets[1].data],
                                borderColor: '#7c3aed',
                                backgroundColor: '#7c3aed',
                                tension: 0.1
                            }
                        ]
                    },
                    options: defaultOptions
                });
                
                // Investment chart
                if (reportInvestmentChart) reportInvestmentChart.destroy();
                const reportInvestmentCtx = document.getElementById('report-investment-chart').getContext('2d');
                reportInvestmentChart = new Chart(reportInvestmentCtx, {
                    type: 'bar',
                    data: {
                        labels: [...investmentChart.data.labels],
                        datasets: [
                            {
                                label: 'Property Value',
                                data: [...investmentChart.data.datasets[0].data],
                                backgroundColor: '#3b82f6'
                            },
                            {
                                label: 'Cumulative Cash Flow',
                                data: [...investmentChart.data.datasets[1].data],
                                backgroundColor: '#10b981'
                            }
                        ]
                    },
                    options: defaultOptions
                });
                
                // Expense chart
                if (reportExpenseChart) reportExpenseChart.destroy();
                const reportExpenseCtx = document.getElementById('report-expense-chart').getContext('2d');
                reportExpenseChart = new Chart(reportExpenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: expenseChart.data.labels,
                        datasets: [{
                            data: [...expenseChart.data.datasets[0].data],
                            backgroundColor: ['#3b82f6', '#7c3aed', '#ec4899', '#f59e0b', '#64748b', '#6366f1']
                        }]
                    },
                    options: pieOptions
                });
            }
            
            // Set up export option listeners
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('export-option') || e.target.closest('.export-option')) {
                    const target = e.target.classList.contains('export-option') ? e.target : e.target.closest('.export-option');
                    const type = target.getAttribute('data-type');
                    const content = target.getAttribute('data-content');
                    const source = target.getAttribute('data-source');
                    
                    if (type === 'pdf') {
                        exportToPDF(content, source, target);
                    } else if (type === 'jpg') {
                        exportToJPG(content, source, target);
                    }
                    
                    e.preventDefault();
                }
            });
            
            // Main export buttons in the nav
            document.getElementById('export-pdf').addEventListener('click', function() {
                exportToPDF('full', 'report', this);
            });
            
            document.getElementById('export-jpg').addEventListener('click', function() {
                exportToJPG('full', 'report', this);
            });
            
            // PDF Export Function with enhanced options
            function exportToPDF(contentType = 'full', source = 'report', buttonElement) {
                // Check if we're in a restricted environment
                if (isRestricted) {
                    alert('Export is not available in this preview environment.');
                    return;
                }
                
                // Show loading state
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                
                // Determine what to export based on content type and source
                let elementToExport;
                let fileName;
                
                // Store the current active tab
                const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                
                if (contentType === 'full' || source === 'report') {
                    // Switch to report tab for full report
                    document.querySelector('[data-tab="report"]').click();
                    elementToExport = document.getElementById('report-section');
                    fileName = 'UltimateRECalc_Full_Report.pdf';
                } else {
                    // For current view or summary, use the specific calculator's results card
                    if (source === 'mortgage') {
                        document.querySelector('[data-tab="mortgage"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#mortgage-calculator .details-table').closest('.card')
                            : document.querySelector('#mortgage-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Mortgage_Analysis.pdf';
                    } else if (source === 'investment') {
                        document.querySelector('[data-tab="investment"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#investment-calculator .details-table').closest('.card')
                            : document.querySelector('#investment-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Investment_Analysis.pdf';
                    } else if (source === 'cashflow') {
                        document.querySelector('[data-tab="cashflow"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#cashflow-calculator .details-table').closest('.card')
                            : document.querySelector('#cashflow-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Cashflow_Analysis.pdf';
                    }
                }
                
                // Short delay to ensure the correct content is visible
                setTimeout(() => {
                    try {
                        // Use html2canvas to capture the selected element
                        html2canvas(elementToExport, {
                            scale: window.innerWidth <= 768 ? 1 : 2, // Reduce scale on mobile
                            logging: false,
                            useCORS: true,
                            allowTaint: true,
                            width: elementToExport.offsetWidth, // Explicitly set width
                            height: elementToExport.offsetHeight // Explicitly set height
                        }).then(canvas => {
                            try {
                                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                                // Add PDF formatting options dialog
                                const formatOptions = {
                                    orientation: 'portrait',
                                    pageSize: 'a4',
                                    margins: {
                                        top: 30,
                                        bottom: 20,
                                        left: 20,
                                        right: 20
                                    },
                                    fontSize: {
                                        title: 16,
                                        subtitle: 12,
                                        body: 10
                                    },
                                    colors: document.body.classList.contains('dark') 
                                        ? {
                                            title: '#ffffff',
                                            subtitle: '#94a3b8',
                                            body: '#e2e8f0',
                                            background: '#1f2937'
                                          }
                                        : {
                                            title: '#1f2937',
                                            subtitle: '#64748b',
                                            body: '#334155',
                                            background: '#ffffff'
                                          }
                                };

                                // Configure PDF settings
                                const pdfConfig = {
                                    orientation: formatOptions.orientation,
                                    unit: 'mm',
                                    format: formatOptions.pageSize,
                                    putOnlyUsedFonts: true,
                                    floatPrecision: 16
                                };

                                const pdf = new jspdf.jsPDF(pdfConfig);

                                // Set PDF background color
                                pdf.setFillColor(formatOptions.colors.background);
                                pdf.rect(0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(), 'F');

                                // Add title with custom formatting
                                pdf.setFontSize(formatOptions.fontSize.title);
                                pdf.setTextColor(formatOptions.colors.title);
                                const title = companyName || 'UltimateRECalc Analysis Report';
                                pdf.text(title, pdfWidth / 2, formatOptions.margins.top, { align: 'center' });
                                
                                // Add subtitle (date)
                                pdf.setFontSize(formatOptions.fontSize.subtitle);
                                pdf.setTextColor(formatOptions.colors.subtitle);
                                const dateStr = `Generated on ${today.toLocaleDateString()}`;
                                pdf.text(dateStr, pdfWidth / 2, formatOptions.margins.top + 7, { align: 'center' });
                                
                                // Add company logo if available
                                try {
                                    const savedLogo = localStorage.getItem('companyLogo');
                                    if (savedLogo) {
                                        const logoSize = {
                                            width: 40,
                                            height: 20
                                        };
                                        pdf.addImage(
                                            savedLogo, 
                                            'JPEG', 
                                            formatOptions.margins.left, 
                                            formatOptions.margins.top - 15, 
                                            logoSize.width, 
                                            logoSize.height, 
                                            undefined, 
                                            'FAST'
                                        );
                                    }
                                } catch (e) {
                                    console.warn('Unable to add logo to PDF:', e);
                                }

                                // Calculate content area
                                const contentStartY = formatOptions.margins.top + 15;
                                const contentWidth = pdfWidth - (formatOptions.margins.left + formatOptions.margins.right);
                                const contentHeight = pdfHeight - (formatOptions.margins.top + formatOptions.margins.bottom);
                                
                                // Add content image
                                const contentRatio = Math.min(
                                    contentWidth / imgWidth,
                                    (contentHeight - 15) / imgHeight
                                );
                                
                                const finalImgWidth = imgWidth * contentRatio;
                                const finalImgHeight = imgHeight * contentRatio;
                                const imgX = (pdfWidth - finalImgWidth) / 2;

                                // Check if content fits on one page
                                if (finalImgHeight <= contentHeight) {
                                    pdf.addImage(
                                        imgData, 
                                        'JPEG', 
                                        imgX, 
                                        contentStartY, 
                                        finalImgWidth, 
                                        finalImgHeight
                                    );
                                } else {
                                    // Handle multi-page content
                                    let heightLeft = finalImgHeight;
                                    let position = 0;
                                    
                                    while (heightLeft > 0) {
                                        pdf.addImage(
                                            imgData, 
                                            'JPEG', 
                                            imgX, 
                                            position === 0 ? contentStartY : formatOptions.margins.top, 
                                            finalImgWidth, 
                                            finalImgHeight
                                        );
                                        
                                        heightLeft -= (contentHeight - (position === 0 ? contentStartY : formatOptions.margins.top));
                                        position -= contentHeight;
                                        
                                        if (heightLeft > 0) {
                                            pdf.addPage();
                                            // Add background color to new page
                                            pdf.setFillColor(formatOptions.colors.background);
                                            pdf.rect(0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(), 'F');
                                        }
                                    }
                                }

                                // Add footer to all pages
                                const pageCount = pdf.internal.getNumberOfPages();
                                for (let i = 1; i <= pageCount; i++) {
                                    pdf.setPage(i);
                                    pdf.setFontSize(formatOptions.fontSize.body);
                                    pdf.setTextColor(formatOptions.colors.subtitle);
                                    
                                    // Add page numbers
                                    const footer = `Page ${i} of ${pageCount} | Powered by UltimateRECalc`;
                                    pdf.text(
                                        footer, 
                                        pdfWidth / 2, 
                                        pdfHeight - (formatOptions.margins.bottom / 2), 
                                        { align: 'center' }
                                    );
                                }
                                
                                // Save PDF
                                pdf.save(fileName);
                                
                                // Switch back to the original tab
                                document.querySelector(`[data-tab="${activeTab}"]`).click();
                            } catch (err) {
                                console.error('Error in PDF generation:', err);
                                alert('Error generating PDF. Please try again.');
                            }
                            
                            // Restore button state
                            buttonElement.innerHTML = originalText;
                        }).catch(err => {
                            console.error('Error capturing canvas:', err);
                            alert('Error generating PDF. Please try again.');
                            buttonElement.innerHTML = originalText;
                        });
                    } catch (err) {
                        console.error('Error in export process:', err);
                        alert('Error generating PDF. Please try again.');
                        buttonElement.innerHTML = originalText;
                    }
                }, 100);
            }
            
            // JPG Export Function with enhanced options
            function exportToJPG(contentType = 'full', source = 'report', buttonElement) {
                // Check if we're in a restricted environment
                if (isRestricted) {
                    alert('Export is not available in this preview environment.');
                    return;
                }
                
                // Show loading state
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                
                // Determine what to export based on content type and source
                let elementToExport;
                let fileName;
                
                // Store the current active tab
                const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                
                if (contentType === 'full' || source === 'report') {
                    // Switch to report tab for full report
                    document.querySelector('[data-tab="report"]').click();
                    elementToExport = document.getElementById('report-section');
                    fileName = 'UltimateRECalc_Full_Report.jpg';
                } else {
                    // For current view or summary, use the specific calculator's results card
                    if (source === 'mortgage') {
                        document.querySelector('[data-tab="mortgage"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#mortgage-calculator .details-table').closest('.card')
                            : document.querySelector('#mortgage-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Mortgage_Analysis.jpg';
                    } else if (source === 'investment') {
                        document.querySelector('[data-tab="investment"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#investment-calculator .details-table').closest('.card')
                            : document.querySelector('#investment-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Investment_Analysis.jpg';
                    } else if (source === 'cashflow') {
                        document.querySelector('[data-tab="cashflow"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#cashflow-calculator .details-table').closest('.card')
                            : document.querySelector('#cashflow-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Cashflow_Analysis.jpg';
                    }
                }
                
                // Short delay to ensure the correct content is visible
                setTimeout(() => {
                    try {
                        // Use html2canvas to capture the selected element
                        html2canvas(elementToExport, {
                            scale: 2,
                            logging: false,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: document.body.classList.contains('dark') ? '#111827' : '#f9fafb'
                        }).then(canvas => {
                            try {
                                // Create temporary canvas with title and branding
                                const finalCanvas = document.createElement('canvas');
                                const ctx = finalCanvas.getContext('2d');
                                const padding = 40;
                                
                                // Set canvas size with padding
                                finalCanvas.width = canvas.width + (padding * 2);
                                finalCanvas.height = canvas.height + (padding * 2) + 60; // Extra space for title and footer
                                
                                // Fill background
                                ctx.fillStyle = document.body.classList.contains('dark') ? '#111827' : '#f9fafb';
                                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                                
                                // Add title
                                ctx.font = 'bold 28px Poppins, sans-serif';
                                ctx.fillStyle = document.body.classList.contains('dark') ? '#f9fafb' : '#1f2937';
                                ctx.textAlign = 'center';
                                ctx.fillText('UltimateRECalc Analysis', finalCanvas.width / 2, 40);
                                
                                // Add date
                                ctx.font = '14px Poppins, sans-serif';
                                ctx.fillStyle = document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280';
                                const today = new Date();
                                ctx.fillText(`Generated on ${today.toLocaleDateString()}`, finalCanvas.width / 2, 65);
                                
                                // Add exported image
                                ctx.drawImage(canvas, padding, padding + 50);
                                
                                // Add footer
                                ctx.font = '12px Poppins, sans-serif';
                                ctx.fillStyle = document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280';
                                ctx.fillText('Powered by UltimateRECalc', finalCanvas.width / 2, finalCanvas.height - 15);
                                
                                // Create temporary link element
                                const link = document.createElement('a');
                                link.download = fileName;
                                link.href = finalCanvas.toDataURL('image/jpeg', 0.9);
                                
                                // Click the link to trigger download
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                // Switch back to the original tab
                                document.querySelector(`[data-tab="${activeTab}"]`).click();
                            } catch (err) {
                                console.error('Error generating JPG file:', err);
                                alert('Error generating JPG. Please try again.');
                            }
                            
                            // Restore button state
                            buttonElement.innerHTML = originalText;
                        }).catch(err => {
                            console.error('Error capturing canvas:', err);
                            alert('Error generating JPG. Please try again.');
                            buttonElement.innerHTML = originalText;
                        });
                    } catch (err) {
                        console.error('Error in export process:', err);
                        alert('Error generating JPG. Please try again.');
                        buttonElement.innerHTML = originalText;
                    }
                }, 100);
            }

            // Closing costs calculator logic
            const closingCostItems = [
                { id: 'mortgage-fees', label: 'Total Mortgage Fees', defaultSplit: 'buyer' },
                { id: 'settlement-fee', label: 'Settlement Fee', defaultSplit: 'buyer' },
                { id: 'title-search', label: 'Title Search', defaultSplit: 'seller' },
                { id: 'association-fee', label: 'Association Fee', defaultSplit: 'seller' },
                { id: 'survey', label: 'Survey', defaultSplit: 'buyer' },
                { id: 'termite', label: 'Termite', defaultSplit: 'seller' },
                { id: 'lien-search', label: 'New Lien Search Fee', defaultSplit: 'seller' },
                { id: 'commission', label: 'Commission', defaultSplit: 'seller' },
                { id: 'owners-policy', label: 'Owner\'s Policy', defaultSplit: 'seller' },
                { id: 'lenders-policy', label: 'Lender\'s Policy', defaultSplit: 'buyer' },
                { id: 'environmental', label: 'Environmental Endorsement', defaultSplit: 'buyer' },
                { id: 'alta-9', label: 'ALTA 9-06', defaultSplit: 'buyer' },
                { id: 'alta-5', label: 'ALTA 5.1', defaultSplit: 'buyer' },
                { id: 'alta-4', label: 'ALTA 4.1', defaultSplit: 'buyer' },
                { id: 'recording', label: 'Recording Fees', defaultSplit: 'buyer' },
                { id: 'doc-stamp-mortgage', label: 'Doc Stamp on Mortgage', defaultSplit: 'buyer' },
                { id: 'intangible-tax', label: 'Intangible Tax on Mortgage', defaultSplit: 'buyer' },
                { id: 'doc-stamp-deed', label: 'Doc Stamp on Deed', defaultSplit: 'seller' }
            ];

            function initializeClosingCosts() {
                const tableContainer = document.querySelector('.closing-costs-table');
                tableContainer.innerHTML = '';

                closingCostItems.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'closing-cost-item';
                    row.innerHTML = `
                        <div class="label">${item.label}:</div>
                        <div class="amount" id="${item.id}-amount">$0</div>
                        <div class="split">
                            <div class="split-option ${item.defaultSplit === 'buyer' ? 'active' : ''}" data-split="buyer">Buyer</div>
                            <div class="split-option ${item.defaultSplit === 'seller' ? 'active' : ''}" data-split="seller">Seller</div>
                        </div>
                    `;
                    tableContainer.appendChild(row);
                });
            }

            // Initialize closing costs table
            initializeClosingCosts();

            // Calculate closing costs
            document.getElementById('calculate-closing').addEventListener('click', function() {
                const salesPrice = parseFloat(document.getElementById('closing-price').value) || 0;
                const mortgageAmount = parseFloat(document.getElementById('closing-mortgage').value) || 0;
                const commissionRate = parseFloat(document.getElementById('commission-rate').value) || 6;
                const deedPages = parseInt(document.getElementById('deed-pages').value) || 2;
                const mortgagePages = parseInt(document.getElementById('mortgage-pages').value) || 20;

                // Calculate individual costs
                const costs = {
                    'mortgage-fees': mortgageAmount * 0.01,
                    'settlement-fee': 595,
                    'title-search': 150,
                    'association-fee': 250,
                    'survey': 375,
                    'termite': 100,
                    'lien-search': 75,
                    'commission': salesPrice * (commissionRate / 100),
                    'owners-policy': salesPrice * 0.00575,
                    'lenders-policy': mortgageAmount * 0.00575,
                    'environmental': 100,
                    'alta-9': 50,
                    'alta-5': 25,
                    'alta-4': 25,
                    'recording': (deedPages + mortgagePages) * 10,
                    'doc-stamp-mortgage': mortgageAmount * 0.0035,
                    'intangible-tax': mortgageAmount * 0.002,
                    'doc-stamp-deed': salesPrice * 0.007
                };

                // Update amounts and calculate totals
                let buyerTotal = 0;
                let sellerTotal = 0;

                closingCostItems.forEach(item => {
                    const amount = costs[item.id];
                    document.getElementById(`${item.id}-amount`).textContent = '$' + amount.toFixed(2);
                    
                    const splitOption = document.querySelector(`#${item.id}-amount`).nextElementSibling.querySelector('.split-option.active');
                    if (splitOption.getAttribute('data-split') === 'buyer') {
                        buyerTotal += amount;
                    } else {
                        sellerTotal += amount;
                    }
                });

                // Update totals
                document.getElementById('buyer-total').textContent = '$' + buyerTotal.toFixed(2);
                document.getElementById('seller-total').textContent = '$' + sellerTotal.toFixed(2);
            });

            // Clear form
            document.getElementById('clear-closing').addEventListener('click', function() {
                document.getElementById('closing-price').value = '';
                document.getElementById('closing-mortgage').value = '';
                document.getElementById('commission-rate').value = '6';
                document.getElementById('deed-pages').value = '2';
                document.getElementById('mortgage-pages').value = '20';
                document.getElementById('property-type').selectedIndex = 0;
                
                // Reset all amounts
                closingCostItems.forEach(item => {
                    document.getElementById(`${item.id}-amount`).textContent = '$0';
                });
                
                document.getElementById('buyer-total').textContent = '$0';
                document.getElementById('seller-total').textContent = '$0';
            });

            // Handle split option clicks
            document.querySelector('.closing-costs-table').addEventListener('click', function(e) {
                if (e.target.classList.contains('split-option')) {
                    const row = e.target.closest('.closing-cost-item');
                    row.querySelectorAll('.split-option').forEach(opt => opt.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Recalculate totals
                    document.getElementById('calculate-closing').click();
                }
            });

            // Initialize buyer cost sheet calculator
            document.getElementById('calculate-buyer').addEventListener('click', calculateBuyerCosts);
            document.getElementById('clear-buyer').addEventListener('click', clearBuyerForm);

            function calculateBuyerCosts() {
                const salesPrice = parseFloat(document.getElementById('buyer-sales-price').value) || 0;
                const downPayment = parseFloat(document.getElementById('buyer-down-payment').value) || 0;
                const mortgage = parseFloat(document.getElementById('buyer-mortgage').value) || 0;
                const mortgageRate = parseFloat(document.getElementById('buyer-mortgage-rate').value) || 0;
                const points = parseFloat(document.getElementById('buyer-points').value) || 0;
                const daysInterest = parseFloat(document.getElementById('buyer-days-interest').value) || 0;

                // Calculate points cost
                const pointsCost = (points / 100) * mortgage;
                document.getElementById('buyer-points-cost').value = pointsCost.toFixed(2);

                // Calculate interest
                const dailyRate = mortgageRate / 100 / 365;
                const interestDue = mortgage * dailyRate * daysInterest;
                document.getElementById('buyer-interest').value = interestDue.toFixed(2);

                // Get all other costs
                const professionalFees = [
                    'buyer-broker', 'buyer-appraiser', 'buyer-attorney',
                    'buyer-surveyor', 'buyer-escrow-fee'
                ].reduce((sum, id) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);

                const insuranceFees = [
                    'buyer-hazard', 'buyer-flood', 'buyer-title', 'buyer-guaranty'
                ].reduce((sum, id) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);

                const mortgageFees = [
                    'buyer-discount', 'buyer-doc-fees', 'buyer-origination'
                ].reduce((sum, id) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);

                // Calculate total
                const total = downPayment + pointsCost + interestDue + professionalFees + 
                            insuranceFees + mortgageFees;

                document.getElementById('buyer-total-due').textContent = '$' + total.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            function clearBuyerForm() {
                const inputs = document.querySelectorAll('#buyer-calculator input:not([disabled])');
                inputs.forEach(input => {
                    input.value = input.getAttribute('value') || '0';
                });
                document.getElementById('buyer-total-due').textContent = '$0';
                document.getElementById('buyer-points-cost').value = '0';
                document.getElementById('buyer-interest').value = '0';
            }

            // Add mobile menu handler
            const mobileMenuButton = document.querySelector('.mobile-menu-button');
            const mobileMenu = document.querySelector('.mobile-menu');
            const mobileMenuItems = document.querySelectorAll('.mobile-menu .tab');

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('show');
            });

            mobileMenuItems.forEach(item => {
                item.addEventListener('click', () => {
                    mobileMenu.classList.remove('show');
                });
            });

            // Modify PDF export function for mobile
            function exportToPDF(contentType = 'full', source = 'report', buttonElement) {
                // Check if we're in a restricted environment
                if (isRestricted) {
                    alert('Export is not available in this preview environment.');
                    return;
                }
                
                // Show loading state
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                
                // Determine what to export based on content type and source
                let elementToExport;
                let fileName;
                
                // Store the current active tab
                const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
                
                if (contentType === 'full' || source === 'report') {
                    // Switch to report tab for full report
                    document.querySelector('[data-tab="report"]').click();
                    elementToExport = document.getElementById('report-section');
                    fileName = 'UltimateRECalc_Full_Report.pdf';
                } else {
                    // For current view or summary, use the specific calculator's results card
                    if (source === 'mortgage') {
                        document.querySelector('[data-tab="mortgage"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#mortgage-calculator .details-table').closest('.card')
                            : document.querySelector('#mortgage-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Mortgage_Analysis.pdf';
                    } else if (source === 'investment') {
                        document.querySelector('[data-tab="investment"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#investment-calculator .details-table').closest('.card')
                            : document.querySelector('#investment-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Investment_Analysis.pdf';
                    } else if (source === 'cashflow') {
                        document.querySelector('[data-tab="cashflow"]').click();
                        elementToExport = contentType === 'summary' 
                            ? document.querySelector('#cashflow-calculator .details-table').closest('.card')
                            : document.querySelector('#cashflow-calculator .card:nth-child(2)');
                        fileName = 'UltimateRECalc_Cashflow_Analysis.pdf';
                    }
                }
                
                // Short delay to ensure the correct content is visible
                setTimeout(() => {
                    try {
                        // Use html2canvas to capture the selected element
                        html2canvas(elementToExport, {
                            scale: window.innerWidth <= 768 ? 1 : 2, // Reduce scale on mobile
                            logging: false,
                            useCORS: true,
                            allowTaint: true,
                            width: elementToExport.offsetWidth, // Explicitly set width
                            height: elementToExport.offsetHeight // Explicitly set height
                        }).then(canvas => {
                            try {
                                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                                // Add PDF formatting options dialog
                                const formatOptions = {
                                    orientation: 'portrait',
                                    pageSize: 'a4',
                                    margins: {
                                        top: 30,
                                        bottom: 20,
                                        left: 20,
                                        right: 20
                                    },
                                    fontSize: {
                                        title: 16,
                                        subtitle: 12,
                                        body: 10
                                    },
                                    colors: document.body.classList.contains('dark') 
                                        ? {
                                            title: '#ffffff',
                                            subtitle: '#94a3b8',
                                            body: '#e2e8f0',
                                            background: '#1f2937'
                                          }
                                        : {
                                            title: '#1f2937',
                                            subtitle: '#64748b',
                                            body: '#334155',
                                            background: '#ffffff'
                                          }
                                };

                                // Configure PDF settings
                                const pdfConfig = {
                                    orientation: formatOptions.orientation,
                                    unit: 'mm',
                                    format: formatOptions.pageSize,
                                    putOnlyUsedFonts: true,
                                    floatPrecision: 16
                                };

                                const pdf = new jspdf.jsPDF(pdfConfig);

                                // Set PDF background color
                                pdf.setFillColor(formatOptions.colors.background);
                                pdf.rect(0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(), 'F');

                                // Add title with custom formatting
                                pdf.setFontSize(formatOptions.fontSize.title);
                                pdf.setTextColor(formatOptions.colors.title);
                                const title = companyName || 'UltimateRECalc Analysis Report';
                                pdf.text(title, pdfWidth / 2, formatOptions.margins.top, { align: 'center' });
                                
                                // Add subtitle (date)
                                pdf.setFontSize(formatOptions.fontSize.subtitle);
                                pdf.setTextColor(formatOptions.colors.subtitle);
                                const dateStr = `Generated on ${today.toLocaleDateString()}`;
                                pdf.text(dateStr, pdfWidth / 2, formatOptions.margins.top + 7, { align: 'center' });
                                
                                // Add company logo if available
                                try {
                                    const savedLogo = localStorage.getItem('companyLogo');
                                    if (savedLogo) {
                                        const logoSize = {
                                            width: 40,
                                            height: 20
                                        };
                                        pdf.addImage(
                                            savedLogo, 
                                            'JPEG', 
                                            formatOptions.margins.left, 
                                            formatOptions.margins.top - 15, 
                                            logoSize.width, 
                                            logoSize.height, 
                                            undefined, 
                                            'FAST'
                                        );
                                    }
                                } catch (e) {
                                    console.warn('Unable to add logo to PDF:', e);
                                }

                                // Calculate content area
                                const contentStartY = formatOptions.margins.top + 15;
                                const contentWidth = pdfWidth - (formatOptions.margins.left + formatOptions.margins.right);
                                const contentHeight = pdfHeight - (formatOptions.margins.top + formatOptions.margins.bottom);
                                
                                // Add content image
                                const contentRatio = Math.min(
                                    contentWidth / imgWidth,
                                    (contentHeight - 15) / imgHeight
                                );
                                
                                const finalImgWidth = imgWidth * contentRatio;
                                const finalImgHeight = imgHeight * contentRatio;
                                const imgX = (pdfWidth - finalImgWidth) / 2;

                                // Check if content fits on one page
                                if (finalImgHeight <= contentHeight) {
                                    pdf.addImage(
                                        imgData, 
                                        'JPEG', 
                                        imgX, 
                                        contentStartY, 
                                        finalImgWidth, 
                                        finalImgHeight
                                    );
                                } else {
                                    // Handle multi-page content
                                    let heightLeft = finalImgHeight;
                                    let position = 0;
                                    
                                    while (heightLeft > 0) {
                                        pdf.addImage(
                                            imgData, 
                                            'JPEG', 
                                            imgX, 
                                            position === 0 ? contentStartY : formatOptions.margins.top, 
                                            finalImgWidth, 
                                            finalImgHeight
                                        );
                                        
                                        heightLeft -= (contentHeight - (position === 0 ? contentStartY : formatOptions.margins.top));
                                        position -= contentHeight;
                                        
                                        if (heightLeft > 0) {
                                            pdf.addPage();
                                            // Add background color to new page
                                            pdf.setFillColor(formatOptions.colors.background);
                                            pdf.rect(0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(), 'F');
                                        }
                                    }
                                }

                                // Add footer to all pages
                                const pageCount = pdf.internal.getNumberOfPages();
                                for (let i = 1; i <= pageCount; i++) {
                                    pdf.setPage(i);
                                    pdf.setFontSize(formatOptions.fontSize.body);
                                    pdf.setTextColor(formatOptions.colors.subtitle);
                                    
                                    // Add page numbers
                                    const footer = `Page ${i} of ${pageCount} | Powered by UltimateRECalc`;
                                    pdf.text(
                                        footer, 
                                        pdfWidth / 2, 
                                        pdfHeight - (formatOptions.margins.bottom / 2), 
                                        { align: 'center' }
                                    );
                                }
                                
                                // Save PDF
                                pdf.save(fileName);
                                
                                // Switch back to the original tab
                                document.querySelector(`[data-tab="${activeTab}"]`).click();
                            } catch (err) {
                                console.error('Error in PDF generation:', err);
                                alert('Error generating PDF. Please try again.');
                            }
                            
                            // Restore button state
                            buttonElement.innerHTML = originalText;
                        }).catch(err => {
                            console.error('Error capturing canvas:', err);
                            alert('Error generating PDF. Please try again.');
                            buttonElement.innerHTML = originalText;
                        });
                    } catch (err) {
                        console.error('Error in export process:', err);
                        alert('Error generating PDF. Please try again.');
                        buttonElement.innerHTML = originalText;
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>