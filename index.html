<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
            <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="HouseMath.app">
        <meta name="theme-color" content="#1e40af">
        <meta name="description" content="Professional real estate calculator suite with mortgage, investment, cash flow, and closing cost calculators. Built for real estate professionals.">
        <meta name="keywords" content="real estate calculator, mortgage calculator, investment property, cash flow, closing costs, commission calculator">
        <meta name="author" content="HouseMath.app">
        <meta name="robots" content="index, follow">
        <meta http-equiv="X-Content-Type-Options" content="nosniff">
        <meta http-equiv="X-Frame-Options" content="DENY">
        <meta http-equiv="X-XSS-Protection" content="1; mode=block">
        <meta name="referrer" content="strict-origin-when-cross-origin">
        <title>HouseMath.app - Professional Real Estate Calculator Suite</title>
        
            <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="logo.fw.png">
    <link rel="shortcut icon" href="logo.fw.png">
    
    <!-- Apple Touch Icons for iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="144x144" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="114x114" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="76x76" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="72x72" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="60x60" href="logo.fw.png">
    <link rel="apple-touch-icon" sizes="57x57" href="logo.fw.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="logo.fw.png">
    <meta name="msapplication-TileColor" content="#1e40af">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Chrome/Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="HouseMath">
    
    <!-- Safari/iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HouseMath">
    
    <!-- Enhanced PWA Manifest -->
    <link rel="manifest" href="manifest.json">
        
        <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js" as="script">
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- HTML2Canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "HouseMath.app",
        "description": "Professional real estate calculator suite with mortgage, investment, cash flow, and closing cost calculators",
        "url": "https://housemath.app",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "HouseMath.app"
        }
    }
    </script>
    
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #3b82f6;
            --accent-color: #60a5fa;
            --text-color: #1e293b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }
        
        .dark {
            --primary-color: #3b82f6;
            --secondary-color: #60a5fa;
            --accent-color: #93c5fd;
            --text-color: #f1f5f9;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --border-color: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        nav {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .mobile-menu-button {
            display: none;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-height: 48px;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }
        
        .mobile-menu-button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(30, 64, 175, 0.4);
        }
        
        .mobile-menu-button i {
            font-size: 18px;
        }
        
        /* Mobile Menu Overlay */
        .mobile-menu-overlay {
        display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .mobile-menu-overlay.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .mobile-menu-content {
            background: var(--card-bg);
            border-radius: 12px;
            max-width: 400px;
            width: 100%;
            max-height: calc(100vh - 40px);
            margin-top: 10vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideInMobile 0.3s ease;
        }
        
        @media (max-height: 600px) {
            .mobile-menu-content {
                margin-top: 20px;
                max-height: calc(100vh - 40px);
            }
        }
        
        @keyframes slideInMobile {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .mobile-menu-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .mobile-menu-close {
            background: #ef4444;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .mobile-menu-close:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .mobile-menu-items {
            padding: 20px 0;
        }
        
        .mobile-tab {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            min-height: 56px;
        }
        
        .mobile-tab:hover {
            background: rgba(30, 64, 175, 0.1);
            border-left-color: var(--primary-color);
        }
        
        .mobile-tab.active {
            background: rgba(30, 64, 175, 0.15);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .mobile-tab i {
            font-size: 20px;
            width: 24px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .mobile-tab span {
            font-size: 16px;
            font-weight: 500;
        }
        
        .mobile-menu-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        @media (max-width: 768px) {
            .mobile-menu-button {
                display: flex;
            }

            .tabs {
                display: none;
            }

            nav {
                padding: 15px;
            }

            .actions {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .actions button {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-width: auto;
            }
            
            .action-text {
                display: none;
            }
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .logo i {
            align-items: center;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        

        
        /* Dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--card-bg);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            z-index: 10;
            border: 1px solid var(--border-color);
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .dropdown-content a {
            color: var(--text-color);
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .dropdown-content a:hover {
            background-color: var(--bg-color);
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 16px; /* Prevents zoom on iOS */
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px; /* Apple's minimum touch target */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 16px rgba(30, 64, 175, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(30, 64, 175, 0.3);
        }
        

        
        .btn-red {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-red:hover {
            background-color: #dc2626;
        }
        
        .btn-green {
            background-color: #10b981;
            color: white;
        }
        
        .btn-green:hover {
            background-color: #059669;
        }




        
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-top: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        
        .tabs::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
        
        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-height: 44px; /* Apple's minimum touch target */
            display: flex;
            align-items: center;
            font-weight: 500;
            background: transparent;
            border-top: none;
            border-left: none;
            border-right: none;
            border-radius: 0;
            box-shadow: none;
            position: relative;
        }
        
        .tab:hover {
            background-color: rgba(30, 64, 175, 0.1);
            color: var(--primary-color);
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            background-color: rgba(30, 64, 175, 0.1);
        }
        
        .tab:active {
            transform: none; /* Override button active transform */
        }
        
        .calculator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 50px;
        }
        
        /* Dashboard Styles */
        .dashboard-welcome {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .welcome-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .calculator-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
            position: relative;
            cursor: pointer;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .calculator-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(30, 64, 175, 0.15);
            border-color: var(--primary-color);
        }
        
        .calculator-card.featured {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            grid-column: span 2;
            min-height: 320px;
        }
        
        .calculator-card.featured:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(30, 64, 175, 0.3);
        }
        
        .calculator-card.featured h3,
        .calculator-card.featured p {
            color: white;
        }
        
        .card-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .calculator-card.featured .card-icon {
            color: white;
            font-size: 4rem;
        }
        
        .calculator-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .calculator-card p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.6;
            flex-grow: 1;
        }
        
        .featured-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        .card-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calculator-card.featured .card-button {
            background: white;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .card-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 64, 175, 0.3);
        }
        
        .calculator-card.featured .card-button:hover {
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 768px) {
            .calculator {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .container {
                padding: 0 10px;
            }

            nav {
            padding: 10px 15px;
            }

            .logo {
                font-size: 1.25rem;
            }



            .stats-grid {
                grid-template-columns: 1fr;
            gap: 10px;
        }

            .chart-container {
                height: 250px;
            }

            .export-actions {
                flex-direction: column;
                gap: 8px !important;
            }

            .export-actions .dropdown,
            .export-actions button {
                width: 100%;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 2px;
            }

            .tab {
                min-width: fit-content;
                padding: 10px 15px;
                font-size: 0.875rem;
            }

            .details-table {
                font-size: 0.875rem;
            }

            .stat-box {
                padding: 12px;
            }

            .stat-value {
                font-size: 1.5rem;
            }


        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            font-size: 16px; /* Prevents zoom on iOS */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Improved number input for mobile */
        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        input[type="range"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .slider-value {
            min-width: 40px;
            text-align: right;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background-color: rgba(59, 130, 246, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .dark .stat-box {
            background-color: rgba(59, 130, 246, 0.2);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dark .stat-label {
            color: #9ca3af;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 25px;
        }
        
        .details-table {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .details-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .details-label {
            font-size: 0.875rem;
        }
        
        .details-value {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .hidden {
            display: none;
        }
        
        .report-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .report-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
        }
        
        .bg-blue-light {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .dark .bg-blue-light {
            background-color: rgba(59, 130, 246, 0.2);
        }
        
        .bg-green-light {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .dark .bg-green-light {
            background-color: rgba(16, 185, 129, 0.2);
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .report-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .report-charts {
                grid-template-columns: 1fr;
            }
        }
        
        .report-footer {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .dark .report-footer {
            color: #9ca3af;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-color);
            color: var(--bg-color);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .closing-cost-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .closing-cost-item .label {
            flex: 1;
        }
        
        .closing-cost-item .amount {
            margin: 0 15px;
            font-weight: 500;
        }
        
        .closing-cost-item .split {
            display: flex;
            gap: 10px;
        }
        
        .split-option {
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .split-option.active {
            background-color: var(--primary-color);
            color: white;
        }

        .expense-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .expense-section h3 {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .expense-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px 15px; /* Reduced from 15px 20px */
            }

            .actions {
                flex-direction: row-reverse;
                align-items: flex-start;
                gap: 8px; /* Reduced from 10px */
            }

            .tabs {
                display: none;
                flex-direction: column;
                align-items: flex-start;
            }

            .tab {
                width: 100%;
                text-align: left;
                padding: 10px 8px; /* Reduced from 12px 10px */
            }

            .calculator {
                grid-template-columns: 1fr;
                gap: 15px; /* Reduced gap between cards */
                margin-bottom: 30px; /* Reduced from 50px */
            }

            .card {
                padding: 12px; /* Reduced from 15px */
                margin-bottom: 15px; /* Reduced spacing between cards */
            }

            .card-title {
                margin-bottom: 15px; /* Reduced space after title */
                font-size: 1.1rem; /* Slightly smaller title */
            }

            .form-group {
                margin-bottom: 12px; /* Reduced from default 20px */
            }

            .form-group label {
                margin-bottom: 4px; /* Reduced label spacing */
                font-size: 0.9rem; /* Slightly smaller labels */
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr; /* Keep 2 columns for better data density */
                gap: 10px; /* Reduced gap */
                margin-bottom: 15px; /* Reduced margin */
            }

            .stat-box {
                padding: 12px; /* Reduced padding */
            }

            .stat-value {
                font-size: 1.3rem; /* Slightly smaller but still prominent */
                margin-top: 4px; /* Reduced spacing */
            }

            .report-grid {
                grid-template-columns: 1fr;
                gap: 15px; /* Reduced gap */
            }

            .report-charts {
                grid-template-columns: 1fr;
                gap: 15px; /* Reduced gap */
            }

            .chart-container {
                margin-bottom: 15px; /* Reduced from 25px */
                padding: 10px 0; /* Added padding for better touch targets */
            }

            .details-table {
                margin-top: 10px; /* Reduced from 15px */
            }

            .details-row {
                flex-direction: row; /* Keep horizontal layout for better space usage */
                justify-content: space-between;
                align-items: center;
                padding: 8px 0; /* Reduced padding */
                border-bottom: 1px solid var(--border-color);
            }

            .details-label {
                font-size: 0.85rem; /* Smaller text */
                flex: 1;
            }

            .details-value {
                font-size: 0.9rem; /* Smaller text */
                font-weight: 600;
                margin-top: 0; /* Remove top margin */
                text-align: right;
            }

            /* Compact export actions */
            .export-actions {
                margin-top: 10px; /* Reduced from 15px */
                gap: 8px; /* Reduced gap */
            }

            /* Better button spacing */
            button {
                padding: 10px 16px; /* Slightly reduced padding */
                font-size: 0.9rem; /* Smaller text */
            }

            /* Optimize slider containers */
            .slider-container {
                margin-top: 8px; /* Reduced spacing */
            }

            /* Compact form groups with sliders */
            .form-group:has(.slider-container) {
                margin-bottom: 10px; /* Even more compact for sliders */
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            min-height: 300px;
            max-height: calc(100vh - 40px);
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            margin: 20px auto;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Better mobile modal animation */
        @media (max-width: 768px) {
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(50px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 25px;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
            overscroll-behavior: contain;
        }

        .history-controls, .favorites-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-list, .favorites-list {
            display: flex;
                flex-direction: column;
            gap: 10px;
        }

        .history-item, .favorite-item {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .history-item:hover, .favorite-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-date {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .item-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .summary-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }

        .summary-label {
            color: #6b7280;
        }

        .summary-value {
            font-weight: 600;
            color: var(--text-color);
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .item-actions button {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .btn-load {
            background: var(--primary-color);
            color: white;
        }

        .btn-favorite {
            background: #f59e0b;
            color: white;
        }

        .btn-unfavorite {
            background: #6b7280;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1rem;
            margin: 0;
        }

        /* Settings Modal Styles */
        .large-modal .modal-content {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .settings-section h4 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .setting-item label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .setting-item select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--background-color);
            color: var(--text-color);
            min-width: 140px;
        }

        .setting-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .settings-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            color: var(--text-color);
        }

        .settings-link:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .about-info {
            padding: 15px;
            background: var(--background-secondary);
            border-radius: 8px;
            text-align: center;
        }

        .about-info p {
            margin: 5px 0;
        }

        .settings-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .privacy-content, .terms-content {
            line-height: 1.6;
        }

        .privacy-content h4, .terms-content h4 {
            color: var(--primary-color);
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }

        .privacy-content ul, .terms-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .privacy-content li, .terms-content li {
            margin: 5px 0;
        }

        /* Theme icon animation */
        #theme-icon {
            transition: transform 0.3s ease;
        }

        .dark #theme-icon {
            transform: rotate(180deg);
        }

        /* PWA Install Banner */
        .pwa-install-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(30, 64, 175, 0.3);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: slideUpFadeIn 0.5s ease;
        }

        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pwa-install-content {
            flex: 1;
        }

        .pwa-install-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .pwa-install-text {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .pwa-install-actions {
            display: flex;
            gap: 10px;
        }

        .pwa-install-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pwa-install-btn {
            background: white;
            color: var(--primary-color);
        }

        .pwa-dismiss-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        @media (max-width: 768px) {
            .modal-overlay {
                padding: max(10px, env(safe-area-inset-top)) 10px 10px 10px;
                align-items: flex-start;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile browsers */
            }
            
            .modal-content {
                margin: 10px auto;
                max-height: calc(100vh - 20px);
                border-radius: 8px;
                width: calc(100% - 20px);
            }
            
            .modal-header {
                padding: 15px 20px;
                position: sticky;
                top: 0;
                z-index: 10;
                border-radius: 8px 8px 0 0;
            }
            
            .modal-body {
                padding: 15px;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
            }
            
            .history-controls, .favorites-controls {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .history-controls button, .favorites-controls button {
                width: 100%;
                justify-content: center;
            }
            
            .item-summary {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .item-actions {
                justify-content: center;
                gap: 6px;
                flex-wrap: wrap;
            }
            
            .item-actions button {
                flex: 1;
                min-width: 80px;
                font-size: 0.75rem;
                padding: 8px 10px;
            }
            
            .history-item, .favorite-item {
                padding: 12px;
                margin-bottom: 8px;
            }
        }

        @media (max-width: 480px) {
            .modal-overlay {
                padding: 5px;
            }
            
            .modal-content {
                width: calc(100% - 10px);
                max-height: calc(100vh - 10px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                margin: max(5px, env(safe-area-inset-top)) auto 5px auto;
            }
            
            .modal-header {
                padding: 12px 15px;
            }
            
            .modal-header h3 {
                font-size: 1.1rem;
            }
            
            .modal-body {
                padding: 12px;
                max-height: calc(100vh - 100px);
            }
            
            .history-item, .favorite-item {
                padding: 10px;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .item-date {
                font-size: 0.75rem;
            }

            /* Settings Modal Mobile Styles */
            .large-modal .modal-content {
                max-width: 95vw;
                margin: 20px auto;
            }
            
            .settings-actions {
                flex-direction: column;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .setting-item select {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 8px; /* Reduced from 10px */
            }

            .card {
                padding: 10px; /* Even more compact */
                margin-bottom: 12px; /* Reduced spacing */
            }

            .card-title {
                font-size: 1rem;
                margin-bottom: 12px; /* Reduced spacing */
            }

            .form-group {
                margin-bottom: 10px; /* More compact */
            }

            .form-group label {
                font-size: 0.8rem; /* Even smaller for tiny screens */
                margin-bottom: 3px; /* Minimal spacing */
            }

            input[type="number"], select {
                padding: 8px 10px;
                font-size: 16px; /* Prevent zoom on iOS */
            }

            button {
                padding: 8px 12px; /* Better than 2px 6px */
                font-size: 0.85rem; /* Readable size */
            }

            .btn-primary, .btn-export {
                font-size: 0.85rem;
                padding: 10px 14px; /* Better touch targets */
            }

            .stats-grid {
                gap: 8px; /* Reduced gap */
                margin-bottom: 12px; /* Reduced margin */
            }

            .stat-box {
                padding: 10px; /* More compact */
            }

            .stat-value {
                font-size: 1.2rem; /* Slightly smaller */
                margin-top: 2px; /* Minimal spacing */
            }

            .stat-label {
                font-size: 0.75rem; /* Smaller label */
            }

            .details-row {
                padding: 6px 0; /* More compact */
            }

            .details-label {
                font-size: 0.75rem; /* Smaller text */
            }

            .details-value {
                font-size: 0.8rem; /* Smaller text */
            }

            .chart-container {
                margin-bottom: 12px; /* Reduced margin */
            }

            .export-actions {
                margin-top: 8px; /* Reduced margin */
                gap: 6px; /* Smaller gap */
            }

            .export-actions button {
                padding: 8px 10px; /* Compact buttons */
                font-size: 0.8rem; /* Smaller text */
            }

            /* Compact headers */
            .report-header h1 {
                font-size: 1.4rem; /* Reduced from 1.5rem */
                margin-bottom: 8px; /* Reduced spacing */
            }

            .report-header p {
                font-size: 0.75rem;
                margin-bottom: 15px; /* Reduced spacing */
            }

            .report-section h2 {
                font-size: 1.1rem; /* Reduced from 1.125rem */
                margin-bottom: 10px; /* Reduced spacing */
            }

            .report-section h3 {
                font-size: 0.95rem; /* Reduced from 1rem */
                margin-top: 12px; /* Reduced spacing */
                margin-bottom: 8px; /* Reduced spacing */
            }

            .report-footer p {
                font-size: 0.7rem; /* Even smaller */
            }

            /* Optimize slider styling for small screens */
            .slider-container {
                margin-top: 6px; /* Reduced spacing */
            }

            .slider-value {
                font-size: 0.8rem; /* Smaller slider values */
            }
        }
        /* Additional mobile optimizations for save/load buttons */
        @media (max-width: 768px) {
            .action-text {
                display: none;
            }
            
            .actions {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .actions button {
                padding: 10px 12px;
                margin-right: 8px;
                font-size: 14px;
            }
            
            .nav-content {
                flex-direction: row;
                align-items: center;
                gap: 15px;
            }
            
            /* Dashboard Mobile Styles */
            .dashboard-welcome {
                padding: 20px 10px;
            }
            
            .welcome-header h1 {
                font-size: 2rem !important;
            }
            
            .welcome-header p {
                font-size: 1rem !important;
                margin-bottom: 30px !important;
            }
            
            .calculator-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .calculator-card.featured {
                grid-column: span 2;
                min-height: 180px;
                padding: 20px;
            }
            
            .calculator-card {
                padding: 16px;
                min-height: 140px;
            }
            
            .calculator-card h3 {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }
            
            .calculator-card p {
                font-size: 0.85rem;
                margin-bottom: 12px;
                line-height: 1.4;
            }
            
            .card-icon {
                font-size: 2rem;
                margin-bottom: 12px;
            }
            
            .calculator-card.featured .card-icon {
                font-size: 2.8rem;
                margin-bottom: 15px;
            }
            
            .card-button {
                padding: 8px 16px;
                font-size: 0.85rem;
                border-radius: 6px;
            }
            
            .calculator {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .actions button {
                padding: 10px;
                margin-right: 4px;
                font-size: 16px;
                min-width: 44px;
            }
            
            .actions {
                gap: 6px;
            }
            
            .nav-content {
                gap: 10px;
            }
            
            .mobile-menu-button span {
                display: none;
            }
            
            .mobile-menu-button {
                padding: 12px;
                min-width: 48px;
            }
            
            /* Even more compact for very small screens */
            .calculator-grid {
                gap: 8px;
            }
            
            .calculator-card {
                padding: 12px;
                min-height: 120px;
            }
            
            .calculator-card.featured {
                min-height: 160px;
                padding: 16px;
            }
            
            .calculator-card h3 {
                font-size: 1rem;
                margin-bottom: 6px;
            }
            
            .calculator-card p {
                font-size: 0.8rem;
                margin-bottom: 10px;
            }
            
            .card-icon {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            
            .calculator-card.featured .card-icon {
                font-size: 2.4rem;
                margin-bottom: 12px;
            }
            
            .card-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="dark">
    <!-- Loading Screen -->
    <div id="loading-screen" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
    ">
        <div style="text-align: center; color: white;">
            <!-- Logo Animation -->
            <div style="
                width: 120px;
                height: 120px;
                margin: 0 auto 30px;
                position: relative;
                animation: logoSpin 2s linear infinite;
            ">
                <img src="logo.fw.png" alt="HouseMath Logo" style="
                    width: 120px; 
                    height: 120px; 
                    object-fit: contain; 
                    filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3)); 
                    border-radius: 16px;
                " />
            </div>
            
            <!-- App Name -->
            <h1 style="
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 10px;
                letter-spacing: -1px;
                animation: fadeInUp 1s ease 0.5s both;
            ">HouseMath.app</h1>
            
            <!-- Tagline -->
            <p style="
                font-size: 1.1rem;
                opacity: 0.9;
                margin-bottom: 40px;
                animation: fadeInUp 1s ease 0.7s both;
            ">Professional Real Estate Calculator Suite</p>
            
            <!-- Loading Animation -->
            <div style="
                width: 60px;
                height: 60px;
                border: 4px solid rgba(255,255,255,0.3);
                border-top: 4px solid white;
                border-radius: 50%;
                margin: 0 auto;
                animation: spin 1s linear infinite;
            "></div>
            
            <!-- Loading Text -->
            <p style="
                font-size: 0.9rem;
                margin-top: 20px;
                opacity: 0.8;
                animation: pulse 2s infinite;
            ">Loading your financial tools...</p>
        </div>
        </div>
        
    <!-- Loading Animations -->
    <style>
        @keyframes logoSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }
    </style>

    <!-- Header with Custom Logo -->
    <header style="background: var(--primary-color); padding: 15px 0; text-align: center; color: white; box-shadow: 0 2px 10px rgba(30,64,175,0.2);">
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
            <!-- Custom Logo -->
            <div id="header-logo" style="position: relative; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease; border-radius: 8px; padding: 4px;" title="Go to Dashboard">
                <img src="logo.fw.png" alt="HouseMath Logo" style="width: 50px; height: 50px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); border-radius: 8px;" />
        </div>
            <div>
                <h1 id="app-title" style="margin: 0; font-size: 1.8rem; font-weight: 700; cursor: pointer; user-select: none; letter-spacing: -0.5px; transition: opacity 0.2s ease; border-radius: 4px; padding: 4px 8px;" title="Go to Dashboard">HouseMath.app</h1>
                <p style="margin: 2px 0 0 0; font-size: 0.85rem; opacity: 0.9; font-weight: 300;">Professional Real Estate Calculator Suite</p>
            </div>
        </div>
    </header>

    <!-- Navigation bar -->
    <nav>
        <div class="nav-content">
            <button class="mobile-menu-button" id="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
                <span>Menu</span>
            </button>
        
        <div class="actions">
                <button id="save-calc" title="Save Current Calculation (Ctrl+S)" class="btn-primary">
                    <i class="fas fa-save"></i>
                    <span class="action-text">Save</span>
                </button>
                <button id="load-calc" title="Load Saved Calculation (Ctrl+L)" class="btn-primary">
                    <i class="fas fa-folder-open"></i>
                    <span class="action-text">Load</span>
                </button>
                <button id="history-btn" title="View Calculation History (Ctrl+H)" class="btn-primary">
                    <i class="fas fa-history"></i>
                    <span class="action-text">History</span>
                </button>
                <button id="favorites-btn" title="View Favorites (Ctrl+F)" class="btn-primary">
                    <i class="fas fa-star"></i>
                    <span class="action-text">Favorites</span>
                </button>
                <button id="theme-toggle" title="Toggle Dark/Light Mode" class="btn-primary">
                    <i class="fas fa-moon" id="theme-icon"></i>
                    <span class="action-text">Theme</span>
                </button>
                <button id="settings-btn" title="Settings & Privacy" class="btn-primary">
                    <i class="fas fa-cog"></i>
                    <span class="action-text">Settings</span>
                </button>
            </div>
            </div>
            
        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" id="mobile-menu-overlay">
            <div class="mobile-menu-content">
                <div class="mobile-menu-header">
                    <h3>Calculators</h3>
                    <button class="mobile-menu-close" id="mobile-menu-close">
                        <i class="fas fa-times"></i>
                </button>
                        </div>
                <div class="mobile-menu-items">
                    <div class="mobile-tab active" data-tab="home">
                        <i class="fas fa-th-large"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="mobile-tab" data-tab="mortgage">
                        <i class="fas fa-home"></i>
                        <span>Mortgage Calculator</span>
                    </div>
                    <div class="mobile-tab" data-tab="investment">
                        <i class="fas fa-chart-line"></i>
                        <span>Investment Property</span>
                </div>
                    <div class="mobile-tab" data-tab="cashflow">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Rental Cash Flow</span>
            </div>
                    <div class="mobile-tab" data-tab="closing">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Closing Costs</span>
                    </div>
                    <div class="mobile-tab" data-tab="buyer">
                        <i class="fas fa-user-check"></i>
                        <span>Buyer Cost Sheet</span>
                    </div>
                    <div class="mobile-tab" data-tab="commission">
                        <i class="fas fa-percentage"></i>
                        <span>Commission Calculator</span>
                    </div>
                    <div class="mobile-tab" data-tab="comparison">
                        <i class="fas fa-balance-scale"></i>
                        <span>Property Comparison</span>
                    </div>
                    <div class="mobile-tab" data-tab="rentbuy">
                        <i class="fas fa-home-alt"></i>
                        <span>Rent vs Buy</span>
                    </div>
                    <div class="mobile-tab" data-tab="refinance">
                        <i class="fas fa-redo-alt"></i>
                        <span>Refinancing</span>
                    </div>
                    <div class="mobile-tab" data-tab="heloc">
                        <i class="fas fa-piggy-bank"></i>
                        <span>HELOC</span>
                    </div>
                    <div class="mobile-tab" data-tab="flip">
                        <i class="fas fa-hammer"></i>
                        <span>Property Flip</span>
                    </div>
                    <div class="mobile-tab" data-tab="brrrr">
                        <i class="fas fa-sync-alt"></i>
                        <span>BRRRR Strategy</span>
                    </div>
                    <div class="mobile-tab" data-tab="report">
                        <i class="fas fa-file-alt"></i>
                        <span>Generated Report</span>
                    </div>
                </div>
                <div class="mobile-menu-footer">
                    <a href="http://www.zebarigroup.com" target="_blank" style="color: #6b7280; text-decoration: none; font-size: 0.875rem;">
                    Powered by Zebari Group IT Services
                </a>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div id="history-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-history"></i> Calculation History</h3>
                    <button class="modal-close" id="history-modal-close">
                        <i class="fas fa-times"></i>
            </button>
                </div>
                <div class="modal-body">
                    <div class="history-controls">
                        <button id="clear-history" class="btn-red">
                            <i class="fas fa-trash"></i> Clear All History
                        </button>
                        <button id="export-history" class="btn-primary">
                            <i class="fas fa-download"></i> Export History
            </button>
                    </div>
                    <div id="history-list" class="history-list">
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>No calculation history yet. Start calculating to see your history here!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Favorites Modal -->
        <div id="favorites-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-star"></i> Favorite Calculations</h3>
                    <button class="modal-close" id="favorites-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="favorites-controls">
                        <button id="clear-favorites" class="btn-red">
                            <i class="fas fa-trash"></i> Clear All Favorites
                        </button>
                        <button id="export-favorites" class="btn-primary">
                            <i class="fas fa-download"></i> Export Favorites
                        </button>
                    </div>
                    <div id="favorites-list" class="favorites-list">
                        <div class="empty-state">
                            <i class="fas fa-star"></i>
                            <p>No favorite calculations yet. Save calculations to favorites to access them quickly!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-cog"></i> Settings & Privacy</h3>
                    <button class="modal-close" id="settings-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="settings-section">
                        <h4><i class="fas fa-palette"></i> Appearance</h4>
                        <div class="setting-item">
                            <label for="theme-selector">Theme:</label>
                            <select id="theme-selector">
                                <option value="light">Light Mode</option>
                                <option value="dark">Dark Mode</option>
                                <option value="auto">Auto (System)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4><i class="fas fa-calculator"></i> Calculator Preferences</h4>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="auto-save-enabled" checked>
                                Auto-save calculations
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="haptic-feedback-enabled" checked>
                                Haptic feedback (mobile)
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4><i class="fas fa-shield-alt"></i> Privacy & Legal</h4>
                        <div class="settings-links">
                            <button class="settings-link" id="privacy-policy-btn">
                                <i class="fas fa-user-shield"></i> Privacy Policy
                            </button>
                            <button class="settings-link" id="terms-service-btn">
                                <i class="fas fa-file-contract"></i> Terms of Service
                            </button>
                            <button class="settings-link" id="data-usage-btn">
                                <i class="fas fa-database"></i> Data Usage
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4><i class="fas fa-info-circle"></i> About</h4>
                        <div class="about-info">
                            <p><strong>HouseMath.app</strong></p>
                            <p>Version 2.0.0</p>
                            <p>Professional Real Estate Calculator Suite</p>
                            <p style="margin-top: 15px;">
                                <a href="http://www.zebarigroup.com" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-external-link-alt"></i> Powered by Zebari Group IT Services
                                </a>
                            </p>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-actions">
                            <button id="reset-app-data" class="btn-red">
                                <i class="fas fa-trash-restore"></i> Reset All Data
                            </button>
                            <button id="export-app-data" class="btn-primary">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Policy Modal -->
        <div id="privacy-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-user-shield"></i> Privacy Policy</h3>
                    <button class="modal-close" id="privacy-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="privacy-content">
                        <p><strong>Last updated:</strong> January 2024</p>
                        
                        <h4>Data Collection</h4>
                        <p>HouseMath.app is designed with privacy in mind. We collect minimal data to provide you with the best calculator experience:</p>
                        <ul>
                            <li><strong>Local Storage:</strong> Your calculations, favorites, and settings are stored locally on your device</li>
                            <li><strong>No Personal Data:</strong> We do not collect names, emails, or personal information</li>
                            <li><strong>No Tracking:</strong> We do not use analytics or tracking cookies</li>
                        </ul>
                        
                        <h4>Data Usage</h4>
                        <p>All calculation data remains on your device and is never transmitted to our servers. Your privacy is our priority.</p>
                        
                        <h4>Local Storage</h4>
                        <p>We use your browser's local storage to:</p>
                        <ul>
                            <li>Save your calculation history</li>
                            <li>Remember your favorite calculations</li>
                            <li>Store your theme and app preferences</li>
                        </ul>
                        
                        <h4>Third-Party Services</h4>
                        <p>This app uses:</p>
                        <ul>
                            <li><strong>CDN Services:</strong> For fonts and icons (Google Fonts, Font Awesome)</li>
                            <li><strong>No Analytics:</strong> We do not use Google Analytics or similar services</li>
                        </ul>
                        
                        <h4>Data Control</h4>
                        <p>You have full control over your data:</p>
                        <ul>
                            <li>Clear history and favorites anytime</li>
                            <li>Export your data</li>
                            <li>Reset all app data from settings</li>
                        </ul>
                        
                        <h4>Contact</h4>
                        <p>For privacy questions, contact us through <a href="http://www.zebarigroup.com" target="_blank" style="color: var(--primary-color);">Zebari Group IT Services</a>.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terms of Service Modal -->
        <div id="terms-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-file-contract"></i> Terms of Service</h3>
                    <button class="modal-close" id="terms-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="terms-content">
                        <p><strong>Last updated:</strong> January 2024</p>
                        
                        <h4>Acceptance of Terms</h4>
                        <p>By using HouseMath.app, you agree to these Terms of Service. If you do not agree, please do not use the application.</p>
                        
                        <h4>Description of Service</h4>
                        <p>HouseMath.app provides real estate calculation tools for:</p>
                        <ul>
                            <li>Mortgage calculations</li>
                            <li>Investment property analysis</li>
                            <li>Cash flow projections</li>
                            <li>Commission calculations</li>
                            <li>Closing cost estimates</li>
                        </ul>
                        
                        <h4>Disclaimer</h4>
                        <p><strong>Important:</strong> This application provides estimates and calculations for informational purposes only. Results should not be considered as:</p>
                        <ul>
                            <li>Professional financial advice</li>
                            <li>Legal advice</li>
                            <li>Investment recommendations</li>
                            <li>Guaranteed loan terms</li>
                        </ul>
                        
                        <h4>Accuracy</h4>
                        <p>While we strive for accuracy, calculations are estimates based on provided inputs. Always consult with qualified professionals for important financial decisions.</p>
                        
                        <h4>Limitation of Liability</h4>
                        <p>HouseMath.app and its developers are not liable for any decisions made based on calculations from this application.</p>
                        
                        <h4>Use License</h4>
                        <p>You may use this application for personal and professional purposes. You may not redistribute or resell the application.</p>
                        
                        <h4>Updates</h4>
                        <p>We may update these terms occasionally. Continued use of the application constitutes acceptance of updated terms.</p>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="pwa-install-banner">
        <div class="pwa-install-content">
            <div class="pwa-install-title">📱 Install HouseMath App</div>
            <div class="pwa-install-text">Add to your home screen for quick access and offline use!</div>
        </div>
        <div class="pwa-install-actions">
            <button id="pwa-install-btn" class="pwa-install-btn">Install</button>
            <button id="pwa-dismiss-btn" class="pwa-dismiss-btn">Maybe Later</button>
        </div>
    </div>
    
    <!-- Main content -->
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="home"><i class="fas fa-home"></i> Dashboard</div>
            <div class="tab" data-tab="mortgage"><i class="fas fa-home"></i> Mortgage Calculator</div>
            <div class="tab" data-tab="investment">Investment Property</div>
            <div class="tab" data-tab="cashflow">Rental Cash Flow</div>
            <div class="tab" data-tab="closing">Closing Costs</div>
            <div class="tab" data-tab="buyer">Buyer Cost Sheet</div>
            <div class="tab" data-tab="commission">Commission Calculator</div>
            <div class="tab" data-tab="comparison">Property Comparison</div>
            <div class="tab" data-tab="rentbuy">Rent vs Buy</div>
            <div class="tab" data-tab="refinance">Refinancing</div>
            <div class="tab" data-tab="heloc">HELOC</div>
            <div class="tab" data-tab="flip">Property Flip</div>
            <div class="tab" data-tab="brrrr">BRRRR Strategy</div>
            <div class="tab" data-tab="report">Generated Report</div>
        </div>



        <!-- Dashboard Home Page -->
        <div id="home-calculator" class="calculator fade-in">
            <div class="dashboard-welcome">


                <div class="calculator-grid">
                    <!-- Primary Calculator - Mortgage (Featured) -->
                    <div class="calculator-card featured" data-calculator="mortgage">
                        <div class="card-icon">
                            <img src="mortgage.fw.png" alt="Mortgage Calculator" style="width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2)); border-radius: 12px;" />
                        </div>
                        <h3>Mortgage Calculator</h3>
                        <p>Calculate monthly payments, interest, and loan details for home purchases.</p>
                        <div class="featured-badge">Most Popular</div>
                        <button class="card-button">Calculate Now</button>
                </div>

                    <!-- Secondary Calculators -->
                    <div class="calculator-card" data-calculator="investment">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                    </div>
                        <h3>Investment Property</h3>
                        <p>Analyze rental property investments and ROI projections.</p>
                        <button class="card-button">Analyze</button>
                </div>

                    <div class="calculator-card" data-calculator="cashflow">
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                    </div>
                        <h3>Rental Cash Flow</h3>
                        <p>Calculate monthly rental income and expense breakdowns.</p>
                        <button class="card-button">Calculate</button>
                </div>

                    <div class="calculator-card" data-calculator="commission">
                        <div class="card-icon">
                            <i class="fas fa-percentage"></i>
                    </div>
                        <h3>Commission Calculator</h3>
                        <p>Calculate real estate commissions and agent splits.</p>
                        <button class="card-button">Calculate</button>
                    </div>
                    
                    <div class="calculator-card" data-calculator="closing">
                        <div class="card-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                        <h3>Closing Costs</h3>
                        <p>Estimate buyer and seller closing costs and fees.</p>
                        <button class="card-button">Estimate</button>
                    </div>

                    <div class="calculator-card" data-calculator="buyer">
                        <div class="card-icon">
                            <i class="fas fa-user-check"></i>
                    </div>
                        <h3>Buyer Cost Sheet</h3>
                        <p>Calculate total costs for property buyers including points and interest.</p>
                        <button class="card-button">Calculate</button>
                    </div>

                    <div class="calculator-card" data-calculator="comparison">
                        <div class="card-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h3>Property Comparison</h3>
                        <p>Compare multiple properties side-by-side with detailed analysis.</p>
                        <button class="card-button">Compare</button>
                </div>

                    <!-- New Advanced Calculators -->
                    <div class="calculator-card" data-calculator="rentbuy">
                        <div class="card-icon">
                            <i class="fas fa-home-alt"></i>
                        </div>
                        <h3>Rent vs Buy</h3>
                        <p>Determine whether renting or buying makes more financial sense.</p>
                        <button class="card-button">Analyze</button>
                </div>

                    <div class="calculator-card" data-calculator="refinance">
                        <div class="card-icon">
                            <i class="fas fa-redo-alt"></i>
                </div>
                        <h3>Refinancing</h3>
                        <p>Calculate savings and break-even point for refinancing your mortgage.</p>
                        <button class="card-button">Calculate</button>
                    </div>

                    <div class="calculator-card" data-calculator="heloc">
                        <div class="card-icon">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                        <h3>HELOC Calculator</h3>
                        <p>Analyze home equity line of credit options and payments.</p>
                        <button class="card-button">Calculate</button>
                    </div>

                    <div class="calculator-card" data-calculator="flip">
                        <div class="card-icon">
                            <i class="fas fa-hammer"></i>
                        </div>
                        <h3>Property Flip</h3>
                        <p>Calculate potential profits and ROI for fix-and-flip projects.</p>
                        <button class="card-button">Analyze</button>
                    </div>

                    <div class="calculator-card" data-calculator="brrrr">
                        <div class="card-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <h3>BRRRR Strategy</h3>
                        <p>Buy, Rehab, Rent, Refinance, Repeat investment analysis.</p>
                        <button class="card-button">Calculate</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mortgage Calculator -->
        <div id="mortgage-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title">
                    <svg width="24" height="24" viewBox="0 0 48 48" style="vertical-align: middle; margin-right: 8px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));">
                        <!-- House structure -->
                        <path d="M24 8 L40 20 L40 38 L8 38 L8 20 Z" fill="#3b82f6" stroke="#1e40af" stroke-width="1">
                            <animate attributeName="fill" values="#3b82f6;#60a5fa;#3b82f6" dur="3s" repeatCount="indefinite"/>
                        </path>
                        <!-- Roof -->
                        <path d="M24 8 L42 21 L6 21 Z" fill="#1e40af">
                            <animate attributeName="fill" values="#1e40af;#2563eb;#1e40af" dur="3s" repeatCount="indefinite"/>
                        </path>
                        <!-- Door -->
                        <rect x="20" y="28" width="8" height="10" fill="#ef4444" rx="1">
                            <animate attributeName="fill" values="#ef4444;#f87171;#ef4444" dur="2s" repeatCount="indefinite"/>
                        </rect>
                        <!-- Windows -->
                        <rect x="12" y="24" width="6" height="6" fill="#fbbf24" rx="0.5">
                            <animate attributeName="opacity" values="0.7;1;0.7" dur="2.5s" repeatCount="indefinite"/>
                        </rect>
                        <rect x="30" y="24" width="6" height="6" fill="#fbbf24" rx="0.5">
                            <animate attributeName="opacity" values="1;0.7;1" dur="2.5s" repeatCount="indefinite"/>
                        </rect>
                        <!-- Dollar sign -->
                        <text x="24" y="16" font-family="Arial" font-size="6" font-weight="bold" text-anchor="middle" fill="#10b981">$
                            <animate attributeName="y" values="16;12;16" dur="2s" repeatCount="indefinite"/>
                        </text>
                    </svg>
                    Mortgage Calculator
                </h2>
                
                <div class="form-group">
                    <label for="property-price">Property Price ($)</label>
                    <input type="number" id="property-price" value="350000">
                </div>
                
                <div class="form-group">
                    <label for="down-payment-slider">Down Payment (%)</label>
                    <div class="slider-container">
                        <input type="range" id="down-payment-slider" min="0" max="50" step="1" value="20">
                        <span id="down-payment-value" class="slider-value">20%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="loan-term">Loan Term (years)</label>
                    <select id="loan-term">
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30" selected>30 years</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="interest-rate-slider">Interest Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="interest-rate-slider" min="2" max="10" step="0.1" value="4.5">
                        <span id="interest-rate-value" class="slider-value">4.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="property-tax">Property Tax ($/year)</label>
                    <input type="number" id="property-tax" value="3500">
                </div>
                
                <div class="form-group">
                    <label for="home-insurance">Home Insurance ($/year)</label>
                    <input type="number" id="home-insurance" value="1200">
                </div>
                
                <div class="form-group">
                    <label for="hoa">HOA Fees ($/month)</label>
                    <input type="number" id="hoa" value="0">
                </div>
                
                <button id="calculate-mortgage" class="btn-primary" style="width: 100%;">Calculate Mortgage</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="mortgage">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="mortgage">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="mortgage">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="mortgage" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Monthly Breakdown</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Principal & Interest</div>
                        <div class="stat-value" id="principal-interest">$1,425</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Total Monthly</div>
                        <div class="stat-value" id="total-monthly">$1,767</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="payment-chart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="amortization-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Loan Summary</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Loan Amount:</div>
                        <div class="details-value" id="loan-amount">$280,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Down Payment:</div>
                        <div class="details-value" id="down-payment-amount">$70,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Interest Paid:</div>
                        <div class="details-value" id="total-interest">$233,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Cost:</div>
                        <div class="details-value" id="total-cost">$583,000</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Investment Property Calculator -->
        <div id="investment-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> Investment Property Analysis</h2>
                
                <div class="form-group">
                    <label for="inv-purchase-price">Purchase Price ($)</label>
                    <input type="number" id="inv-purchase-price" value="300000">
                </div>
                
                <div class="form-group">
                    <label for="annual-rent">Expected Annual Rent ($)</label>
                    <input type="number" id="annual-rent" value="24000">
                </div>
                
                <div class="form-group">
                    <label for="expenses-slider">Annual Property Expenses (%)</label>
                    <div class="slider-container">
                        <input type="range" id="expenses-slider" min="20" max="50" step="1" value="35">
                        <span id="expenses-value" class="slider-value">35%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vacancy-slider">Vacancy Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="vacancy-slider" min="0" max="15" step="1" value="5">
                        <span id="vacancy-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="appreciation-slider">Annual Appreciation Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="appreciation-slider" min="0" max="10" step="0.5" value="3.5">
                        <span id="appreciation-value" class="slider-value">3.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="holding-period">Holding Period (years)</label>
                    <select id="holding-period">
                        <option value="5">5 years</option>
                        <option value="10" selected>10 years</option>
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30">30 years</option>
                    </select>
                </div>
                
                <button id="calculate-investment" class="btn-primary" style="width: 100%;">Calculate Investment Returns</button>
                
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="investment">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="investment">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="investment">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="investment" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Investment Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Cash-on-Cash ROI</div>
                        <div class="stat-value" id="cash-on-cash">8.4%</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Cap Rate</div>
                        <div class="stat-value" id="cap-rate">6.2%</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="investment-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Monthly Cash Flow</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Monthly Rent:</div>
                        <div class="details-value" id="monthly-rent">$2,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Monthly Expenses:</div>
                        <div class="details-value" id="monthly-expenses">$700</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Monthly Cash Flow:</div>
                        <div class="details-value" id="monthly-cashflow">$1,300</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Annual Cash Flow:</div>
                        <div class="details-value" id="annual-cashflow">$15,600</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Future Value</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Property Value After <span id="period-label">10</span> Years:</div>
                        <div class="details-value" id="future-property-value">$423,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Rental Income:</div>
                        <div class="details-value" id="total-rental-income">$240,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Return:</div>
                        <div class="details-value" id="total-return">$363,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Annualized Return:</div>
                        <div class="details-value" id="annualized-return">12.1%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rental Cash Flow Calculator -->
        <div id="cashflow-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-dollar-sign"></i> Rental Cash Flow Calculator</h2>
                
                <div class="form-group">
                    <label for="rental-income">Monthly Rental Income ($)</label>
                    <input type="number" id="rental-income" value="2000">
                </div>
                
                <div class="form-group">
                    <label for="mortgage-payment">Monthly Mortgage Payment ($)</label>
                    <input type="number" id="mortgage-payment" value="1000">
                </div>
                
                <div class="form-group">
                    <label for="rental-property-tax">Monthly Property Tax ($)</label>
                    <input type="number" id="rental-property-tax" value="150">
                </div>
                
                <div class="form-group">
                    <label for="rental-insurance">Monthly Home Insurance ($)</label>
                    <input type="number" id="rental-insurance" value="100">
                </div>
                
                <div class="form-group">
                    <label for="management-slider">Management Percent (%)</label>
                    <div class="slider-container">
                        <input type="range" id="management-slider" min="0" max="20" step="1" value="10">
                        <span id="management-value" class="slider-value">10%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="maintenance-slider">Maintenance Percent (%)</label>
                    <div class="slider-container">
                        <input type="range" id="maintenance-slider" min="0" max="10" step="1" value="5">
                        <span id="maintenance-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vacancy-slider">Vacancy Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="vacancy-slider" min="0" max="15" step="1" value="5">
                        <span id="vacancy-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <button id="calculate-cashflow" class="btn-primary" style="width: 100%;">Calculate Cash Flow</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="cashflow">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="cashflow">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="cashflow">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="cashflow" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Cash Flow Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Gross Income:</div>
                        <div class="stat-value" id="gross-income">$2,400</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Total Expenses:</div>
                        <div class="stat-value" id="total-expenses">$1,150</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="cashflow-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Net Operating Income</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Gross Income:</div>
                        <div class="details-value" id="gross-income">$2,400</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Expenses:</div>
                        <div class="details-value" id="total-expenses">$1,150</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Net Operating Income:</div>
                        <div class="details-value" id="net-operating-income">$1,250</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Cash Flow</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Cash Flow Before Taxes:</div>
                        <div class="details-value" id="cash-flow-before-taxes">$1,250</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Cash Flow After Taxes:</div>
                        <div class="details-value" id="cash-flow-after-taxes">$1,250</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Closing Costs Calculator -->
        <div id="closing-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Closing Costs Calculator</h2>
                
                <div class="form-group">
                    <label for="closing-price">Sales Price ($)</label>
                    <input type="number" id="closing-price" value="350000">
                </div>
                
                <div class="form-group">
                    <label for="closing-mortgage">Mortgage Amount ($)</label>
                    <input type="number" id="closing-mortgage" value="280000">
                </div>
                
                <div class="form-group">
                    <label for="commission-rate">Commission Rate (%)</label>
                    <input type="number" id="commission-rate" value="6">
                </div>
                
                <div class="form-group">
                    <label for="deed-pages">Deed Pages</label>
                    <input type="number" id="deed-pages" value="2">
                </div>
                
                <div class="form-group">
                    <label for="mortgage-pages">Mortgage Pages</label>
                    <input type="number" id="mortgage-pages" value="20">
                </div>
                
                <button id="calculate-closing" class="btn-primary" style="width: 100%;">Calculate Closing Costs</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="closing">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="closing">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="closing">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="closing" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Closing Costs</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Buyer's Total:</div>
                        <div class="stat-value" id="buyer-total">$350,000</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Seller's Total:</div>
                        <div class="stat-value" id="seller-total">$350,000</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="closing-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Breakdown</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Mortgage Fees:</div>
                        <div class="details-value" id="mortgage-fees">$1,400</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Settlement Fee:</div>
                        <div class="details-value" id="settlement-fee">$595</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Title Search:</div>
                        <div class="details-value" id="title-search">$150</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Association Fee:</div>
                        <div class="details-value" id="association-fee">$250</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Survey:</div>
                        <div class="details-value" id="survey">$375</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Termite:</div>
                        <div class="details-value" id="termite">$100</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">New Lien Search Fee:</div>
                        <div class="details-value" id="lien-search">$75</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Commission:</div>
                        <div class="details-value" id="commission">$21,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Owner's Policy:</div>
                        <div class="details-value" id="owners-policy">$1,925</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Lender's Policy:</div>
                        <div class="details-value" id="lenders-policy">$1,925</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Environmental Endorsement:</div>
                        <div class="details-value" id="environmental">$100</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">ALTA 9-06:</div>
                        <div class="details-value" id="alta-9">$50</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">ALTA 5.1:</div>
                        <div class="details-value" id="alta-5">$25</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">ALTA 4.1:</div>
                        <div class="details-value" id="alta-4">$25</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Recording Fees:</div>
                        <div class="details-value" id="recording">$200</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Doc Stamp on Mortgage:</div>
                        <div class="details-value" id="doc-stamp-mortgage">$1,750</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Intangible Tax on Mortgage:</div>
                        <div class="details-value" id="intangible-tax">$1,400</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Doc Stamp on Deed:</div>
                        <div class="details-value" id="doc-stamp-deed">$1,750</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buyer Cost Sheet Calculator -->
        <div id="buyer-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-user-tie"></i> Buyer Cost Sheet Calculator</h2>
                
                <div class="form-group">
                    <label for="buyer-sales-price">Sales Price ($)</label>
                    <input type="number" id="buyer-sales-price" value="350000">
                </div>
                
                <div class="form-group">
                    <label for="buyer-down-payment">Down Payment ($)</label>
                    <input type="number" id="buyer-down-payment" value="70000">
                </div>
                
                <div class="form-group">
                    <label for="buyer-mortgage">Mortgage Amount ($)</label>
                    <input type="number" id="buyer-mortgage" value="280000">
                </div>
                
                <div class="form-group">
                    <label for="buyer-mortgage-rate">Mortgage Rate (%)</label>
                    <input type="number" id="buyer-mortgage-rate" value="4.5">
                </div>
                
                <div class="form-group">
                    <label for="buyer-points">Points (%)</label>
                    <input type="number" id="buyer-points" value="3">
                </div>
                
                <div class="form-group">
                    <label for="buyer-days-interest">Days Interest</label>
                    <input type="number" id="buyer-days-interest" value="180">
                </div>
                
                <button id="calculate-buyer" class="btn-primary" style="width: 100%;">Calculate Buyer Costs</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="buyer">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="buyer">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="buyer">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="buyer" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Buyer Costs</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total:</div>
                        <div class="stat-value" id="buyer-total-due">$350,000</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Points Cost:</div>
                        <div class="stat-value" id="buyer-points-cost">$2,100</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="buyer-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Breakdown</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Mortgage:</div>
                        <div class="details-value" id="buyer-mortgage">$280,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Points:</div>
                        <div class="details-value" id="buyer-points">$2,100</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Interest:</div>
                        <div class="details-value" id="buyer-interest">$1,425</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Other Costs:</div>
                        <div class="details-value" id="buyer-other-costs">$1,425</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generated Report -->
        <div id="report-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-alt"></i> Report Generator</h2>
                
                <div class="form-group">
                    <label for="report-purchase-price">Purchase Price ($)</label>
                    <input type="number" id="report-purchase-price" value="350000">
                </div>
                
                <div class="form-group">
                    <label for="report-down-payment">Down Payment (%)</label>
                    <input type="number" id="report-down-payment" value="20">
                </div>
                
                <div class="form-group">
                    <label for="report-loan-term">Loan Term (years)</label>
                    <input type="number" id="report-loan-term" value="30">
                </div>
                
                <div class="form-group">
                    <label for="report-interest-rate">Interest Rate (%)</label>
                    <input type="number" id="report-interest-rate" value="4.5">
                </div>
                
                <div class="form-group">
                    <label for="report-property-tax">Property Tax ($/year)</label>
                    <input type="number" id="report-property-tax" value="3500">
                </div>
                
                <div class="form-group">
                    <label for="report-home-insurance">Home Insurance ($/year)</label>
                    <input type="number" id="report-home-insurance" value="1200">
                </div>
                
                <div class="form-group">
                    <label for="report-hoa">HOA Fees ($/month)</label>
                    <input type="number" id="report-hoa" value="0">
                </div>
                
                <div class="form-group">
                    <label for="report-rental-income">Monthly Rental Income ($)</label>
                    <input type="number" id="report-rental-income" value="2000">
                </div>
                
                <div class="form-group">
                    <label for="report-rental-property-tax">Monthly Property Tax ($)</label>
                    <input type="number" id="report-rental-property-tax" value="150">
                </div>
                
                <div class="form-group">
                    <label for="report-rental-insurance">Monthly Home Insurance ($)</label>
                    <input type="number" id="report-rental-insurance" value="100">
                </div>
                
                <div class="form-group">
                    <label for="report-management-slider">Management Percent (%)</label>
                    <div class="slider-container">
                        <input type="range" id="report-management-slider" min="0" max="20" step="1" value="10">
                        <span id="report-management-value" class="slider-value">10%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="report-maintenance-slider">Maintenance Percent (%)</label>
                    <div class="slider-container">
                        <input type="range" id="report-maintenance-slider" min="0" max="10" step="1" value="5">
                        <span id="report-maintenance-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="report-vacancy-slider">Vacancy Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="report-vacancy-slider" min="0" max="15" step="1" value="5">
                        <span id="report-vacancy-value" class="slider-value">5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="report-appreciation-slider">Annual Appreciation Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="report-appreciation-slider" min="0" max="10" step="0.5" value="3.5">
                        <span id="report-appreciation-value" class="slider-value">3.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="report-holding-period">Holding Period (years)</label>
                    <select id="report-holding-period">
                        <option value="5">5 years</option>
                        <option value="10" selected>10 years</option>
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30">30 years</option>
                    </select>
                </div>
                
                <button id="generate-report" class="btn-primary" style="width: 100%;">Generate Report</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="report">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="report">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="report">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="report" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">Report</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total Investment:</div>
                        <div class="stat-value" id="report-total-investment">$70,000</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Total Return:</div>
                        <div class="stat-value" id="report-total-return">$583,000</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="report-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">Breakdown</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Principal & Interest:</div>
                        <div class="details-value" id="report-principal-interest">$1,425</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Property Tax:</div>
                        <div class="details-value" id="report-property-tax">$350</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Insurance:</div>
                        <div class="details-value" id="report-home-insurance">$120</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">HOA Fees:</div>
                        <div class="details-value" id="report-hoa">$0</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Management:</div>
                        <div class="details-value" id="report-management">$167</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Maintenance:</div>
                        <div class="details-value" id="report-maintenance">$83</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Vacancy:</div>
                        <div class="details-value" id="report-vacancy">$167</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Cash Flow:</div>
                        <div class="details-value" id="report-cash-flow">$1,767</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commission Calculator -->
        <div id="commission-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-percentage"></i> Real Estate Commission Calculator</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Calculate your commission earnings and splits with precision</p>
                
                <div class="form-group">
                    <label for="sale-price">Sale Price ($)</label>
                    <input type="number" id="sale-price" value="450000">
    </div>
                
                <div class="form-group">
                    <label for="commission-rate-slider">Total Commission Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="commission-rate-slider" min="4" max="8" step="0.25" value="6">
                        <span id="commission-rate-display" class="slider-value">6%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="listing-split-slider">Listing Agent Split (%)</label>
                    <div class="slider-container">
                        <input type="range" id="listing-split-slider" min="40" max="100" step="5" value="70">
                        <span id="listing-split-display" class="slider-value">70%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="selling-split-slider">Selling Agent Split (%)</label>
                    <div class="slider-container">
                        <input type="range" id="selling-split-slider" min="40" max="100" step="5" value="70">
                        <span id="selling-split-display" class="slider-value">70%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="transaction-fee">Transaction Fee ($)</label>
                    <input type="number" id="transaction-fee" value="395">
                </div>
                
                <div class="form-group">
                    <label for="agent-role">You are the:</label>
                    <select id="agent-role">
                        <option value="listing">Listing Agent</option>
                        <option value="selling">Selling Agent</option>
                        <option value="both">Both (Dual Agency)</option>
                    </select>
                </div>
                
                <button id="calculate-commission" class="btn-primary" style="width: 100%;">Calculate Commission</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="commission">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="commission">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="commission">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="commission" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">💰 Commission Breakdown</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Your Gross Commission</div>
                        <div class="stat-value" id="your-gross-commission">$18,900</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Your Net Commission</div>
                        <div class="stat-value" id="your-net-commission">$18,505</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="commission-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">💸 Commission Details</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Total Commission:</div>
                        <div class="details-value" id="total-commission">$27,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Listing Side:</div>
                        <div class="details-value" id="listing-side-total">$13,500</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Selling Side:</div>
                        <div class="details-value" id="selling-side-total">$13,500</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Your Commission (Before Fees):</div>
                        <div class="details-value" id="your-commission-before-fees">$18,900</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Transaction Fees:</div>
                        <div class="details-value" id="total-fees">$395</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Your Net Commission:</div>
                        <div class="details-value" id="final-commission" style="font-weight: 700; color: #10b981;">$18,505</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Property Comparison Calculator -->
        <div id="comparison-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-balance-scale"></i> Property Comparison Tool</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Compare up to 3 properties side-by-side for your clients</p>
                
                <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">🏠 Property A</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyA-price">Price ($)</label>
                            <input type="number" id="propertyA-price" value="425000">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyA-sqft">Square Feet</label>
                            <input type="number" id="propertyA-sqft" value="2100">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyA-bedrooms">Bedrooms</label>
                            <input type="number" id="propertyA-bedrooms" value="3">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyA-bathrooms">Bathrooms</label>
                            <input type="number" id="propertyA-bathrooms" value="2.5" step="0.5">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyA-hoa">HOA ($/month)</label>
                            <input type="number" id="propertyA-hoa" value="150">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyA-year">Year Built</label>
                            <input type="number" id="propertyA-year" value="2018">
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #10b981;">🏠 Property B</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyB-price">Price ($)</label>
                            <input type="number" id="propertyB-price" value="395000">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyB-sqft">Square Feet</label>
                            <input type="number" id="propertyB-sqft" value="1950">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyB-bedrooms">Bedrooms</label>
                            <input type="number" id="propertyB-bedrooms" value="3">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyB-bathrooms">Bathrooms</label>
                            <input type="number" id="propertyB-bathrooms" value="2" step="0.5">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyB-hoa">HOA ($/month)</label>
                            <input type="number" id="propertyB-hoa" value="0">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyB-year">Year Built</label>
                            <input type="number" id="propertyB-year" value="2015">
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(236, 72, 153, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #ec4899;">🏠 Property C</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyC-price">Price ($)</label>
                            <input type="number" id="propertyC-price" value="475000">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyC-sqft">Square Feet</label>
                            <input type="number" id="propertyC-sqft" value="2300">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyC-bedrooms">Bedrooms</label>
                            <input type="number" id="propertyC-bedrooms" value="4">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyC-bathrooms">Bathrooms</label>
                            <input type="number" id="propertyC-bathrooms" value="3" step="0.5">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyC-hoa">HOA ($/month)</label>
                            <input type="number" id="propertyC-hoa" value="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="propertyC-year">Year Built</label>
                            <input type="number" id="propertyC-year" value="2020">
                        </div>
                    </div>
                </div>
                
                <button id="calculate-comparison" class="btn-primary" style="width: 100%;">Compare Properties</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="comparison">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="comparison">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="comparison">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="comparison" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">📊 Property Comparison Results</h2>
                
                <div class="chart-container">
                    <canvas id="comparison-chart"></canvas>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">Property A</h4>
                        <div class="stat-value" id="propertyA-price-per-sqft">$202/sqft</div>
                        <div class="stat-label">Price per Sq Ft</div>
                    </div>
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: #10b981;">Property B</h4>
                        <div class="stat-value" id="propertyB-price-per-sqft">$203/sqft</div>
                        <div class="stat-label">Price per Sq Ft</div>
                    </div>
                    <div style="background: rgba(236, 72, 153, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: #ec4899;">Property C</h4>
                        <div class="stat-value" id="propertyC-price-per-sqft">$207/sqft</div>
                        <div class="stat-label">Price per Sq Ft</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">🏆 Best Value Analysis</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Best Price per Sq Ft:</div>
                        <div class="details-value" id="best-price-per-sqft">Property A</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Most Bedrooms:</div>
                        <div class="details-value" id="most-bedrooms">Property C (4 bedrooms)</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Newest Property:</div>
                        <div class="details-value" id="newest-property">Property C (2020)</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Lowest HOA:</div>
                        <div class="details-value" id="lowest-hoa">Property B ($0/month)</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Recommended Choice:</div>
                        <div class="details-value" id="recommended-choice" style="font-weight: 700; color: #10b981;">Property A</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rent vs Buy Calculator -->
        <div id="rentbuy-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-home-alt"></i> Rent vs Buy Calculator</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Determine whether renting or buying makes more financial sense for your situation</p>
                
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">🏠 Buying Scenario</h3>
                <div class="form-group">
                    <label for="buy-home-price">Home Price ($)</label>
                    <input type="number" id="buy-home-price" value="400000">
                </div>
                
                <div class="form-group">
                    <label for="buy-down-payment-slider">Down Payment (%)</label>
                    <div class="slider-container">
                        <input type="range" id="buy-down-payment-slider" min="0" max="50" step="1" value="20">
                        <span id="buy-down-payment-value" class="slider-value">20%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="buy-interest-rate-slider">Interest Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="buy-interest-rate-slider" min="2" max="10" step="0.1" value="4.5">
                        <span id="buy-interest-rate-value" class="slider-value">4.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="buy-loan-term">Loan Term (years)</label>
                    <select id="buy-loan-term">
                        <option value="15">15 years</option>
                        <option value="30" selected>30 years</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="buy-property-tax">Annual Property Tax ($)</label>
                    <input type="number" id="buy-property-tax" value="4000">
                </div>
                
                <div class="form-group">
                    <label for="buy-home-insurance">Annual Home Insurance ($)</label>
                    <input type="number" id="buy-home-insurance" value="1200">
                </div>
                
                <div class="form-group">
                    <label for="buy-hoa">Monthly HOA Fees ($)</label>
                    <input type="number" id="buy-hoa" value="0">
                </div>
                
                <div class="form-group">
                    <label for="buy-maintenance-slider">Annual Maintenance (% of home value)</label>
                    <div class="slider-container">
                        <input type="range" id="buy-maintenance-slider" min="0.5" max="3" step="0.1" value="1.5">
                        <span id="buy-maintenance-value" class="slider-value">1.5%</span>
                    </div>
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: var(--secondary-color);">🏠 Renting Scenario</h3>
                <div class="form-group">
                    <label for="rent-monthly-rent">Monthly Rent ($)</label>
                    <input type="number" id="rent-monthly-rent" value="2200">
                </div>
                
                <div class="form-group">
                    <label for="rent-annual-increase-slider">Annual Rent Increase (%)</label>
                    <div class="slider-container">
                        <input type="range" id="rent-annual-increase-slider" min="0" max="8" step="0.1" value="3">
                        <span id="rent-annual-increase-value" class="slider-value">3%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="rent-security-deposit">Security Deposit ($)</label>
                    <input type="number" id="rent-security-deposit" value="2200">
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: #10b981;">💰 Investment Assumptions</h3>
                <div class="form-group">
                    <label for="investment-return-slider">Annual Investment Return (%)</label>
                    <div class="slider-container">
                        <input type="range" id="investment-return-slider" min="3" max="12" step="0.1" value="7">
                        <span id="investment-return-value" class="slider-value">7%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="home-appreciation-slider">Annual Home Appreciation (%)</label>
                    <div class="slider-container">
                        <input type="range" id="home-appreciation-slider" min="0" max="8" step="0.1" value="3">
                        <span id="home-appreciation-value" class="slider-value">3%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="analysis-period">Time Period (years)</label>
                    <select id="analysis-period">
                        <option value="3">3 years</option>
                        <option value="5" selected>5 years</option>
                        <option value="7">7 years</option>
                        <option value="10">10 years</option>
                        <option value="15">15 years</option>
                    </select>
                </div>
                
                <button id="calculate-rentbuy" class="btn-primary" style="width: 100%;">Calculate Rent vs Buy</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="rentbuy">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="rentbuy">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="rentbuy">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="rentbuy" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">🏆 Rent vs Buy Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Better Option</div>
                        <div class="stat-value" id="better-option" style="color: #10b981;">Buying</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Cost Difference</div>
                        <div class="stat-value" id="cost-difference">$45,000</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="rentbuy-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">💵 Buying Costs (5 years)</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Down Payment:</div>
                        <div class="details-value" id="buy-down-payment-total">$80,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Monthly Payment:</div>
                        <div class="details-value" id="buy-monthly-payment">$1,900</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Payments:</div>
                        <div class="details-value" id="buy-total-payments">$114,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Maintenance & Taxes:</div>
                        <div class="details-value" id="buy-maintenance-taxes">$32,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Home Value:</div>
                        <div class="details-value" id="buy-home-value">$464,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Net Cost (5 years):</div>
                        <div class="details-value" id="buy-net-cost">$162,000</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">🏠 Renting Costs (5 years)</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Initial Rent:</div>
                        <div class="details-value" id="rent-initial">$2,200</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Final Rent (Year 5):</div>
                        <div class="details-value" id="rent-final">$2,548</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Rent Paid:</div>
                        <div class="details-value" id="rent-total-paid">$141,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Security Deposit:</div>
                        <div class="details-value" id="rent-security">$2,200</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Investment Growth:</div>
                        <div class="details-value" id="rent-investment-growth">$112,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Net Cost (5 years):</div>
                        <div class="details-value" id="rent-net-cost">$31,200</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Refinancing Calculator -->
        <div id="refinance-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-redo-alt"></i> Refinancing Calculator</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Calculate refinancing savings and determine your break-even point</p>
                
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">🏠 Current Loan</h3>
                <div class="form-group">
                    <label for="refi-current-balance">Current Loan Balance ($)</label>
                    <input type="number" id="refi-current-balance" value="280000">
                </div>
                
                <div class="form-group">
                    <label for="refi-current-rate-slider">Current Interest Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="refi-current-rate-slider" min="2" max="10" step="0.1" value="5.5">
                        <span id="refi-current-rate-value" class="slider-value">5.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="refi-current-payment">Current Monthly Payment ($)</label>
                    <input type="number" id="refi-current-payment" value="1895">
                </div>
                
                <div class="form-group">
                    <label for="refi-years-remaining">Years Remaining on Current Loan</label>
                    <select id="refi-years-remaining">
                        <option value="25">25 years</option>
                        <option value="27" selected>27 years</option>
                        <option value="30">30 years</option>
                    </select>
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: var(--secondary-color);">🆕 New Loan</h3>
                <div class="form-group">
                    <label for="refi-new-rate-slider">New Interest Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="refi-new-rate-slider" min="2" max="8" step="0.1" value="4.0">
                        <span id="refi-new-rate-value" class="slider-value">4.0%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="refi-new-term">New Loan Term (years)</label>
                    <select id="refi-new-term">
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30" selected>30 years</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="refi-closing-costs">Total Closing Costs ($)</label>
                    <input type="number" id="refi-closing-costs" value="4200">
                </div>
                
                <div class="form-group">
                    <label for="refi-points-slider">Points (% of loan amount)</label>
                    <div class="slider-container">
                        <input type="range" id="refi-points-slider" min="0" max="3" step="0.125" value="0">
                        <span id="refi-points-value" class="slider-value">0%</span>
                    </div>
                </div>
                
                <button id="calculate-refinance" class="btn-primary" style="width: 100%;">Calculate Refinancing</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="refinance">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="refinance">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="refinance">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="refinance" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">💰 Refinancing Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Monthly Savings</div>
                        <div class="stat-value" id="refi-monthly-savings" style="color: #10b981;">$312</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Break-Even Period</div>
                        <div class="stat-value" id="refi-breakeven">13.5 months</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="refinance-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">💵 Payment Comparison</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Current Monthly Payment:</div>
                        <div class="details-value" id="refi-current-monthly">$1,895</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">New Monthly Payment:</div>
                        <div class="details-value" id="refi-new-monthly">$1,583</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Monthly Savings:</div>
                        <div class="details-value" id="refi-savings-monthly" style="color: #10b981;">$312</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Annual Savings:</div>
                        <div class="details-value" id="refi-savings-annual" style="color: #10b981;">$3,744</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">🎯 Break-Even Analysis</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Total Closing Costs:</div>
                        <div class="details-value" id="refi-total-costs">$4,200</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Points Cost:</div>
                        <div class="details-value" id="refi-points-cost">$0</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Upfront Cost:</div>
                        <div class="details-value" id="refi-upfront-total">$4,200</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Break-Even Time:</div>
                        <div class="details-value" id="refi-breakeven-months">13.5 months</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">5-Year Total Savings:</div>
                        <div class="details-value" id="refi-five-year-savings" style="color: #10b981;">$14,520</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HELOC Calculator -->
        <div id="heloc-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-piggy-bank"></i> HELOC Calculator</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Calculate your Home Equity Line of Credit options and monthly payments</p>
                
                <div class="form-group">
                    <label for="heloc-home-value">Current Home Value ($)</label>
                    <input type="number" id="heloc-home-value" value="500000">
                </div>
                
                <div class="form-group">
                    <label for="heloc-existing-mortgage">Existing Mortgage Balance ($)</label>
                    <input type="number" id="heloc-existing-mortgage" value="280000">
                </div>
                
                <div class="form-group">
                    <label for="heloc-ltv-slider">Max LTV Ratio (%)</label>
                    <div class="slider-container">
                        <input type="range" id="heloc-ltv-slider" min="70" max="90" step="1" value="80">
                        <span id="heloc-ltv-value" class="slider-value">80%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="heloc-credit-limit">Desired Credit Limit ($)</label>
                    <input type="number" id="heloc-credit-limit" value="150000">
                </div>
                
                <div class="form-group">
                    <label for="heloc-current-balance">Current HELOC Balance ($)</label>
                    <input type="number" id="heloc-current-balance" value="0">
                </div>
                
                <div class="form-group">
                    <label for="heloc-interest-rate-slider">Interest Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="heloc-interest-rate-slider" min="3" max="12" step="0.1" value="6.5">
                        <span id="heloc-interest-rate-value" class="slider-value">6.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="heloc-repayment-period">Repayment Period (years)</label>
                    <select id="heloc-repayment-period">
                        <option value="10">10 years</option>
                        <option value="15" selected>15 years</option>
                        <option value="20">20 years</option>
                        <option value="30">30 years</option>
                    </select>
                </div>
                
                <button id="calculate-heloc" class="btn-primary" style="width: 100%;">Calculate HELOC</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="heloc">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="heloc">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="heloc">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="heloc" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">🏦 HELOC Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Available Equity</div>
                        <div class="stat-value" id="heloc-available-equity">$220,000</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Monthly Payment</div>
                        <div class="stat-value" id="heloc-monthly-payment">$950</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="heloc-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">💰 Equity Breakdown</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Home Value:</div>
                        <div class="details-value" id="heloc-home-value-display">$500,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Existing Mortgage:</div>
                        <div class="details-value" id="heloc-existing-mortgage-display">$280,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Current Equity:</div>
                        <div class="details-value" id="heloc-current-equity">$220,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Maximum Credit Line:</div>
                        <div class="details-value" id="heloc-max-credit-line">$120,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Available to Borrow:</div>
                        <div class="details-value" id="heloc-available-borrow">$120,000</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Property Flip Calculator -->
        <div id="flip-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-hammer"></i> Property Flip Calculator</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Calculate potential profits and ROI for fix-and-flip projects</p>
                
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">🏠 Purchase Details</h3>
                <div class="form-group">
                    <label for="flip-purchase-price">Purchase Price ($)</label>
                    <input type="number" id="flip-purchase-price" value="180000">
                </div>
                
                <div class="form-group">
                    <label for="flip-closing-costs">Closing Costs ($)</label>
                    <input type="number" id="flip-closing-costs" value="3500">
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: var(--secondary-color);">🔧 Renovation Costs</h3>
                <div class="form-group">
                    <label for="flip-renovation-budget">Total Renovation Budget ($)</label>
                    <input type="number" id="flip-renovation-budget" value="45000">
                </div>
                
                <div class="form-group">
                    <label for="flip-contingency-slider">Contingency Fund (%)</label>
                    <div class="slider-container">
                        <input type="range" id="flip-contingency-slider" min="5" max="25" step="1" value="15">
                        <span id="flip-contingency-value" class="slider-value">15%</span>
                    </div>
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: #10b981;">💰 Holding & Sale</h3>
                <div class="form-group">
                    <label for="flip-holding-period">Holding Period (months)</label>
                    <select id="flip-holding-period">
                        <option value="3">3 months</option>
                        <option value="6" selected>6 months</option>
                        <option value="9">9 months</option>
                        <option value="12">12 months</option>
                        <option value="18">18 months</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="flip-carrying-costs">Monthly Carrying Costs ($)</label>
                    <input type="number" id="flip-carrying-costs" value="2200">
                </div>
                
                <div class="form-group">
                    <label for="flip-arv">After Repair Value - ARV ($)</label>
                    <input type="number" id="flip-arv" value="275000">
                </div>
                
                <div class="form-group">
                    <label for="flip-sale-costs-slider">Sale Costs (% of ARV)</label>
                    <div class="slider-container">
                        <input type="range" id="flip-sale-costs-slider" min="6" max="12" step="0.5" value="8">
                        <span id="flip-sale-costs-value" class="slider-value">8%</span>
                    </div>
                </div>
                
                <button id="calculate-flip" class="btn-primary" style="width: 100%;">Calculate Flip Profit</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="flip">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="flip">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="flip">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="flip" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">💎 Flip Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Net Profit</div>
                        <div class="stat-value" id="flip-net-profit" style="color: #10b981;">$18,700</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">ROI</div>
                        <div class="stat-value" id="flip-roi">24.8%</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="flip-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">💸 Cost Breakdown</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Purchase Price:</div>
                        <div class="details-value" id="flip-purchase-display">$180,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Renovation Costs:</div>
                        <div class="details-value" id="flip-renovation-display">$45,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Contingency Fund:</div>
                        <div class="details-value" id="flip-contingency-display">$6,750</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Carrying Costs:</div>
                        <div class="details-value" id="flip-carrying-display">$13,200</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Sale Costs:</div>
                        <div class="details-value" id="flip-sale-costs-display">$22,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Total Investment:</div>
                        <div class="details-value" id="flip-total-investment">$266,950</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Sale Price (ARV):</div>
                        <div class="details-value" id="flip-arv-display">$275,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Net Profit:</div>
                        <div class="details-value" id="flip-profit-display" style="color: #10b981;">$8,050</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BRRRR Strategy Calculator -->
        <div id="brrrr-calculator" class="calculator fade-in hidden">
            <!-- Inputs -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-sync-alt"></i> BRRRR Strategy Calculator</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Buy, Rehab, Rent, Refinance, Repeat investment analysis</p>
                
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">🏠 Buy & Rehab</h3>
                <div class="form-group">
                    <label for="brrrr-purchase-price">Purchase Price ($)</label>
                    <input type="number" id="brrrr-purchase-price" value="120000">
                </div>
                
                <div class="form-group">
                    <label for="brrrr-rehab-costs">Rehab Costs ($)</label>
                    <input type="number" id="brrrr-rehab-costs" value="25000">
                </div>
                
                <div class="form-group">
                    <label for="brrrr-closing-costs">Closing & Holding Costs ($)</label>
                    <input type="number" id="brrrr-closing-costs" value="4000">
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: var(--secondary-color);">🏠 Rent</h3>
                <div class="form-group">
                    <label for="brrrr-monthly-rent">Monthly Rent ($)</label>
                    <input type="number" id="brrrr-monthly-rent" value="1800">
                </div>
                
                <div class="form-group">
                    <label for="brrrr-expenses-slider">Monthly Expenses (% of rent)</label>
                    <div class="slider-container">
                        <input type="range" id="brrrr-expenses-slider" min="20" max="50" step="1" value="35">
                        <span id="brrrr-expenses-value" class="slider-value">35%</span>
                    </div>
                </div>
                
                <h3 style="margin: 25px 0 15px 0; color: #10b981;">💰 Refinance</h3>
                <div class="form-group">
                    <label for="brrrr-arv">After Repair Value - ARV ($)</label>
                    <input type="number" id="brrrr-arv" value="180000">
                </div>
                
                <div class="form-group">
                    <label for="brrrr-refi-ltv-slider">Refinance LTV (%)</label>
                    <div class="slider-container">
                        <input type="range" id="brrrr-refi-ltv-slider" min="70" max="80" step="1" value="75">
                        <span id="brrrr-refi-ltv-value" class="slider-value">75%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="brrrr-refi-rate-slider">Refinance Interest Rate (%)</label>
                    <div class="slider-container">
                        <input type="range" id="brrrr-refi-rate-slider" min="3" max="8" step="0.1" value="5.5">
                        <span id="brrrr-refi-rate-value" class="slider-value">5.5%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="brrrr-refi-term">Refinance Term (years)</label>
                    <select id="brrrr-refi-term">
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30" selected>30 years</option>
                    </select>
                </div>
                
                <button id="calculate-brrrr" class="btn-primary" style="width: 100%;">Calculate BRRRR</button>
                <div class="export-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                    <div class="dropdown">
                        <button class="btn-primary dropdown-btn" style="display: flex; align-items: center; gap: 5px;">
                            <i class="far fa-file-pdf"></i> Export PDF <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="#" class="export-option" data-type="pdf" data-content="current" data-source="brrrr">Current View</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="summary" data-source="brrrr">Summary Only</a>
                            <a href="#" class="export-option" data-type="pdf" data-content="full" data-source="brrrr">Full Report</a>
                        </div>
                    </div>
                    <button class="btn-green export-option" data-type="jpg" data-content="current" data-source="brrrr" style="display: flex; align-items: center; gap: 5px;">
                        <i class="far fa-file-image"></i> JPG
                    </button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <h2 class="card-title">🔄 BRRRR Analysis</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Money Left In Deal</div>
                        <div class="stat-value" id="brrrr-money-left" style="color: #10b981;">$14,000</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-label">Monthly Cash Flow</div>
                        <div class="stat-value" id="brrrr-monthly-cashflow">$542</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="brrrr-chart"></canvas>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1.125rem; font-weight: 500;">💵 Investment Summary</h3>
                <div class="details-table">
                    <div class="details-row">
                        <div class="details-label">Total Investment:</div>
                        <div class="details-value" id="brrrr-total-investment">$149,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Refinance Amount:</div>
                        <div class="details-value" id="brrrr-refi-amount">$135,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Cash Recovered:</div>
                        <div class="details-value" id="brrrr-cash-recovered">$135,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Cash Left in Deal:</div>
                        <div class="details-value" id="brrrr-cash-left">$14,000</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">New Mortgage Payment:</div>
                        <div class="details-value" id="brrrr-mortgage-payment">$1,088</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Net Cash Flow:</div>
                        <div class="details-value" id="brrrr-net-cashflow" style="color: #10b981;">$542</div>
                    </div>
                    <div class="details-row">
                        <div class="details-label">Cash-on-Cash ROI:</div>
                        <div class="details-value" id="brrrr-coc-roi" style="color: #10b981;">46.4%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    
    <script>
        // Chart variables
                    let paymentChart, amortizationChart, investmentChart, expenseChart, commissionChart, comparisonChart, closingChart, helocChart, flipChart, brrrrChart, buyerChart, rentbuyChart, reportChart;
        
        document.addEventListener('DOMContentLoaded', function() {

            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('Service Worker registered successfully');
                }).catch(function(error) {
                    console.log('Service Worker registration failed');
                });
            }

            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });

            function showInstallBanner() {
                const banner = document.getElementById('pwa-install-banner');
                const installBtn = document.getElementById('pwa-install-btn');
                const dismissBtn = document.getElementById('pwa-dismiss-btn');
                
                if (localStorage.getItem('pwa-dismissed') !== 'true') {
                    banner.style.display = 'flex';
                }

                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        deferredPrompt = null;
                        banner.style.display = 'none';
                    }
                });

                dismissBtn.addEventListener('click', () => {
                    banner.style.display = 'none';
                    localStorage.setItem('pwa-dismissed', 'true');
                });
            }

            // History & Favorites Management System
            class HistoryManager {
                constructor() {
                    this.maxHistoryItems = 100;
                    this.history = this.loadHistory();
                    this.favorites = this.loadFavorites();
                }

                loadHistory() {
                    try {
                        return JSON.parse(localStorage.getItem('calculator-history') || '[]');
                    } catch (e) {
                        return [];
                    }
                }

                loadFavorites() {
                    try {
                        return JSON.parse(localStorage.getItem('calculator-favorites') || '[]');
                    } catch (e) {
                        return [];
                    }
                }

                saveHistory() {
                    localStorage.setItem('calculator-history', JSON.stringify(this.history));
                }

                saveFavorites() {
                    localStorage.setItem('calculator-favorites', JSON.stringify(this.favorites));
                }

                addToHistory(calculatorType, inputs, results, customName = null) {
                    const historyItem = {
                        id: Date.now().toString(),
                        type: calculatorType,
                        name: customName || this.generateName(calculatorType, inputs),
                        timestamp: new Date().toISOString(),
                        inputs: inputs,
                        results: results,
                        isFavorite: false
                    };

                    // Remove oldest if we exceed max items
                    this.history.unshift(historyItem);
                    if (this.history.length > this.maxHistoryItems) {
                        this.history = this.history.slice(0, this.maxHistoryItems);
                    }

                    this.saveHistory();
                    return historyItem;
                }

                generateName(type, inputs) {
                    const names = {
                        mortgage: `$${inputs.propertyPrice?.toLocaleString() || '0'} Home`,
                        investment: `$${inputs.purchasePrice?.toLocaleString() || '0'} Investment`,
                        cashflow: `$${inputs.rentalIncome?.toLocaleString() || '0'}/mo Rental`,
                        closing: `$${inputs.salesPrice?.toLocaleString() || '0'} Closing`,
                        commission: `$${inputs.salePrice?.toLocaleString() || '0'} Commission`,
                        buyer: `$${inputs.salesPrice?.toLocaleString() || '0'} Buyer Costs`
                    };
                    return names[type] || `${type} calculation`;
                }

                toggleFavorite(id) {
                    const historyItem = this.history.find(item => item.id === id);
                    if (historyItem) {
                        historyItem.isFavorite = !historyItem.isFavorite;
                        
                        if (historyItem.isFavorite) {
                            this.favorites.push({...historyItem});
                        } else {
                            this.favorites = this.favorites.filter(fav => fav.id !== id);
                        }
                        
                        this.saveHistory();
                        this.saveFavorites();
                    }
                }

                deleteFromHistory(id) {
                    this.history = this.history.filter(item => item.id !== id);
                    this.favorites = this.favorites.filter(fav => fav.id !== id);
                    this.saveHistory();
                    this.saveFavorites();
                }

                clearHistory() {
                    this.history = [];
                    this.saveHistory();
                }

                clearFavorites() {
                    this.favorites = [];
                    this.history.forEach(item => item.isFavorite = false);
                    this.saveHistory();
                    this.saveFavorites();
                }

                loadCalculation(id) {
                    const item = this.history.find(h => h.id === id) || this.favorites.find(f => f.id === id);
                    if (item) {
                        this.populateCalculator(item.type, item.inputs);
                        showCalculator(item.type);
                    }
                }

                populateCalculator(type, inputs) {
                    // Populate form fields based on calculator type
                    Object.keys(inputs).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = inputs[key];
                            
                            // Trigger events for sliders
                            if (element.type === 'range') {
                                element.dispatchEvent(new Event('input'));
                            }
                        }
                    });
                }

                exportHistory() {
                    const data = {
                        history: this.history,
                        favorites: this.favorites,
                        exportDate: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `housemath-history-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                renderHistory() {
                    const historyList = document.getElementById('history-list');
                    
                    if (this.history.length === 0) {
                        historyList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-clock"></i>
                                <p>No calculation history yet. Start calculating to see your history here!</p>
                        </div>
                    `;
                    return;
                }

                    historyList.innerHTML = this.history.map(item => this.renderHistoryItem(item)).join('');
                }

                renderFavorites() {
                    const favoritesList = document.getElementById('favorites-list');
                    
                    if (this.favorites.length === 0) {
                        favoritesList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-star"></i>
                                <p>No favorite calculations yet. Save calculations to favorites to access them quickly!</p>
                            </div>
                        `;
                        return;
                    }

                    favoritesList.innerHTML = this.favorites.map(item => this.renderFavoriteItem(item)).join('');
                }

                renderHistoryItem(item) {
                    const date = new Date(item.timestamp).toLocaleDateString();
                    const time = new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const icon = this.getCalculatorIcon(item.type);
                    
                    return `
                        <div class="history-item" data-id="${item.id}">
                            <div class="item-header">
                                <div class="item-title">
                                    ${item.type === 'mortgage' ? 
                                        `<svg width="32" height="32" viewBox="0 0 48 48" style="margin-right: 8px; filter: drop-shadow(0 2px 6px rgba(255,255,255,0.25));">
                                            <rect x="6" y="18" width="36" height="21" fill="none" stroke="white" stroke-width="0.4" rx="2" opacity="0.3">
                                                <animate attributeName="opacity" values="0.1;0.5;0.1" dur="4s" repeatCount="indefinite"/>
                                            </rect>
                                            <path d="M24 5 L43 19 L43 40 L5 40 L5 19 Z" fill="white" stroke="white" stroke-width="1" opacity="0.95">
                                                <animate attributeName="opacity" values="0.9;1;0.9" dur="3s" repeatCount="indefinite"/>
                                            </path>
                                            <path d="M24 5 L45 20 L3 20 Z" fill="white" stroke="white" stroke-width="1.1" opacity="0.9">
                                                <animate attributeName="opacity" values="0.85;1;0.85" dur="3.5s" repeatCount="indefinite"/>
                                            </path>
                                            <path d="M24 5 L24 9 L19 12 L29 12 Z" fill="white" opacity="0.75">
                                                <animate attributeName="opacity" values="0.6;0.9;0.6" dur="2.8s" repeatCount="indefinite"/>
                                            </path>
                                            <rect x="19.5" y="27" width="9" height="13" fill="white" stroke="white" stroke-width="0.8" rx="1.2" opacity="0.85">
                                                <animate attributeName="opacity" values="0.8;1;0.8" dur="2.2s" repeatCount="indefinite"/>
                                            </rect>
                                            <rect x="18.5" y="26" width="11" height="15" fill="none" stroke="white" stroke-width="0.3" rx="1.8" opacity="0.5">
                                                <animate attributeName="opacity" values="0.3;0.7;0.3" dur="2.2s" repeatCount="indefinite"/>
                                            </rect>
                                            <circle cx="26.5" cy="33.5" r="0.9" fill="white" opacity="0.9">
                                                <animate attributeName="r" values="0.6;1.2;0.6" dur="2s" repeatCount="indefinite"/>
                                                <animate attributeName="opacity" values="0.7;1;0.7" dur="2s" repeatCount="indefinite"/>
                                            </circle>
                                            <rect x="10" y="22" width="7.5" height="7.5" fill="white" stroke="white" stroke-width="0.8" rx="1" opacity="0.8">
                                                <animate attributeName="opacity" values="0.6;1;0.6" dur="2.5s" repeatCount="indefinite"/>
                                            </rect>
                                            <line x1="13.75" y1="22" x2="13.75" y2="29.5" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <line x1="10" y1="25.75" x2="17.5" y2="25.75" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <rect x="30.5" y="22" width="7.5" height="7.5" fill="white" stroke="white" stroke-width="0.8" rx="1" opacity="0.8">
                                                <animate attributeName="opacity" values="1;0.6;1" dur="2.5s" repeatCount="indefinite"/>
                                            </rect>
                                            <line x1="34.25" y1="22" x2="34.25" y2="29.5" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <line x1="30.5" y1="25.75" x2="38" y2="25.75" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <text x="24" y="15" font-family="Arial, sans-serif" font-size="6" font-weight="bold" text-anchor="middle" fill="white" opacity="0.85">
                                                $
                                                <animate attributeName="y" values="15;11;15" dur="3s" repeatCount="indefinite"/>
                                                <animate attributeName="opacity" values="0.6;1;0.6" dur="3s" repeatCount="indefinite"/>
                                                <animate attributeName="font-size" values="5.5;7;5.5" dur="3s" repeatCount="indefinite"/>
                                            </text>
                                            <circle cx="11" cy="11" r="2.5" fill="white" opacity="0.2">
                                                <animate attributeName="opacity" values="0.1;0.35;0.1" dur="4s" repeatCount="indefinite"/>
                                                <animate attributeName="r" values="1.8;3.2;1.8" dur="4s" repeatCount="indefinite"/>
                                            </circle>
                                            <circle cx="37" cy="13" r="2" fill="white" opacity="0.18">
                                                <animate attributeName="opacity" values="0.08;0.28;0.08" dur="3.5s" repeatCount="indefinite"/>
                                                <animate attributeName="r" values="1.3;2.7;1.3" dur="3.5s" repeatCount="indefinite"/>
                                            </circle>
                                        </svg>` :
                                        `<i class="${icon}"></i>`
                                    }
                                    ${item.name}
                            </div>
                                <div class="item-date">${date} ${time}</div>
                        </div>
                            <div class="item-summary">
                                ${this.renderSummary(item)}
                    </div>
                            <div class="item-actions">
                                <button class="btn-load" onclick="historyManager.loadCalculation('${item.id}')">
                                    <i class="fas fa-play"></i> Load
                                </button>
                                <button class="${item.isFavorite ? 'btn-unfavorite' : 'btn-favorite'}" 
                                        onclick="historyManager.toggleFavorite('${item.id}'); historyManager.renderHistory();">
                                    <i class="fas fa-star"></i> ${item.isFavorite ? 'Unfavorite' : 'Favorite'}
                                </button>
                                <button class="btn-delete" onclick="historyManager.deleteFromHistory('${item.id}'); historyManager.renderHistory();">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                }

                renderFavoriteItem(item) {
                    const date = new Date(item.timestamp).toLocaleDateString();
                    const icon = this.getCalculatorIcon(item.type);
                    
                    return `
                        <div class="favorite-item" data-id="${item.id}">
                            <div class="item-header">
                                <div class="item-title">
                                    ${item.type === 'mortgage' ? 
                                        `<svg width="32" height="32" viewBox="0 0 48 48" style="margin-right: 8px; filter: drop-shadow(0 2px 6px rgba(255,255,255,0.25));">
                                            <rect x="6" y="18" width="36" height="21" fill="none" stroke="white" stroke-width="0.4" rx="2" opacity="0.3">
                                                <animate attributeName="opacity" values="0.1;0.5;0.1" dur="4s" repeatCount="indefinite"/>
                                            </rect>
                                            <path d="M24 5 L43 19 L43 40 L5 40 L5 19 Z" fill="white" stroke="white" stroke-width="1" opacity="0.95">
                                                <animate attributeName="opacity" values="0.9;1;0.9" dur="3s" repeatCount="indefinite"/>
                                            </path>
                                            <path d="M24 5 L45 20 L3 20 Z" fill="white" stroke="white" stroke-width="1.1" opacity="0.9">
                                                <animate attributeName="opacity" values="0.85;1;0.85" dur="3.5s" repeatCount="indefinite"/>
                                            </path>
                                            <path d="M24 5 L24 9 L19 12 L29 12 Z" fill="white" opacity="0.75">
                                                <animate attributeName="opacity" values="0.6;0.9;0.6" dur="2.8s" repeatCount="indefinite"/>
                                            </path>
                                            <rect x="19.5" y="27" width="9" height="13" fill="white" stroke="white" stroke-width="0.8" rx="1.2" opacity="0.85">
                                                <animate attributeName="opacity" values="0.8;1;0.8" dur="2.2s" repeatCount="indefinite"/>
                                            </rect>
                                            <rect x="18.5" y="26" width="11" height="15" fill="none" stroke="white" stroke-width="0.3" rx="1.8" opacity="0.5">
                                                <animate attributeName="opacity" values="0.3;0.7;0.3" dur="2.2s" repeatCount="indefinite"/>
                                            </rect>
                                            <circle cx="26.5" cy="33.5" r="0.9" fill="white" opacity="0.9">
                                                <animate attributeName="r" values="0.6;1.2;0.6" dur="2s" repeatCount="indefinite"/>
                                                <animate attributeName="opacity" values="0.7;1;0.7" dur="2s" repeatCount="indefinite"/>
                                            </circle>
                                            <rect x="10" y="22" width="7.5" height="7.5" fill="white" stroke="white" stroke-width="0.8" rx="1" opacity="0.8">
                                                <animate attributeName="opacity" values="0.6;1;0.6" dur="2.5s" repeatCount="indefinite"/>
                                            </rect>
                                            <line x1="13.75" y1="22" x2="13.75" y2="29.5" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <line x1="10" y1="25.75" x2="17.5" y2="25.75" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <rect x="30.5" y="22" width="7.5" height="7.5" fill="white" stroke="white" stroke-width="0.8" rx="1" opacity="0.8">
                                                <animate attributeName="opacity" values="1;0.6;1" dur="2.5s" repeatCount="indefinite"/>
                                            </rect>
                                            <line x1="34.25" y1="22" x2="34.25" y2="29.5" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <line x1="30.5" y1="25.75" x2="38" y2="25.75" stroke="white" stroke-width="0.4" opacity="0.9"/>
                                            <text x="24" y="15" font-family="Arial, sans-serif" font-size="6" font-weight="bold" text-anchor="middle" fill="white" opacity="0.85">
                                                $
                                                <animate attributeName="y" values="15;11;15" dur="3s" repeatCount="indefinite"/>
                                                <animate attributeName="opacity" values="0.6;1;0.6" dur="3s" repeatCount="indefinite"/>
                                                <animate attributeName="font-size" values="5.5;7;5.5" dur="3s" repeatCount="indefinite"/>
                                            </text>
                                            <circle cx="11" cy="11" r="2.5" fill="white" opacity="0.2">
                                                <animate attributeName="opacity" values="0.1;0.35;0.1" dur="4s" repeatCount="indefinite"/>
                                                <animate attributeName="r" values="1.8;3.2;1.8" dur="4s" repeatCount="indefinite"/>
                                            </circle>
                                            <circle cx="37" cy="13" r="2" fill="white" opacity="0.18">
                                                <animate attributeName="opacity" values="0.08;0.28;0.08" dur="3.5s" repeatCount="indefinite"/>
                                                <animate attributeName="r" values="1.3;2.7;1.3" dur="3.5s" repeatCount="indefinite"/>
                                            </circle>
                                        </svg>` :
                                        `<i class="${icon}"></i>`
                                    }
                                    ${item.name}
                                </div>
                                <div class="item-date">${date}</div>
                            </div>
                            <div class="item-summary">
                                ${this.renderSummary(item)}
                            </div>
                            <div class="item-actions">
                                <button class="btn-load" onclick="historyManager.loadCalculation('${item.id}')">
                                    <i class="fas fa-play"></i> Load
                                </button>
                                <button class="btn-unfavorite" onclick="historyManager.toggleFavorite('${item.id}'); historyManager.renderFavorites();">
                                    <i class="fas fa-star"></i> Remove
                                </button>
                            </div>
                        </div>
                    `;
                }

                getCalculatorIcon(type) {
                    const icons = {
                        mortgage: 'fas fa-home',
                        investment: 'fas fa-chart-line',
                        cashflow: 'fas fa-dollar-sign',
                        closing: 'fas fa-file-invoice-dollar',
                        commission: 'fas fa-percentage',
                        buyer: 'fas fa-user-check'
                    };
                    return icons[type] || 'fas fa-calculator';
                }

                renderSummary(item) {
                    const summaries = {
                        mortgage: `
                            <div class="summary-stat">
                                <span class="summary-label">Property Price:</span>
                                <span class="summary-value">$${item.inputs.propertyPrice?.toLocaleString() || '0'}</span>
                            </div>
                            <div class="summary-stat">
                                <span class="summary-label">Monthly Payment:</span>
                                <span class="summary-value">$${item.results.totalMonthly?.toLocaleString() || '0'}</span>
                            </div>
                        `,
                        investment: `
                            <div class="summary-stat">
                                <span class="summary-label">Purchase Price:</span>
                                <span class="summary-value">$${item.inputs.purchasePrice?.toLocaleString() || '0'}</span>
                            </div>
                            <div class="summary-stat">
                                <span class="summary-label">Cash-on-Cash ROI:</span>
                                <span class="summary-value">${item.results.cashOnCashROI || '0'}%</span>
                            </div>
                        `,
                        cashflow: `
                            <div class="summary-stat">
                                <span class="summary-label">Monthly Rent:</span>
                                <span class="summary-value">$${item.inputs.rentalIncome?.toLocaleString() || '0'}</span>
                            </div>
                            <div class="summary-stat">
                                <span class="summary-label">Net Cash Flow:</span>
                                <span class="summary-value">$${item.results.netCashFlow?.toLocaleString() || '0'}</span>
                            </div>
                        `
                    };
                    
                    return summaries[item.type] || '<div class="summary-stat"><span class="summary-label">Calculation saved</span></div>';
                }
            }

            // Initialize History Manager
            const historyManager = new HistoryManager();

            // Flag to track if calculations should be saved to history
            let shouldSaveToHistory = false;

            // Auto-save calculations when they're performed by user action
            function autoSaveCalculation(type, inputs, results) {
                if (shouldSaveToHistory) {
                    historyManager.addToHistory(type, inputs, results);
                }
            }

            // Modal Management
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    
                    // Scroll to top of modal on mobile
                    setTimeout(() => {
                        if (window.innerWidth <= 768) {
                            modal.scrollTop = 0;
                        }
                    }, 100);
                }
            }

            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }

            // Event Listeners for History & Favorites
            document.getElementById('history-btn').addEventListener('click', () => {
                historyManager.renderHistory();
                showModal('history-modal');
            });

            document.getElementById('favorites-btn').addEventListener('click', () => {
                historyManager.renderFavorites();
                showModal('favorites-modal');
            });

            // Modal Close Handlers
            document.getElementById('history-modal-close').addEventListener('click', () => {
                hideModal('history-modal');
            });

            document.getElementById('favorites-modal-close').addEventListener('click', () => {
                hideModal('favorites-modal');
            });

            // Click outside modal to close
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    hideModal('history-modal');
                    hideModal('favorites-modal');
                }
            });

            // Control Buttons
            document.getElementById('clear-history').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all calculation history?')) {
                    historyManager.clearHistory();
                    historyManager.renderHistory();
                }
            });

            document.getElementById('clear-favorites').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all favorites?')) {
                    historyManager.clearFavorites();
                    historyManager.renderFavorites();
                }
            });

            document.getElementById('export-history').addEventListener('click', () => {
                historyManager.exportHistory();
            });

            document.getElementById('export-favorites').addEventListener('click', () => {
                historyManager.exportHistory();
            });

            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'h':
                            e.preventDefault();
                            historyManager.renderHistory();
                            showModal('history-modal');
                            break;
                        case 'f':
                            e.preventDefault();
                            historyManager.renderFavorites();
                            showModal('favorites-modal');
                            break;
                    }
                }
            });

            // Real MLS API Functions
            class MLSAPIManager {
                constructor() {
                    this.cache = new Map();
                    this.cacheExpiry = 5 * 60 * 1000; // 5 minutes
                }

                async searchProperties(searchCriteria) {
                    // Check which data source to use
                    if (DATA_CONFIG.mls.bridge.enabled && DATA_CONFIG.mls.bridge.apiKey) {
                        return await this.searchBridgeAPI(searchCriteria);
                    } else if (DATA_CONFIG.mls.spark.enabled && DATA_CONFIG.mls.spark.apiKey) {
                        return await this.searchSparkAPI(searchCriteria);
                    } else if (DATA_CONFIG.alternative.rentals.rentalsApi.enabled) {
                        return await this.searchRentalsAPI(searchCriteria);
                    } else if (DATA_CONFIG.alternative.scraping.scrapingBee.enabled) {
                        return await this.searchScrapingAPI(searchCriteria);
                    } else if (DATA_CONFIG.alternative.publicRecords.enabled) {
                        return await this.searchPublicRecords(searchCriteria);
                    } else {
                        // No data sources configured
                        return [];
                    }
                }

                async searchBridgeAPI(searchCriteria) {
                    try {
                        const { searchTerm, minPrice, maxPrice, minBedrooms, minBathrooms, propertyType, status, city, state } = searchCriteria;
                        
                        // Build OData query for Bridge API
                        let filters = [];
                        
                        if (minPrice > 0) filters.push(`ListPrice ge ${minPrice}`);
                        if (maxPrice < Infinity) filters.push(`ListPrice le ${maxPrice}`);
                        if (minBedrooms > 0) filters.push(`BedroomsTotal ge ${minBedrooms}`);
                        if (minBathrooms > 0) filters.push(`BathroomsTotal ge ${minBathrooms}`);
                        if (propertyType) filters.push(`PropertyType eq '${propertyType}'`);
                        if (status !== 'all') filters.push(`StandardStatus eq '${status}'`);
                        if (city) filters.push(`City eq '${city}'`);
                        if (state) filters.push(`StateOrProvince eq '${state}'`);
                        
                        const filterQuery = filters.length > 0 ? `$filter=${filters.join(' and ')}` : '';
                        const searchQuery = searchTerm ? `$search="${searchTerm}"` : '';
                        const params = [filterQuery, searchQuery, '$top=50'].filter(p => p).join('&');
                        
                        const response = await fetch(`${DATA_CONFIG.mls.bridge.baseUrl}/Property?${params}`, {
                            headers: {
                                'Authorization': `Bearer ${DATA_CONFIG.mls.bridge.apiKey}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }

                        const data = await response.json();
                        return this.normalizeBridgeData(data.value || []);
                        
                    } catch (error) {
                        console.error('Bridge API Error:', error);
                        // Return empty array on API error
                        return [];
                    }
                }

                async searchSparkAPI(searchCriteria) {
                    try {
                        const { searchTerm, minPrice, maxPrice, minBedrooms, minBathrooms, propertyType, status } = searchCriteria;
                        
                        // Build Spark API query
                        let filters = [];
                        
                        if (minPrice > 0) filters.push(`ListPrice Ge ${minPrice}`);
                        if (maxPrice < Infinity) filters.push(`ListPrice Le ${maxPrice}`);
                        if (minBedrooms > 0) filters.push(`BedroomsTotal Ge ${minBedrooms}`);
                        if (minBathrooms > 0) filters.push(`BathroomsTotal Ge ${minBathrooms}`);
                        if (propertyType) filters.push(`PropertyType Eq '${propertyType}'`);
                        if (status !== 'all') filters.push(`MlsStatus Eq '${status}'`);
                        
                        const filterQuery = filters.length > 0 ? filters.join(' And ') : '';
                        const params = new URLSearchParams({
                            _limit: '50',
                            _filter: filterQuery
                        });

                        const response = await fetch(`${DATA_CONFIG.mls.spark.baseUrl}/listings?${params}`, {
                            headers: {
                                'X-SparkApi-User-Agent': 'HouseMath.app/1.0',
                                'Authorization': `OAuth ${DATA_CONFIG.mls.spark.apiKey}`
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`Spark API Error: ${response.status}`);
                        }

                        const data = await response.json();
                        return this.normalizeSparkData(data.D.Results || []);
                        
                    } catch (error) {
                        console.error('Spark API Error:', error);
                        // Return empty array on API error
                        return [];
                    }
                }



                normalizeBridgeData(properties) {
                    return properties.map(prop => ({
                        id: prop.ListingKey || prop.ListingId,
                        address: `${prop.UnparsedAddress || ''}, ${prop.City || ''}, ${prop.StateOrProvince || ''} ${prop.PostalCode || ''}`.trim(),
                        price: prop.ListPrice || 0,
                        bedrooms: prop.BedroomsTotal || 0,
                        bathrooms: prop.BathroomsTotal || 0,
                        sqft: prop.LivingArea || 0,
                        propertyType: this.normalizePropertyType(prop.PropertyType),
                        status: prop.StandardStatus?.toLowerCase() || 'active',
                        listDate: prop.ListingContractDate || prop.OnMarketDate,
                        photo: prop.Media?.[0]?.MediaURL || 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop',
                        propertyTax: this.estimatePropertyTax(prop.ListPrice),
                        hoa: prop.AssociationFee || 0,
                        insurance: this.estimateInsurance(prop.ListPrice),
                        estimatedRent: this.estimateRent(prop.ListPrice),
                        description: prop.PublicRemarks || 'No description available',
                        yearBuilt: prop.YearBuilt || null,
                        lotSize: prop.LotSizeAcres || 0
                    }));
                }

                normalizeSparkData(properties) {
                    return properties.map(prop => ({
                        id: prop.Id,
                        address: `${prop.Address}, ${prop.City}, ${prop.StateOrProvince} ${prop.PostalCode}`,
                        price: prop.ListPrice || 0,
                        bedrooms: prop.BedroomsTotal || 0,
                        bathrooms: prop.BathroomsTotal || 0,
                        sqft: prop.BuildingAreaTotal || 0,
                        propertyType: this.normalizePropertyType(prop.PropertyType),
                        status: prop.MlsStatus?.toLowerCase() || 'active',
                        listDate: prop.ListingContractDate,
                        photo: prop.Photos?.[0]?.Uri800 || 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop',
                        propertyTax: this.estimatePropertyTax(prop.ListPrice),
                        hoa: prop.AssociationFee || 0,
                        insurance: this.estimateInsurance(prop.ListPrice),
                        estimatedRent: this.estimateRent(prop.ListPrice),
                        description: prop.PublicRemarks || 'No description available',
                        yearBuilt: prop.YearBuilt || null,
                        lotSize: prop.LotSizeAcres || 0
                    }));
                }

                normalizePropertyType(type) {
                    if (!type) return 'single-family';
                    const normalized = type.toLowerCase();
                    if (normalized.includes('condo') || normalized.includes('condominium')) return 'condo';
                    if (normalized.includes('townhouse') || normalized.includes('townhome')) return 'townhouse';
                    return 'single-family';
                }

                estimatePropertyTax(price) {
                    return Math.round(price * 0.01); // 1% estimate
                }

                estimateInsurance(price) {
                    return Math.round(price * 0.003); // 0.3% estimate
                }

                estimateRent(price) {
                    return Math.round(price * 0.005); // 0.5% rule estimate
                }

                // Alternative Data Source Methods
                async searchRentalsAPI(searchCriteria) {
                    try {
                        const { searchTerm, minPrice, maxPrice, city, state } = searchCriteria;
                        
                        const params = new URLSearchParams({
                            'location': `${city}, ${state}` || 'Austin, TX',
                            'min_price': minPrice || 0,
                            'max_price': maxPrice || 999999,
                            'limit': 20
                        });

                        // Note: This is a conceptual example - actual API may differ
                        const response = await fetch(`${DATA_CONFIG.alternative.rentals.rentalsApi.baseUrl}/search?${params}`, {
                            headers: {
                                'Authorization': `Bearer ${DATA_CONFIG.alternative.rentals.rentalsApi.apiKey}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`Rentals API Error: ${response.status}`);
                        }

                        const data = await response.json();
                        return this.normalizeRentalsData(data.properties || []);
                        
                    } catch (error) {
                        console.error('Rentals API Error:', error);
                        return [];
                    }
                }

                async searchScrapingAPI(searchCriteria) {
                    try {
                        const { searchTerm, city, state, minPrice, maxPrice } = searchCriteria;
                        
                        // Build search URL with filters
                        let searchUrl = `https://www.zillow.com/homes/`;
                        if (city && state) {
                            searchUrl += `${city.replace(/\s+/g, '-')}-${state}_rb/`;
                        } else {
                            searchUrl += `for_sale/`;
                        }
                        
                        // Add price filters to URL
                        if (minPrice || maxPrice) {
                            const priceFilter = `${minPrice || '0'}-${maxPrice || ''}price`;
                            searchUrl += `${priceFilter}/`;
                        }
                        
                        // Build ScrapingBee API URL with parameters
                        const apiUrl = new URL(DATA_CONFIG.alternative.scraping.scrapingBee.baseUrl);
                        apiUrl.searchParams.append('api_key', DATA_CONFIG.alternative.scraping.scrapingBee.apiKey);
                        apiUrl.searchParams.append('url', searchUrl);
                        apiUrl.searchParams.append('wait', '3000'); // Wait for JavaScript to load
                        apiUrl.searchParams.append('window_width', '1920');
                        apiUrl.searchParams.append('window_height', '1080');
                        
                        // Debug logging removed for production

                        const response = await fetch(apiUrl.toString(), {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                            }
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('ScrapingBee Error Response:', errorText);
                            throw new Error(`Scraping API Error: ${response.status} - ${errorText}`);
                        }

                        const html = await response.text();
                        
                        return this.parseScrapedData(html, searchCriteria);
                        
                    } catch (error) {
                        console.error('Scraping API Error:', error);
                        return [];
                    }
                }

                async searchPublicRecords(searchCriteria) {
                    try {
                        const { city, state } = searchCriteria;
                        
                        // Example: Search county assessor records
                        const countyApi = DATA_CONFIG.alternative.publicRecords.sources[0].url;
                        const params = new URLSearchParams({
                            'city': city || 'Austin',
                            'state': state || 'TX',
                            'limit': 20
                        });

                        const response = await fetch(`${countyApi}/properties?${params}`);

                        if (!response.ok) {
                            throw new Error(`Public Records API Error: ${response.status}`);
                        }

                        const data = await response.json();
                        return this.normalizePublicRecordsData(data.records || []);
                        
                    } catch (error) {
                        console.error('Public Records API Error:', error);
                        return [];
                    }
                }

                normalizeRentalsData(properties) {
                    return properties.map(prop => ({
                        id: prop.id || `RENT_${Math.random().toString(36).substr(2, 9)}`,
                        address: prop.address || 'Address not available',
                        price: prop.rent || prop.price || 0,
                        bedrooms: prop.bedrooms || 0,
                        bathrooms: prop.bathrooms || 0,
                        sqft: prop.square_feet || prop.sqft || 0,
                        propertyType: 'rental',
                        status: 'active',
                        listDate: prop.date_listed || new Date().toISOString().split('T')[0],
                        photo: prop.photos?.[0] || 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop',
                        propertyTax: 0, // Not applicable for rentals
                        hoa: prop.hoa_fee || 0,
                        insurance: 0, // Tenant insurance separate
                        estimatedRent: prop.rent || prop.price || 0,
                        description: prop.description || 'Rental property',
                        yearBuilt: prop.year_built || null,
                        lotSize: 0
                    }));
                }

                parseScrapedData(html, searchCriteria) {
                    try {
                        
                        // Create DOM parser to work with the HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        const properties = [];
                        
                        // Try multiple selectors to find property listings
                        const selectors = [
                            'article[data-test="property-card"]', // Zillow property cards
                            '[data-testid="property-card"]', // Alternative selector
                            '.property-card', // Generic property card
                            '.ListItem', // Zillow list item
                            '[role="listitem"]' // Generic list item
                        ];
                        
                        let propertyElements = [];
                        for (const selector of selectors) {
                            propertyElements = doc.querySelectorAll(selector);
                            if (propertyElements.length > 0) {
                                break;
                            }
                        }
                        
                        // If no structured elements found, try to extract from JSON data
                        if (propertyElements.length === 0) {
                            return this.extractFromZillowJSON(html, searchCriteria);
                        }
                        
                        // Parse each property element
                        propertyElements.forEach((element, index) => {
                            try {
                                const property = this.extractPropertyFromElement(element, index);
                                if (property && property.price > 0) {
                                    properties.push(property);
                                }
                        } catch (err) {
                                // Skip invalid property elements
                            }
                        });
                        
                        return properties.slice(0, 20); // Limit to 20 properties
                        
                    } catch (error) {
                        console.error('HTML parsing error:', error);
                        // Return fallback data to help with debugging
                        return this.createFallbackData(searchCriteria);
                    }
                }

                extractPropertyFromElement(element, index) {
                    try {
                        // Extract basic property information
                        const addressElement = element.querySelector('[data-test="property-card-addr"], .property-card-addr, .address, [aria-label*="address"]');
                        const priceElement = element.querySelector('[data-test="property-card-price"], .price, [aria-label*="price"]');
                        const bedsElement = element.querySelector('[data-test="property-card-beds"], .beds, [aria-label*="bed"]');
                        const bathsElement = element.querySelector('[data-test="property-card-baths"], .baths, [aria-label*="bath"]');
                        const sqftElement = element.querySelector('[data-test="property-card-sqft"], .sqft, [aria-label*="square feet"]');
                        const imageElement = element.querySelector('img[src*="zillow"], img[alt*="property"], img');
                        
                        // Extract text content and clean it
                        const address = this.cleanText(addressElement?.textContent || '');
                        const priceText = this.cleanText(priceElement?.textContent || '');
                        const bedsText = this.cleanText(bedsElement?.textContent || '');
                        const bathsText = this.cleanText(bathsElement?.textContent || '');
                        const sqftText = this.cleanText(sqftElement?.textContent || '');
                        
                        // Parse numeric values
                        const price = this.parsePrice(priceText);
                        const bedrooms = this.parseNumber(bedsText);
                        const bathrooms = this.parseNumber(bathsText);
                        const sqft = this.parseNumber(sqftText);
                        
                        // Skip if essential data is missing
                        if (!address || !price) {
                            return null;
                        }
                        
                        return {
                            id: `SCRAPED_${Math.random().toString(36).substr(2, 9)}`,
                            address: address || 'Address not available',
                            price: price || 0,
                            bedrooms: bedrooms || 0,
                            bathrooms: bathrooms || 0,
                            sqft: sqft || 0,
                            propertyType: 'house', // Default type
                            status: 'active',
                            listDate: new Date().toISOString().split('T')[0],
                            photo: imageElement?.src || 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop',
                            propertyTax: this.estimatePropertyTax(price),
                            hoa: 0,
                            insurance: this.estimateInsurance(price),
                            estimatedRent: this.estimateRent(price),
                            description: 'Property found via web scraping',
                            yearBuilt: null,
                            lotSize: 0
                        };
                    } catch (error) {
                        return null;
                    }
                }

                extractFromZillowJSON(html, searchCriteria) {
                    try {
                        // Look for JSON data embedded in the page
                        const jsonMatches = html.match(/"searchResults":\s*{[^}]+}|"results":\s*\[[^\]]+\]|"listResults":\s*\[[^\]]+\]/g);
                        
                        if (jsonMatches) {
                            // This is a simplified approach - full implementation would be more complex
                            return this.createFallbackData(searchCriteria);
                        }
                        
                        return this.createFallbackData(searchCriteria);
                    } catch (error) {
                        return this.createFallbackData(searchCriteria);
                    }
                }

                createFallbackData(searchCriteria) {
                    // Provide helpful feedback when scraping doesn't work
                    const { city, state } = searchCriteria;
                    const location = city && state ? `${city}, ${state}` : 'your area';
                    
                    return [{
                        id: 'SCRAPING_INFO',
                        address: `Web scraping status for ${location}`,
                        price: 0,
                        bedrooms: 0,
                        bathrooms: 0,
                        sqft: 0,
                        propertyType: 'info',
                        status: 'info',
                        listDate: new Date().toISOString().split('T')[0],
                        photo: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop',
                        propertyTax: 0,
                        hoa: 0,
                        insurance: 0,
                        estimatedRent: 0,
                        description: 'ScrapingBee connected successfully, but no property listings could be extracted from the HTML. This may be due to website structure changes or anti-scraping measures. Consider using MLS or alternative data sources for reliable property data.',
                        yearBuilt: null,
                        lotSize: 0
                    }];
                }

                cleanText(text) {
                    return text ? text.trim().replace(/\s+/g, ' ') : '';
                }

                parsePrice(priceText) {
                    if (!priceText) return 0;
                    // Extract numbers from price text like "$450,000" or "$450K"
                    const match = priceText.match(/[\d,]+/);
                    if (match) {
                        let price = parseInt(match[0].replace(/,/g, ''));
                        // Handle K (thousands) and M (millions)
                        if (priceText.toLowerCase().includes('k')) {
                            price *= 1000;
                        } else if (priceText.toLowerCase().includes('m')) {
                            price *= 1000000;
                        }
                        return price;
                    }
                    return 0;
                }

                parseNumber(text) {
                    if (!text) return 0;
                    const match = text.match(/\d+(\.\d+)?/);
                    return match ? parseFloat(match[0]) : 0;
                }

                normalizePublicRecordsData(records) {
                    return records.map(record => ({
                        id: record.parcel_id || `PUBLIC_${Math.random().toString(36).substr(2, 9)}`,
                        address: record.property_address || 'Address not available',
                        price: record.assessed_value || record.market_value || 0,
                        bedrooms: record.bedrooms || 0,
                        bathrooms: record.bathrooms || 0,
                        sqft: record.living_area || record.total_area || 0,
                        propertyType: this.normalizePropertyType(record.property_type),
                        status: 'public_record',
                        listDate: record.last_sale_date || new Date().toISOString().split('T')[0],
                        photo: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop',
                        propertyTax: record.annual_tax || this.estimatePropertyTax(record.assessed_value),
                        hoa: 0,
                        insurance: this.estimateInsurance(record.assessed_value),
                        estimatedRent: this.estimateRent(record.assessed_value),
                        description: 'Public record data - may not reflect current listing status',
                        yearBuilt: record.year_built || null,
                        lotSize: record.lot_size || 0
                    }));
                }
            }











            // Add save/load functionality for calculations
            function saveCalculation(name, data) {
                try {
                    const savedCalcs = JSON.parse(localStorage.getItem('savedCalculations') || '{}');
                    savedCalcs[name] = {
                        ...data,
                        savedAt: new Date().toISOString(),
                        id: Math.random().toString(36).substr(2, 9)
                    };
                    localStorage.setItem('savedCalculations', JSON.stringify(savedCalcs));
                    alert(`✅ Calculation saved as "${name}"`);
                    return true;
                } catch (e) {
                    alert('❌ Failed to save calculation');
                    return false;
                }
            }

            function loadCalculation(name) {
                try {
                    const savedCalcs = JSON.parse(localStorage.getItem('savedCalculations') || '{}');
                    if (savedCalcs[name]) {
                        populateFormFromData(savedCalcs[name]);
                        return true;
                    }
                } catch (e) {
                    alert('❌ Failed to load calculation');
                }
                return false;
            }



            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S to save current calculation
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    const name = prompt('Save calculation as:');
                    if (name) {
                        const currentTab = document.querySelector('.tab.active')?.dataset.tab;
                        if (currentTab) {
                            const data = extractCurrentCalculationData(currentTab);
                            saveCalculation(name, data);
                        }
                    }
                }
                
                // Ctrl/Cmd + L to load calculation
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    showSavedCalculations();
                }
                
                // ESC to close any open dropdowns
                if (e.key === 'Escape') {
                    document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                        dropdown.style.display = 'none';
                    });
                }
            });

            function extractCurrentCalculationData(tabName) {
                const data = { type: tabName };
                
                // Extract form data based on current tab
                switch(tabName) {
                    case 'mortgage':
                        data.propertyPrice = document.getElementById('property-price')?.value;
                        data.downPayment = document.getElementById('down-payment-slider')?.value;
                        data.loanTerm = document.getElementById('loan-term')?.value;
                        data.interestRate = document.getElementById('interest-rate-slider')?.value;
                        data.propertyTax = document.getElementById('property-tax')?.value;
                        data.homeInsurance = document.getElementById('home-insurance')?.value;
                        data.hoa = document.getElementById('hoa')?.value;
                        break;
                    case 'investment':
                        data.purchasePrice = document.getElementById('inv-purchase-price')?.value;
                        data.annualRent = document.getElementById('annual-rent')?.value;
                        data.expenses = document.getElementById('expenses-slider')?.value;
                        data.vacancy = document.getElementById('vacancy-slider')?.value;
                        data.appreciation = document.getElementById('appreciation-slider')?.value;
                        data.holdingPeriod = document.getElementById('holding-period')?.value;
                        break;
                    case 'cashflow':
                        data.rentalIncome = document.getElementById('rental-income')?.value;
                        data.mortgagePayment = document.getElementById('mortgage-payment')?.value;
                        data.propertyTax = document.getElementById('rental-property-tax')?.value;
                        data.insurance = document.getElementById('rental-insurance')?.value;
                        break;
                    case 'commission':
                        data.salePrice = document.getElementById('sale-price')?.value;
                        data.commissionRate = document.getElementById('commission-rate-slider')?.value;
                        data.listingSplit = document.getElementById('listing-split-slider')?.value;
                        data.sellingSplit = document.getElementById('selling-split-slider')?.value;
                        data.transactionFee = document.getElementById('transaction-fee')?.value;
                        data.agentRole = document.getElementById('agent-role')?.value;
                        break;
                    case 'comparison':
                        data.propertyA = {
                            price: document.getElementById('propertyA-price')?.value,
                            sqft: document.getElementById('propertyA-sqft')?.value,
                            bedrooms: document.getElementById('propertyA-bedrooms')?.value,
                            bathrooms: document.getElementById('propertyA-bathrooms')?.value,
                            hoa: document.getElementById('propertyA-hoa')?.value,
                            year: document.getElementById('propertyA-year')?.value
                        };
                        data.propertyB = {
                            price: document.getElementById('propertyB-price')?.value,
                            sqft: document.getElementById('propertyB-sqft')?.value,
                            bedrooms: document.getElementById('propertyB-bedrooms')?.value,
                            bathrooms: document.getElementById('propertyB-bathrooms')?.value,
                            hoa: document.getElementById('propertyB-hoa')?.value,
                            year: document.getElementById('propertyB-year')?.value
                        };
                        data.propertyC = {
                            price: document.getElementById('propertyC-price')?.value,
                            sqft: document.getElementById('propertyC-sqft')?.value,
                            bedrooms: document.getElementById('propertyC-bedrooms')?.value,
                            bathrooms: document.getElementById('propertyC-bathrooms')?.value,
                            hoa: document.getElementById('propertyC-hoa')?.value,
                            year: document.getElementById('propertyC-year')?.value
                        };
                        break;
                }
                
                return data;
            }

            function populateFormFromData(data) {
                // Populate form fields based on saved data
                switch(data.type) {
                    case 'mortgage':
                        if (data.propertyPrice) document.getElementById('property-price').value = data.propertyPrice;
                        if (data.downPayment) document.getElementById('down-payment-slider').value = data.downPayment;
                        if (data.loanTerm) document.getElementById('loan-term').value = data.loanTerm;
                        if (data.interestRate) document.getElementById('interest-rate-slider').value = data.interestRate;
                        if (data.propertyTax) document.getElementById('property-tax').value = data.propertyTax;
                        if (data.homeInsurance) document.getElementById('home-insurance').value = data.homeInsurance;
                        if (data.hoa) document.getElementById('hoa').value = data.hoa;
                        break;
                }
                
                // Update slider displays and recalculate
                updateSliderDisplays();
                setTimeout(() => {
                calculateMortgage();
                calculateInvestment();
                calculateCashFlow();
                }, 100);
            }

            function updateSliderDisplays() {
                const sliders = document.querySelectorAll('input[type="range"]');
                sliders.forEach(slider => {
                    const display = document.getElementById(slider.id.replace('-slider', '-value'));
                    if (display) {
                        display.textContent = slider.value + (slider.id.includes('rate') || slider.id.includes('percent') ? '%' : '');
                    }
                });
            }

            // PWA functionality - simplified without install prompt
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Register service worker for PWA functionality
                    const swCode = `
                        const CACHE_NAME = 'housemath-v1';
                        const urlsToCache = [
                            '/',
                            '/index.html'
                        ];
                        
                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then((cache) => cache.addAll(urlsToCache))
                            );
                        });
                        
                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then((response) => {
                                        return response || fetch(event.request);
                                    }
                                )
                            );
                        });
                    `;
                    
                    const swBlob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);
                    
                    navigator.serviceWorker.register(swUrl)
                        .then(() => {
                            // Service worker registered successfully
                        })
                        .catch(() => {
                            // Service worker registration failed
                        });
                });
            }

            // Show saved calculations modal
            function showSavedCalculations() {
                try {
                    const savedCalcs = JSON.parse(localStorage.getItem('savedCalculations') || '{}');
                    const calcNames = Object.keys(savedCalcs);
                    
                    if (calcNames.length === 0) {
                        alert('📁 No saved calculations found');
                        return;
                    }
                    
                    // Create modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 10000;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        backdrop-filter: blur(5px);
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: var(--card-bg);
                        border-radius: 12px;
                        padding: 30px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        color: var(--text-color);
                        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
                    `;
                    
                    let modalHTML = `
                        <h2 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-folder-open"></i> Saved Calculations
                        </h2>
                        <div style="margin-bottom: 20px;">
                    `;
                    
                    calcNames.forEach(name => {
                        const calc = savedCalcs[name];
                        const date = new Date(calc.savedAt).toLocaleString();
                        modalHTML += `
                            <div style="padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease;" 
                                 class="saved-calc-item" data-name="${name}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 500; margin-bottom: 5px;">${name}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">${calc.type} • ${date}</div>
                                    </div>
                                    <div>
                                        <button class="load-calc-btn" data-name="${name}" style="padding: 6px 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; margin-right: 5px; cursor: pointer;">Load</button>
                                        <button class="delete-calc-btn" data-name="${name}" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    modalHTML += `
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button id="close-calc-modal" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                        </div>
                    `;
                    
                    modalContent.innerHTML = modalHTML;
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Add event listeners
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                    
                    document.getElementById('close-calc-modal').addEventListener('click', () => {
                        modal.remove();
                    });
                    
                    document.querySelectorAll('.load-calc-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const name = e.target.dataset.name;
                            if (loadCalculation(name)) {
                                modal.remove();
                            }
                        });
                    });
                    
                    document.querySelectorAll('.delete-calc-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const name = e.target.dataset.name;
                            if (confirm(`Delete calculation "${name}"?`)) {
                                try {
                                    const savedCalcs = JSON.parse(localStorage.getItem('savedCalculations') || '{}');
                                    delete savedCalcs[name];
                                    localStorage.setItem('savedCalculations', JSON.stringify(savedCalcs));
                                    modal.remove();
                                    // Refresh the modal to show updated list
                                    showSavedCalculations();
                } catch (e) {
                                    alert('❌ Failed to delete calculation');
                                }
                            }
                        });
                    });
                    
                    // Hover effects
                    document.querySelectorAll('.saved-calc-item').forEach(item => {
                        item.addEventListener('mouseenter', () => {
                            item.style.background = 'rgba(37, 99, 235, 0.1)';
                            item.style.borderColor = 'var(--primary-color)';
                        });
                        item.addEventListener('mouseleave', () => {
                            item.style.background = 'transparent';
                            item.style.borderColor = 'var(--border-color)';
                        });
                    });
                    
                } catch (e) {
                    alert('❌ Failed to load saved calculations');
                }
            }

            // Add haptic feedback for mobile
            function hapticFeedback(type = 'light') {
                if (navigator.vibrate) {
                    switch(type) {
                        case 'light': navigator.vibrate(10); break;
                        case 'medium': navigator.vibrate(20); break;
                        case 'heavy': navigator.vibrate([10, 10, 10]); break;
                    }
                }
            }

            // Enhanced mobile interactions
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    hapticFeedback('light');
                }
            });

            // Add loading states for better UX
            function showLoadingState(element, text = 'Calculating...') {
                if (element) {
                    element.disabled = true;
                    element.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
                }
            }

            function hideLoadingState(element, originalText) {
                if (element) {
                    element.disabled = false;
                    element.innerHTML = originalText;
                }
            }

            // Add input validation and formatting
            function formatCurrency(input) {
                let value = input.value.replace(/[^\d.]/g, '');
                if (value) {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        input.value = numValue.toLocaleString();
                    }
                }
            }

            function validateNumberInput(input, min = 0, max = Infinity) {
                const value = parseFloat(input.value.replace(/[^\d.]/g, ''));
                if (isNaN(value) || value < min || value > max) {
                    input.style.borderColor = '#ef4444';
                    return false;
                } else {
                    input.style.borderColor = '';
                    return true;
                }
            }

            // Add real-time input validation
            function setupInputValidation() {
                const numberInputs = document.querySelectorAll('input[type="number"]');
                
                numberInputs.forEach(input => {
                    // Add blur event for formatting
                    input.addEventListener('blur', () => {
                        if (input.id.includes('price') || input.id.includes('amount') || input.id.includes('income') || input.id.includes('payment')) {
                            const value = parseFloat(input.value.replace(/[^\d.]/g, ''));
                            if (!isNaN(value)) {
                                // Format as currency for display
                                input.dataset.rawValue = value;
                            }
                        }
                        
                        // Validate input
                        const isValid = validateNumberInput(input);
                    });
                    
                    // Add focus event to show raw value
                    input.addEventListener('focus', () => {
                        if (input.dataset.rawValue) {
                            input.value = input.dataset.rawValue;
                        }
                    });
                    
                    // Add input event for real-time feedback
                    input.addEventListener('input', () => {
                        input.style.borderColor = '';
                    });
                });
            }



            // Performance optimization: Debounce calculations
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Auto-save functionality
            function setupAutoSave() {
                const autoSaveCalc = debounce(() => {
                    const currentTab = document.querySelector('.tab.active')?.dataset.tab;
                    if (currentTab) {
                        const data = extractCurrentCalculationData(currentTab);
                        try {
                            localStorage.setItem('autoSave_' + currentTab, JSON.stringify({
                                ...data,
                                autoSavedAt: new Date().toISOString()
                            }));
                } catch (e) {
                            // localStorage not available
                        }
                    }
                }, 2000);

                // Auto-save on input changes
                document.addEventListener('input', autoSaveCalc);
                document.addEventListener('change', autoSaveCalc);
            }

            // Load auto-saved data on page load
            function loadAutoSavedData() {
                try {
                    const currentTab = document.querySelector('.tab.active')?.dataset.tab;
                    if (currentTab) {
                        const autoSaved = localStorage.getItem('autoSave_' + currentTab);
                        if (autoSaved) {
                            const data = JSON.parse(autoSaved);
                            const savedTime = new Date(data.autoSavedAt);
                            const now = new Date();
                            
                            // Only restore if saved within last 24 hours
                            if (now - savedTime < 24 * 60 * 60 * 1000) {
                                populateFormFromData(data);
                            }
                        }
                    }
                } catch (e) {
                    // Ignore errors
                }
            }

            // Add accessibility and mobile styles
            const style = document.createElement('style');
            style.textContent = `
                /* Enhanced focus styles for accessibility */
                button:focus-visible, input:focus-visible, select:focus-visible {
                    outline: 3px solid #3b82f6;
                    outline-offset: 2px;
                }
                
                /* Improved touch targets */
                @media (max-width: 768px) {
                    .tab, button, input[type="range"] {
                        min-height: 44px;
                        min-width: 44px;
                    }
                }
            `;
            document.head.appendChild(style);

            // Mobile menu variables will be initialized later in the DOM loading

            // DOM Elements
            const themeToggle = document.getElementById('theme-toggle');
            const tabs = document.querySelectorAll('.tab');
            
            // Try to use theme preference, with fallback if localStorage is unavailable
            let currentTheme = 'dark';
            try {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    document.body.classList.remove('dark');
                    currentTheme = 'light';
                }
            } catch (e) {
                // localStorage not available - just use the default theme
            }
            
            // More robust check for restricted environment
            const isRestricted = (() => {
                try {
                    // Test localStorage access
                    window.localStorage;
                    
                    // Also test cross-origin restrictions
                    try {
                        // Attempt to access parent document - will fail in restricted environments
                        if (window.parent && window.parent !== window) {
                            window.parent.document;
                        }
                        return false;
                    } catch (e) {
                        // Cross-origin restriction detected
                        return true;
                    }
                } catch (e) {
                    // localStorage restriction detected
                    return true;
                }
            })();

            // Add warning about export if in restricted environment
            if (isRestricted) {

            }
            
            // Initialize charts and calculator values after ensuring Chart.js is loaded
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    try {
                        // Disable history saving during initialization
                        shouldSaveToHistory = false;
                        
                        initializeCharts();
                        calculateMortgage();
                        calculateInvestment();
                        calculateCashFlow();
                        calculateClosing();
                        calculateBuyer();
                        calculateCommission();
                        calculateComparison();
                        calculateRentBuy();
                        calculateRefinance();
                        calculateHELOC();
                        calculateFlip();
                        calculateBRRRR();
                        generateReport();
                        
                        // Enable history saving after initialization is complete
                        setTimeout(() => {
                            shouldSaveToHistory = true;
                        }, 500);
                    } catch (error) {
                        console.error('Chart initialization error:', error);
                        // Charts failed to load, but app should still work
                        shouldSaveToHistory = true; // Enable history saving even if charts fail
                    }
                } else {
                    console.warn('Chart.js not loaded, charts will not be available');
                    shouldSaveToHistory = true; // Enable history saving even if charts aren't available
                }
            }, 100);
            
            // Theme toggle functionality
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                currentTheme = isDark ? 'dark' : 'light';
                
                // Update theme icon
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) {
                    themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
                }
                
                // Try to save to localStorage if available
                try {
                    localStorage.setItem('theme', currentTheme);
                } catch (e) {
                    // localStorage not available - just continue
                }
                
                reinitializeCharts();
                hapticFeedback('light');
            });

            // Initialize theme icon on page load
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // Settings Modal functionality
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsModalClose = document.getElementById('settings-modal-close');
            const privacyModal = document.getElementById('privacy-modal');
            const termsModal = document.getElementById('terms-modal');

            // Settings modal handlers
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    settingsModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    hapticFeedback('light');
                    
                    // Update settings form with current values
                    updateSettingsForm();
                });
            }

            if (settingsModalClose) {
                settingsModalClose.addEventListener('click', () => {
                    settingsModal.style.display = 'none';
                    document.body.style.overflow = '';
                });
            }

            // Close settings modal when clicking overlay
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) {
                        settingsModal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            }

            // Privacy Policy modal
            const privacyPolicyBtn = document.getElementById('privacy-policy-btn');
            const privacyModalClose = document.getElementById('privacy-modal-close');
            
            if (privacyPolicyBtn) {
                privacyPolicyBtn.addEventListener('click', () => {
                    privacyModal.style.display = 'flex';
                    settingsModal.style.display = 'none';
                    hapticFeedback('light');
                });
            }

            if (privacyModalClose) {
                privacyModalClose.addEventListener('click', () => {
                    privacyModal.style.display = 'none';
                    settingsModal.style.display = 'flex';
                });
            }

            // Terms of Service modal
            const termsServiceBtn = document.getElementById('terms-service-btn');
            const termsModalClose = document.getElementById('terms-modal-close');
            
            if (termsServiceBtn) {
                termsServiceBtn.addEventListener('click', () => {
                    termsModal.style.display = 'flex';
                    settingsModal.style.display = 'none';
                    hapticFeedback('light');
                });
            }

            if (termsModalClose) {
                termsModalClose.addEventListener('click', () => {
                    termsModal.style.display = 'none';
                    settingsModal.style.display = 'flex';
                });
            }

            // Settings form handlers
            function updateSettingsForm() {
                try {
                    // Theme selector
                    const themeSelector = document.getElementById('theme-selector');
                    if (themeSelector) {
                        themeSelector.value = currentTheme;
                    }

                    // Auto-save setting
                    const autoSaveEnabled = document.getElementById('auto-save-enabled');
                    if (autoSaveEnabled) {
                        const autoSaveSetting = localStorage.getItem('autoSaveEnabled') !== 'false';
                        autoSaveEnabled.checked = autoSaveSetting;
                    }

                    // Haptic feedback setting
                    const hapticEnabled = document.getElementById('haptic-feedback-enabled');
                    if (hapticEnabled) {
                        const hapticSetting = localStorage.getItem('hapticEnabled') !== 'false';
                        hapticEnabled.checked = hapticSetting;
                    }
                } catch (e) {
                    // Handle localStorage restrictions
                }
            }

            // Theme selector change handler
            const themeSelector = document.getElementById('theme-selector');
            if (themeSelector) {
                themeSelector.addEventListener('change', (e) => {
                    const selectedTheme = e.target.value;
                    
                    if (selectedTheme === 'auto') {
                        // Use system preference
                        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                        currentTheme = prefersDark ? 'dark' : 'light';
                    } else {
                        currentTheme = selectedTheme;
                    }
                    
                    // Apply theme
                    if (currentTheme === 'dark') {
                        document.body.classList.add('dark');
                    } else {
                        document.body.classList.remove('dark');
                    }
                    
                    // Update theme icon
                    const themeIcon = document.getElementById('theme-icon');
                    if (themeIcon) {
                        themeIcon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                    }
                    
                    try {
                        localStorage.setItem('theme', selectedTheme);
                    } catch (e) {
                        // Handle localStorage restrictions
                    }
                    
                    reinitializeCharts();
                    hapticFeedback('light');
                });
            }

            // Settings checkboxes
            const autoSaveCheckbox = document.getElementById('auto-save-enabled');
            const hapticCheckbox = document.getElementById('haptic-feedback-enabled');

            if (autoSaveCheckbox) {
                autoSaveCheckbox.addEventListener('change', (e) => {
                    try {
                        localStorage.setItem('autoSaveEnabled', e.target.checked);
                    } catch (err) {
                        // Handle localStorage restrictions
                    }
                    hapticFeedback('light');
                });
            }

            if (hapticCheckbox) {
                hapticCheckbox.addEventListener('change', (e) => {
                    try {
                        localStorage.setItem('hapticEnabled', e.target.checked);
                    } catch (err) {
                        // Handle localStorage restrictions
                    }
                    hapticFeedback('light');
                });
            }

            // Data usage button (placeholder)
            const dataUsageBtn = document.getElementById('data-usage-btn');
            if (dataUsageBtn) {
                dataUsageBtn.addEventListener('click', () => {
                    alert('Data Usage: All data is stored locally on your device. No data is transmitted to external servers.');
                    hapticFeedback('light');
                });
            }

            // Reset app data
            const resetAppDataBtn = document.getElementById('reset-app-data');
            if (resetAppDataBtn) {
                resetAppDataBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all app data? This will clear your history, favorites, and settings.')) {
                        try {
                            localStorage.clear();
                            location.reload();
                        } catch (e) {
                            alert('Unable to reset data in this environment.');
                        }
                    }
                });
            }

            // Export app data
            const exportAppDataBtn = document.getElementById('export-app-data');
            if (exportAppDataBtn) {
                exportAppDataBtn.addEventListener('click', () => {
                    try {
                        const data = {
                            history: JSON.parse(localStorage.getItem('calculationHistory') || '[]'),
                            favorites: JSON.parse(localStorage.getItem('favoriteCalculations') || '[]'),
                            settings: {
                                theme: localStorage.getItem('theme') || 'dark',
                                autoSave: localStorage.getItem('autoSaveEnabled') !== 'false',
                                haptic: localStorage.getItem('hapticEnabled') !== 'false'
                            }
                        };
                        
                        const dataStr = JSON.stringify(data, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `housemath-data-${new Date().toISOString().split('T')[0]}.json`;
                        link.click();
                        
                        URL.revokeObjectURL(url);
                        hapticFeedback('medium');
                    } catch (e) {
                        alert('Unable to export data in this environment.');
                    }
                });
            }

            // Save/Load button event handlers
            document.getElementById('save-calc').addEventListener('click', () => {
                hapticFeedback('light');
                const name = prompt('Save calculation as:', 'My Calculation ' + new Date().toLocaleDateString());
                if (name) {
                    const currentTab = document.querySelector('.tab.active')?.dataset.tab;
                    if (currentTab) {
                        const data = extractCurrentCalculationData(currentTab);
                        saveCalculation(name, data);
                        hapticFeedback('medium');
                    }
                }
            });

            document.getElementById('load-calc').addEventListener('click', () => {
                hapticFeedback('light');
                showSavedCalculations();
            });



            // Add some Billie-specific impressive features
            function addBillieSpecialFeatures() {
                // Secret click combo for Billie: Click title 5 times quickly
                let clickCount = 0;
                let clickTimer = null;
                
                const appTitle = document.getElementById('app-title');
                if (appTitle) {
                    appTitle.addEventListener('click', () => {
                        clickCount++;
                        
                        // Reset counter after 3 seconds of no clicks
                        if (clickTimer) {
                            clearTimeout(clickTimer);
                        }
                        
                        clickTimer = setTimeout(() => {
                            clickCount = 0;
                        }, 3000);
                        
                        // Trigger Billie mode after 5 clicks
                        if (clickCount === 5) {
                            triggerBillieMode();
                            clickCount = 0;
                            if (clickTimer) {
                                clearTimeout(clickTimer);
                            }
                        }
                    });
                }
                
                // Smart commission rate suggestions based on property value
                const commissionField = document.getElementById('commission-rate-slider');
                if (commissionField) {
                    commissionField.addEventListener('input', () => {
                        const salePrice = parseFloat(document.getElementById('sale-price')?.value || 0);
                        if (salePrice > 0) {
                            let optimalRate = 6.0; // Default rate
                            if (salePrice > 500000) optimalRate = 5.5;
                            else if (salePrice < 300000) optimalRate = 6.5;
                            
                            // Show suggestion if significantly different
                            const currentRate = parseFloat(commissionField.value);
                            if (Math.abs(currentRate - optimalRate) > 0.5) {
                                // Could add a gentle suggestion tooltip here if needed
                            }
                        }
                    });
                }
            }

            function triggerBillieMode() {
                // Special mode just for Billie!
                const billieMessages = [
                    "🏠 Billie! My interest rate in taking you out is at an all-time high! - Matthew :)  💘",
        
                ];
                
                const randomMessage = billieMessages[Math.floor(Math.random() * billieMessages.length)];
                
                // Add some sparkle effects
                const sparkles = document.createElement('div');
                sparkles.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 9999;
                `;
                
                for (let i = 0; i < 20; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.textContent = '✨';
                    sparkle.style.cssText = `
                        position: absolute;
                        font-size: 24px;
                        animation: sparkle 3s ease-out forwards;
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                    `;
                    sparkles.appendChild(sparkle);
                }
                
                const sparkleStyle = document.createElement('style');
                sparkleStyle.textContent = `
                    @keyframes sparkle {
                        0% { transform: scale(0) rotate(0deg); opacity: 1; }
                        50% { transform: scale(1) rotate(180deg); opacity: 1; }
                        100% { transform: scale(0) rotate(360deg); opacity: 0; }
                    }
                `;
                document.head.appendChild(sparkleStyle);
                document.body.appendChild(sparkles);
                
                setTimeout(() => {
                    sparkles.remove();
                    sparkleStyle.remove();
                }, 3000);
                
                // Show the message to Billie in a fun popup
                showBilliePopup(randomMessage);
                hapticFeedback('heavy');
                
                // Temporarily change the theme to something special
                document.body.style.background = 'var(--accent-color)';
                setTimeout(() => {
                    document.body.style.background = '';
                }, 5000);
            }

            function showBilliePopup(message) {
                // Create the popup overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(10px);
                    z-index: 15000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    animation: fadeIn 0.3s ease;
                `;

                // Create the popup content
                const popup = document.createElement('div');
                popup.style.cssText = `
                    background: linear-gradient(135deg, #3b82f6, #60a5fa);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(255, 107, 107, 0.3);
                    border: 3px solid rgba(255, 255, 255, 0.3);
                    position: relative;
                    animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    color: white;
                    font-family: 'Poppins', sans-serif;
                `;

                // Add floating hearts
                const heartsContainer = document.createElement('div');
                heartsContainer.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    overflow: hidden;
                    border-radius: 20px;
                `;

                for (let i = 0; i < 15; i++) {
                    const heart = document.createElement('div');
                    heart.textContent = '💖';
                    heart.style.cssText = `
                        position: absolute;
                        font-size: ${Math.random() * 20 + 15}px;
                        animation: floatHearts ${Math.random() * 3 + 2}s ease-in-out infinite;
                        animation-delay: ${Math.random() * 2}s;
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        opacity: 0.7;
                    `;
                    heartsContainer.appendChild(heart);
                }

                popup.appendChild(heartsContainer);

                // Add the message
                const messageElement = document.createElement('div');
                messageElement.style.cssText = `
                    font-size: 1.5rem;
                    font-weight: 600;
                    margin-bottom: 20px;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                    line-height: 1.4;
                    position: relative;
                    z-index: 1;
                `;
                messageElement.textContent = message;
                popup.appendChild(messageElement);

                // Add tap instruction with countdown
                const tapInstruction = document.createElement('div');
                tapInstruction.style.cssText = `
                    font-size: 1rem;
                    opacity: 0.9;
                    margin-top: 20px;
                    animation: pulse 2s infinite;
                    position: relative;
                    z-index: 1;
                `;
                tapInstruction.textContent = '💕 Please wait... 5 💕';
                popup.appendChild(tapInstruction);

                overlay.appendChild(popup);

                // Add animations
                const animationStyles = document.createElement('style');
                animationStyles.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes popIn {
                        0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
                        50% { transform: scale(1.1) rotate(5deg); }
                        100% { transform: scale(1) rotate(0deg); opacity: 1; }
                    }
                    @keyframes floatHearts {
                        0%, 100% { transform: translateY(0px) rotate(0deg); }
                        25% { transform: translateY(-10px) rotate(5deg); }
                        50% { transform: translateY(-20px) rotate(-5deg); }
                        75% { transform: translateY(-5px) rotate(3deg); }
                    }
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                    }
                `;
                document.head.appendChild(animationStyles);

                // Add to page
                document.body.appendChild(overlay);

                // Add fadeOut animation
                const fadeOutStyle = document.createElement('style');
                fadeOutStyle.textContent = `
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(fadeOutStyle);

                // Prevent scrolling while popup is open
                document.body.style.overflow = 'hidden';

                // Countdown timer and delayed close functionality
                let countdown = 5;
                let canClose = false;
                
                const countdownTimer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        tapInstruction.textContent = `💕 Please wait... ${countdown} 💕`;
                    } else {
                        clearInterval(countdownTimer);
                        canClose = true;
                        tapInstruction.textContent = '💕 Tap anywhere to close 💕';
                        // Add a visual indicator that it's now clickable
                        tapInstruction.style.animation = 'pulse 1s infinite';
                        tapInstruction.style.transform = 'scale(1.1)';
                    }
                }, 1000);

                // Close when clicked/tapped (only after 5 seconds)
                const closeHandler = () => {
                    if (canClose) {
                        overlay.removeEventListener('click', closeHandler);
                        overlay.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => {
                            overlay.remove();
                            animationStyles.remove();
                            fadeOutStyle.remove();
                            document.body.style.overflow = '';
                        }, 300);
                    }
                };
                
                overlay.addEventListener('click', closeHandler);
            }

            // Initialize special features
            addBillieSpecialFeatures();
            
            // Logo click handlers to go to dashboard
            const headerLogo = document.getElementById('header-logo');
            const appTitle = document.getElementById('app-title');
            
            function goToDashboard() {
                // Remove active class from all tabs (desktop and mobile)
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(t => t.classList.remove('active'));
                const mobileTabs = document.querySelectorAll('.mobile-tab');
                mobileTabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to home/dashboard tab
                const homeTab = document.querySelector('.tab[data-tab="home"]');
                const homeMobileTab = document.querySelector('.mobile-tab[data-tab="home"]');
                if (homeTab) homeTab.classList.add('active');
                if (homeMobileTab) homeMobileTab.classList.add('active');
                
                // Hide all calculators and show dashboard
                const calculators = [
                    'home', 'mortgage', 'investment', 'cashflow', 'closing', 'buyer', 
                    'commission', 'comparison', 'rentbuy', 'refinance', 'heloc', 
                    'flip', 'brrrr', 'report'
                ];
                calculators.forEach(calc => {
                    const element = document.getElementById(`${calc}-calculator`);
                    if (element) element.classList.add('hidden');
                });
                
                const homeCalculator = document.getElementById('home-calculator');
                if (homeCalculator) {
                    homeCalculator.classList.remove('hidden');
                }
                
                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Add visual feedback
                hapticFeedback('light');
            }
            
            if (headerLogo) {
                headerLogo.addEventListener('click', goToDashboard);
                headerLogo.addEventListener('mouseenter', () => {
                    headerLogo.style.transform = 'scale(1.05)';
                });
                headerLogo.addEventListener('mouseleave', () => {
                    headerLogo.style.transform = 'scale(1)';
                });
            }
            
            if (appTitle) {
                appTitle.addEventListener('click', goToDashboard);
                appTitle.addEventListener('mouseenter', () => {
                    appTitle.style.opacity = '0.8';
                    appTitle.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                });
                appTitle.addEventListener('mouseleave', () => {
                    appTitle.style.opacity = '1';
                    appTitle.style.backgroundColor = 'transparent';
                });
            }
            
            // Tab switching functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs (both desktop and mobile)
                    tabs.forEach(t => t.classList.remove('active'));
                    const mobileTabs = document.querySelectorAll('.mobile-tab');
                    mobileTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Also update mobile tab
                    const tabId = tab.getAttribute('data-tab');
                    const matchingMobileTab = document.querySelector(`.mobile-tab[data-tab="${tabId}"]`);
                    if (matchingMobileTab) {
                        matchingMobileTab.classList.add('active');
                    }
                    
                    // Hide all calculators including home
                    const calculators = ['home', 'mortgage', 'investment', 'cashflow', 'closing', 'buyer', 'commission', 'comparison', 'rentbuy', 'refinance', 'heloc', 'flip', 'brrrr', 'report'];
                    calculators.forEach(calc => {
                        const element = document.getElementById(`${calc}-calculator`);
                        if (element) element.classList.add('hidden');
                    });
                    
                    // Show the selected calculator
                    const selectedCalculator = document.getElementById(`${tabId}-calculator`);
                    if (selectedCalculator) {
                        selectedCalculator.classList.remove('hidden');
                    }
                    
                    // Always scroll to top when switching calculators
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    hapticFeedback('light');
                });
            });

            // Set first tab as active by default
            if (tabs.length > 0) {
                tabs[0].classList.add('active');
            }
            
            // Dashboard calculator card navigation
            const calculatorCards = document.querySelectorAll('.calculator-card');
            calculatorCards.forEach(card => {
                card.addEventListener('click', () => {
                    const calculatorType = card.getAttribute('data-calculator');
                    
                    // Update tabs
                    const tabs = document.querySelectorAll('.tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    const mobileTabs = document.querySelectorAll('.mobile-tab');
                    mobileTabs.forEach(t => t.classList.remove('active'));
                    
                    // Activate the appropriate tab
                    const targetTab = document.querySelector(`.tab[data-tab="${calculatorType}"]`);
                    const targetMobileTab = document.querySelector(`.mobile-tab[data-tab="${calculatorType}"]`);
                    
                    if (targetTab) targetTab.classList.add('active');
                    if (targetMobileTab) targetMobileTab.classList.add('active');
                    
                    // Hide all calculators including home
                    const calculators = ['home', 'mortgage', 'investment', 'cashflow', 'closing', 'buyer', 'commission', 'comparison', 'rentbuy', 'refinance', 'heloc', 'flip', 'brrrr', 'report'];
                    calculators.forEach(calc => {
                        const element = document.getElementById(`${calc}-calculator`);
                        if (element) element.classList.add('hidden');
                    });
                    
                    // Show the selected calculator
                    const selectedCalculator = document.getElementById(`${calculatorType}-calculator`);
                    if (selectedCalculator) {
                        selectedCalculator.classList.remove('hidden');
                    }
                    
                    // Always scroll to top when switching calculators
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    hapticFeedback('medium');
                });
            });
            
            // Slider value displays
            const sliders = [
                { slider: 'down-payment-slider', display: 'down-payment-value', suffix: '%' },
                { slider: 'interest-rate-slider', display: 'interest-rate-value', suffix: '%' },
                { slider: 'expenses-slider', display: 'expenses-value', suffix: '%' },
                { slider: 'vacancy-slider', display: 'vacancy-value', suffix: '%' },
                { slider: 'appreciation-slider', display: 'appreciation-value', suffix: '%' },
                { slider: 'management-slider', display: 'management-value', suffix: '%' },
                { slider: 'maintenance-slider', display: 'maintenance-value', suffix: '%' },
                { slider: 'commission-rate-slider', display: 'commission-rate-display', suffix: '%' },
                { slider: 'listing-split-slider', display: 'listing-split-display', suffix: '%' },
                { slider: 'selling-split-slider', display: 'selling-split-display', suffix: '%' },
                // Rent vs Buy sliders
                { slider: 'buy-down-payment-slider', display: 'buy-down-payment-value', suffix: '%' },
                { slider: 'buy-interest-rate-slider', display: 'buy-interest-rate-value', suffix: '%' },
                { slider: 'buy-maintenance-slider', display: 'buy-maintenance-value', suffix: '%' },
                { slider: 'rent-annual-increase-slider', display: 'rent-annual-increase-value', suffix: '%' },
                { slider: 'investment-return-slider', display: 'investment-return-value', suffix: '%' },
                { slider: 'home-appreciation-slider', display: 'home-appreciation-value', suffix: '%' },
                // Refinancing sliders
                { slider: 'refi-current-rate-slider', display: 'refi-current-rate-value', suffix: '%' },
                { slider: 'refi-new-rate-slider', display: 'refi-new-rate-value', suffix: '%' },
                { slider: 'refi-points-slider', display: 'refi-points-value', suffix: '%' },
                // HELOC sliders
                { slider: 'heloc-ltv-slider', display: 'heloc-ltv-value', suffix: '%' },
                { slider: 'heloc-interest-rate-slider', display: 'heloc-interest-rate-value', suffix: '%' },
                // Property Flip sliders
                { slider: 'flip-contingency-slider', display: 'flip-contingency-value', suffix: '%' },
                { slider: 'flip-sale-costs-slider', display: 'flip-sale-costs-value', suffix: '%' },
                // BRRRR sliders
                { slider: 'brrrr-expenses-slider', display: 'brrrr-expenses-value', suffix: '%' },
                { slider: 'brrrr-refi-ltv-slider', display: 'brrrr-refi-ltv-value', suffix: '%' },
                { slider: 'brrrr-refi-rate-slider', display: 'brrrr-refi-rate-value', suffix: '%' }
            ];
            
            sliders.forEach(item => {
                const slider = document.getElementById(item.slider);
                const display = document.getElementById(item.display);
                
                if (slider && display) {
                    // Set initial value
                    display.textContent = slider.value + item.suffix;
                    
                    // Update value on slider change
                    slider.addEventListener('input', () => {
                        display.textContent = slider.value + item.suffix;
                    });
                }
            });
            
            // Calculator button event listeners
            document.getElementById('calculate-mortgage').addEventListener('click', calculateMortgage);
            document.getElementById('calculate-investment').addEventListener('click', calculateInvestment);
            document.getElementById('calculate-cashflow').addEventListener('click', calculateCashFlow);
            document.getElementById('calculate-closing').addEventListener('click', calculateClosing);
            document.getElementById('calculate-buyer').addEventListener('click', calculateBuyer);
            document.getElementById('calculate-commission').addEventListener('click', calculateCommission);
            document.getElementById('calculate-comparison').addEventListener('click', calculateComparison);
            document.getElementById('calculate-rentbuy').addEventListener('click', calculateRentBuy);
            document.getElementById('calculate-refinance').addEventListener('click', calculateRefinance);
            document.getElementById('calculate-heloc').addEventListener('click', calculateHELOC);
            document.getElementById('calculate-flip').addEventListener('click', calculateFlip);
            document.getElementById('calculate-brrrr').addEventListener('click', calculateBRRRR);
            document.getElementById('generate-report').addEventListener('click', generateReport);

            
            // Initialize charts
            function initializeCharts() {
                try {
                    // Theme-aware colors
                    const isDark = document.body.classList.contains('dark');
                    const textColor = isDark ? '#f9fafb' : '#1f2937';
                    const gridColor = isDark ? '#374151' : '#e5e7eb';
                
                // Default options for line/bar charts
                const defaultOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    }
                };
                
                // Default options for pie/doughnut charts
                const pieOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor
                            }
                        }
                    }
                };
                
                // Payment Breakdown Chart
                const paymentCtx = document.getElementById('payment-chart').getContext('2d');
                paymentChart = new Chart(paymentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Principal & Interest', 'Property Tax', 'Insurance', 'HOA'],
                        datasets: [{
                            data: [1425, 292, 100, 0],
                            backgroundColor: ['#3b82f6', '#7c3aed', '#ec4899', '#10b981']
                        }]
                    },
                    options: pieOptions
                });
                
                // Amortization Chart
                const amortizationCtx = document.getElementById('amortization-chart').getContext('2d');
                amortizationChart = new Chart(amortizationCtx, {
                    type: 'line',
                    data: {
                        labels: ['Year 5', 'Year 10', 'Year 15', 'Year 20', 'Year 25', 'Year 30'],
                        datasets: [
                            {
                                label: 'Principal',
                                data: [38000, 83000, 138000, 204000, 280000],
                                borderColor: '#3b82f6',
                                backgroundColor: '#3b82f6',
                                tension: 0.1
                            },
                            {
                                label: 'Interest',
                                data: [62000, 105000, 137000, 156000, 0],
                                borderColor: '#7c3aed',
                                backgroundColor: '#7c3aed',
                                tension: 0.1
                            }
                        ]
                    },
                    options: defaultOptions
                });
                
                // Investment Chart
                const investmentCtx = document.getElementById('investment-chart').getContext('2d');
                investmentChart = new Chart(investmentCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Year 0', 'Year 2', 'Year 4', 'Year 6', 'Year 8', 'Year 10'],
                        datasets: [
                            {
                                label: 'Property Value',
                                data: [300000, 321368, 344257, 368777, 395043, 423180],
                                backgroundColor: '#3b82f6'
                            },
                            {
                                label: 'Cumulative Cash Flow',
                                data: [0, 31824, 66211, 103288, 143195, 186095],
                                backgroundColor: '#10b981'
                            }
                        ]
                    },
                    options: defaultOptions
                });
                
                // Commission Chart
                const commissionCtx = document.getElementById('commission-chart').getContext('2d');
                commissionChart = new Chart(commissionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Your Net Commission', 'Brokerage Fees', 'Other Agent Commission'],
                        datasets: [{
                            data: [18505, 395, 8100],
                            backgroundColor: ['#10b981', '#f59e0b', '#6b7280']
                        }]
                    },
                    options: pieOptions
                });
                
                // Property Comparison Chart
                const comparisonCtx = document.getElementById('comparison-chart').getContext('2d');
                comparisonChart = new Chart(comparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Property A', 'Property B', 'Property C'],
                        datasets: [
                            {
                                label: 'Price ($)',
                                data: [425000, 395000, 475000],
                                backgroundColor: '#3b82f6',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Price per Sq Ft ($)',
                                data: [202, 203, 207],
                                backgroundColor: '#10b981',
                                type: 'line',
                                borderColor: '#10b981',
                                borderWidth: 3,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: gridColor
                                },
                                ticks: {
                                    color: textColor
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: {
                                    color: gridColor
                                },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        return '$' + value + '/sqft';
                                    }
                                }
                            }
                        }
                    }
                });

                // Cash Flow Chart (Expense Breakdown)
                const cashflowCtx = document.getElementById('cashflow-chart').getContext('2d');
                expenseChart = new Chart(cashflowCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Net Cash Flow', 'Mortgage Payment', 'Property Tax', 'Insurance', 'Management', 'Maintenance', 'Vacancy Reserve'],
                        datasets: [{
                            data: [650, 1000, 150, 100, 200, 100, 100],
                            backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280']
                        }]
                    },
                    options: pieOptions
                });

                // Closing Costs Chart
                const closingCtx = document.getElementById('closing-chart').getContext('2d');
                closingChart = new Chart(closingCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Title Insurance', 'Attorney Fees', 'Recording Fees', 'Transfer Tax', 'Inspection', 'Survey', 'Other'],
                        datasets: [{
                            label: 'Costs ($)',
                            data: [1200, 800, 150, 2100, 400, 300, 500],
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6b7280']
                        }]
                    },
                    options: defaultOptions
                });

                // HELOC Chart
                const helocCtx = document.getElementById('heloc-chart').getContext('2d');
                helocChart = new Chart(helocCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Available Equity', 'Existing Mortgage', 'HELOC Balance'],
                        datasets: [{
                            data: [220000, 280000, 0],
                            backgroundColor: ['#10b981', '#ef4444', '#f59e0b']
                        }]
                    },
                    options: pieOptions
                });

                // Property Flip Chart
                const flipCtx = document.getElementById('flip-chart').getContext('2d');
                flipChart = new Chart(flipCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Purchase', 'Renovation', 'Contingency', 'Carrying', 'Sale Costs', 'Net Profit'],
                        datasets: [{
                            label: 'Amount ($)',
                            data: [180000, 45000, 6750, 13200, 22000, 8050],
                            backgroundColor: ['#ef4444', '#f59e0b', '#f97316', '#ec4899', '#8b5cf6', '#10b981']
                        }]
                    },
                    options: defaultOptions
                });

                // BRRRR Strategy Chart
                const brrrrCtx = document.getElementById('brrrr-chart').getContext('2d');
                brrrrChart = new Chart(brrrrCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Purchase', 'Rehab', 'Closing', 'Refinance', 'Cash Left', 'Monthly Flow'],
                        datasets: [{
                            label: 'Amount ($)',
                            data: [120000, 25000, 4000, -135000, 14000, 542],
                            backgroundColor: ['#ef4444', '#f59e0b', '#f97316', '#3b82f6', '#10b981', '#06b6d4']
                        }]
                    },
                    options: defaultOptions
                });

                // Buyer Cost Chart
                const buyerCtx = document.getElementById('buyer-chart').getContext('2d');
                buyerChart = new Chart(buyerCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Down Payment', 'Points Cost', 'Prepaid Interest', 'Other Costs'],
                        datasets: [{
                            data: [50000, 2500, 800, 2500],
                            backgroundColor: ['#3b82f6', '#7c3aed', '#ec4899', '#f59e0b']
                        }]
                    },
                    options: pieOptions
                });

                // Rent vs Buy Chart
                const rentbuyCtx = document.getElementById('rentbuy-chart').getContext('2d');
                rentbuyChart = new Chart(rentbuyCtx, {
                    type: 'line',
                    data: {
                        labels: ['Year 1', 'Year 3', 'Year 5', 'Year 7', 'Year 10'],
                        datasets: [
                            {
                                label: 'Total Cost of Renting',
                                data: [24000, 75000, 130000, 188000, 275000],
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Total Cost of Buying',
                                data: [75000, 95000, 118000, 142000, 185000],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.1,
                                fill: false
                            }
                        ]
                    },
                    options: defaultOptions
                });

                // Generated Report Chart
                const reportCtx = document.getElementById('report-chart').getContext('2d');
                reportChart = new Chart(reportCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Monthly Payment', 'Cash Flow', 'ROI', 'Total Investment'],
                        datasets: [{
                            label: 'Financial Overview ($)',
                            data: [2500, 650, 8500, 75000],
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#7c3aed']
                        }]
                    },
                    options: defaultOptions
                });
                } catch (error) {
                    console.error('Chart initialization failed:', error);
                    // Individual chart errors won't break the entire app
                }
            }
            
            // Reinitialize charts when theme changes
            function reinitializeCharts() {
                // Temporarily disable history saving during chart reinitialization
                const originalSaveState = shouldSaveToHistory;
                shouldSaveToHistory = false;
                
                // Destroy existing charts
                if (paymentChart) paymentChart.destroy();
                if (amortizationChart) amortizationChart.destroy();
                if (investmentChart) investmentChart.destroy();
                if (expenseChart) expenseChart.destroy();
                if (commissionChart) commissionChart.destroy();
                if (comparisonChart) comparisonChart.destroy();
                if (closingChart) closingChart.destroy();
                if (helocChart) helocChart.destroy();
                if (flipChart) flipChart.destroy();
                if (brrrrChart) brrrrChart.destroy();
                if (buyerChart) buyerChart.destroy();
                if (rentbuyChart) rentbuyChart.destroy();
                if (reportChart) reportChart.destroy();
                
                // Initialize new charts
                initializeCharts();
                
                // Update charts with current data
                calculateMortgage();
                calculateInvestment();
                calculateCashFlow();
                calculateClosing();
                calculateBuyer();
                calculateCommission();
                calculateComparison();
                calculateRentBuy();
                calculateHELOC();
                calculateFlip();
                calculateBRRRR();
                generateReport();
                
                // Restore history saving state
                shouldSaveToHistory = originalSaveState;
            }
            
            // Calculate mortgage
            function calculateMortgage() {
                try {
                    // Get input values with validation
                    const propertyPrice = parseFloat(document.getElementById('property-price').value) || 0;
                    const downPaymentPercent = parseFloat(document.getElementById('down-payment-slider').value) || 0;
                    const loanTerm = parseInt(document.getElementById('loan-term').value) || 30;
                    const interestRate = parseFloat(document.getElementById('interest-rate-slider').value) || 0;
                    const propertyTax = parseFloat(document.getElementById('property-tax').value) || 0;
                    const homeInsurance = parseFloat(document.getElementById('home-insurance').value) || 0;
                    const hoa = parseFloat(document.getElementById('hoa').value) || 0;
                    
                    // Validate inputs
                    if (propertyPrice <= 0 || interestRate < 0 || downPaymentPercent < 0 || downPaymentPercent > 100) {
                        return;
                    }
                
                // Calculate loan details
                const downPayment = propertyPrice * (downPaymentPercent / 100);
                const loanAmount = propertyPrice - downPayment;
                const monthlyInterestRate = interestRate / 100 / 12;
                const numberOfPayments = loanTerm * 12;
                
                // Calculate monthly principal and interest payment
                const monthlyPayment = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                    (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
                
                // Calculate total payment with taxes and insurance
                const monthlyPropertyTax = propertyTax / 12;
                const monthlyInsurance = homeInsurance / 12;
                const totalMonthlyPayment = monthlyPayment + monthlyPropertyTax + monthlyInsurance + hoa;
                
                // Calculate total interest over life of loan
                const totalInterest = (monthlyPayment * numberOfPayments) - loanAmount;
                
                // Update DOM elements
                document.getElementById('principal-interest').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
                document.getElementById('total-monthly').textContent = '$' + Math.round(totalMonthlyPayment).toLocaleString();
                document.getElementById('loan-amount').textContent = '$' + Math.round(loanAmount).toLocaleString();
                document.getElementById('down-payment-amount').textContent = '$' + Math.round(downPayment).toLocaleString();
                document.getElementById('total-interest').textContent = '$' + Math.round(totalInterest).toLocaleString();
                document.getElementById('total-cost').textContent = '$' + Math.round(propertyPrice + totalInterest).toLocaleString();
                
                // Update payment breakdown chart
                if (paymentChart) {
                    paymentChart.data.datasets[0].data = [
                        Math.round(monthlyPayment), 
                        Math.round(monthlyPropertyTax), 
                        Math.round(monthlyInsurance), 
                        Math.round(hoa)
                    ];
                    paymentChart.update();
                }
                
                // Update amortization chart
                if (amortizationChart) {
                    // Calculate amortization schedule for key years
                    const years = loanTerm > 15 ? [5, 10, 15, 20, 25, 30].filter(y => y <= loanTerm) : [Math.round(loanTerm/3), Math.round(2*loanTerm/3), loanTerm];
                    const principalPaid = [];
                    const interestPaid = [];
                    
                    years.forEach(year => {
                        const monthsPaid = year * 12;
                        let remainingBalance = loanAmount;
                        let totalInterestPaid = 0;
                        
                        for (let i = 1; i <= monthsPaid; i++) {
                            const interestPayment = remainingBalance * monthlyInterestRate;
                            const principalPayment = monthlyPayment - interestPayment;
                            
                            remainingBalance -= principalPayment;
                            totalInterestPaid += interestPayment;
                        }
                        
                        principalPaid.push(Math.round(loanAmount - remainingBalance));
                        interestPaid.push(Math.round(totalInterestPaid));
                    });
                    
                    // Update chart data
                    amortizationChart.data.labels = years.map(year => `Year ${year}`);
                    amortizationChart.data.datasets[0].data = principalPaid;
                    amortizationChart.data.datasets[1].data = interestPaid;
                    amortizationChart.update();
                }
                
                // Auto-scroll to results on mobile devices
                autoScrollToResults('mortgage');

                // Auto-save to history
                autoSaveCalculation('mortgage', {
                    propertyPrice: propertyPrice,
                    downPaymentPercent: downPaymentPercent,
                    loanTerm: loanTerm,
                    interestRate: interestRate,
                    propertyTax: propertyTax,
                    homeInsurance: homeInsurance,
                    hoa: hoa
                }, {
                    totalMonthly: Math.round(totalMonthlyPayment),
                    principalInterest: Math.round(monthlyPayment),
                    loanAmount: Math.round(loanAmount),
                    totalInterest: Math.round(totalInterest)
                });
                } catch (error) {
                    // Handle calculation errors gracefully
                }
            }
            
            // Calculate investment returns
            function calculateInvestment() {
                try {
                    // Get input values with validation
                    const purchasePrice = parseFloat(document.getElementById('inv-purchase-price').value) || 0;
                    const annualRent = parseFloat(document.getElementById('annual-rent').value) || 0;
                    const expensesPercent = parseFloat(document.getElementById('expenses-slider').value) || 0;
                    const vacancyRate = parseFloat(document.getElementById('vacancy-slider').value) || 0;
                    const appreciationRate = parseFloat(document.getElementById('appreciation-slider').value) || 0;
                    const holdingPeriod = parseInt(document.getElementById('holding-period').value) || 10;
                    
                    // Validate inputs
                    if (purchasePrice <= 0 || annualRent < 0) {
                        return;
                    }
                
                // Calculate investment metrics
                const monthlyRent = annualRent / 12;
                const effectiveAnnualRent = annualRent * (1 - vacancyRate / 100);
                const annualExpenses = effectiveAnnualRent * (expensesPercent / 100);
                const annualCashFlow = effectiveAnnualRent - annualExpenses;
                const monthlyCashFlow = annualCashFlow / 12;
                
                // Assume 25% down payment for cash-on-cash ROI calculation
                const downPayment = purchasePrice * 0.25;
                const cashOnCashROI = (annualCashFlow / downPayment) * 100;
                
                // Cap rate calculation (NOI / Purchase Price)
                const netOperatingIncome = effectiveAnnualRent - annualExpenses;
                const capRate = (netOperatingIncome / purchasePrice) * 100;
                
                // Update DOM elements
                document.getElementById('monthly-rent').textContent = '$' + Math.round(monthlyRent).toLocaleString();
                document.getElementById('monthly-expenses').textContent = '$' + Math.round(annualExpenses / 12).toLocaleString();
                document.getElementById('monthly-cashflow').textContent = '$' + Math.round(monthlyCashFlow).toLocaleString();
                document.getElementById('annual-cashflow').textContent = '$' + Math.round(annualCashFlow).toLocaleString();
                document.getElementById('cash-on-cash').textContent = cashOnCashROI.toFixed(1) + '%';
                document.getElementById('cap-rate').textContent = capRate.toFixed(1) + '%';
                document.getElementById('period-label').textContent = holdingPeriod;
                
                // Future value calculations
                const futurePropertyValue = purchasePrice * Math.pow(1 + appreciationRate / 100, holdingPeriod);
                const totalRentalIncome = annualCashFlow * holdingPeriod;
                const totalReturn = (futurePropertyValue - purchasePrice) + totalRentalIncome;
                const annualizedReturn = (Math.pow(1 + totalReturn / downPayment, 1 / holdingPeriod) - 1) * 100;
                
                document.getElementById('future-property-value').textContent = '$' + Math.round(futurePropertyValue).toLocaleString();
                document.getElementById('total-rental-income').textContent = '$' + Math.round(totalRentalIncome).toLocaleString();
                document.getElementById('total-return').textContent = '$' + Math.round(totalReturn).toLocaleString();
                document.getElementById('annualized-return').textContent = annualizedReturn.toFixed(1) + '%';
                
                // Update investment chart
                if (investmentChart) {
                    // Select appropriate year markers based on holding period
                    const yearSpacing = Math.max(1, Math.round(holdingPeriod / 5));
                    const yearLabels = [];
                    const propertyValues = [];
                    const cashFlows = [];
                    
                    for (let year = 0; year <= holdingPeriod; year += yearSpacing) {
                        yearLabels.push(`Year ${year}`);
                        propertyValues.push(Math.round(purchasePrice * Math.pow(1 + appreciationRate / 100, year)));
                        cashFlows.push(Math.round(year === 0 ? 0 : annualCashFlow * year));
                    }
                    
                    // Make sure the final year is included
                    if (yearLabels[yearLabels.length - 1] !== `Year ${holdingPeriod}`) {
                        yearLabels.push(`Year ${holdingPeriod}`);
                        propertyValues.push(Math.round(futurePropertyValue));
                        cashFlows.push(Math.round(totalRentalIncome));
                    }
                    
                    // Update chart data
                    investmentChart.data.labels = yearLabels;
                    investmentChart.data.datasets[0].data = propertyValues;
                    investmentChart.data.datasets[1].data = cashFlows;
                    investmentChart.update();
                }

                // Auto-scroll to results on mobile devices
                autoScrollToResults('investment');

                // Auto-save to history
                autoSaveCalculation('investment', {
                    purchasePrice: purchasePrice,
                    annualRent: annualRent,
                    expensesPercent: expensesPercent,
                    vacancyRate: vacancyRate,
                    appreciationRate: appreciationRate,
                    holdingPeriod: holdingPeriod
                }, {
                    cashOnCashROI: cashOnCashROI.toFixed(1),
                    capRate: capRate.toFixed(1),
                    annualCashFlow: Math.round(annualCashFlow),
                    annualizedReturn: annualizedReturn.toFixed(1)
                });
                } catch (error) {
                    // Handle calculation errors gracefully
                }
            }
            
            // Calculate rental cash flow
            function calculateCashFlow() {
                // Get input values
                const rentalIncome = parseFloat(document.getElementById('rental-income').value);
                const mortgagePayment = parseFloat(document.getElementById('mortgage-payment').value);
                const propertyTax = parseFloat(document.getElementById('rental-property-tax').value);
                const insurance = parseFloat(document.getElementById('rental-insurance').value);
                const managementPercent = parseFloat(document.getElementById('management-slider').value);
                const maintenancePercent = parseFloat(document.getElementById('maintenance-slider').value);
                const vacancyPercent = parseFloat(document.getElementById('vacancy-slider').value);
                
                // Calculate monthly expenses
                const effectiveRentalIncome = rentalIncome * (1 - vacancyPercent / 100);
                const managementFee = effectiveRentalIncome * (managementPercent / 100);
                const maintenanceReserve = effectiveRentalIncome * (maintenancePercent / 100);
                const vacancyReserve = rentalIncome * (vacancyPercent / 100);
                
                const totalExpenses = mortgagePayment + propertyTax + insurance + managementFee + maintenanceReserve;
                const netCashFlow = effectiveRentalIncome - totalExpenses;
                const grossIncome = rentalIncome;
                const netOperatingIncome = effectiveRentalIncome - (propertyTax + insurance + managementFee + maintenanceReserve);
                const cashFlowAfterDebt = netOperatingIncome - mortgagePayment;
                
                // Update DOM elements
                document.getElementById('gross-income').textContent = '$' + Math.round(grossIncome).toLocaleString();
                document.getElementById('total-expenses').textContent = '$' + Math.round(totalExpenses).toLocaleString();
                document.getElementById('net-operating-income').textContent = '$' + Math.round(netOperatingIncome).toLocaleString();
                document.getElementById('cash-flow-before-taxes').textContent = '$' + Math.round(cashFlowAfterDebt).toLocaleString();
                document.getElementById('cash-flow-after-taxes').textContent = '$' + Math.round(cashFlowAfterDebt).toLocaleString(); // Same for now
                
                // Update expense breakdown chart
                if (expenseChart) {
                    expenseChart.data.datasets[0].data = [
                        Math.round(Math.max(netCashFlow, 0)),
                        Math.round(mortgagePayment),
                        Math.round(propertyTax),
                        Math.round(insurance),
                        Math.round(managementFee),
                        Math.round(maintenanceReserve),
                        Math.round(vacancyReserve)
                    ];
                    expenseChart.update();
                }

                // Auto-scroll to results on mobile devices
                autoScrollToResults('cashflow');
            }

            // Calculate closing costs
            function calculateClosing() {
                // Get input values
                const salesPrice = parseFloat(document.getElementById('closing-price').value);
                const mortgageAmount = parseFloat(document.getElementById('closing-mortgage').value);
                const commissionRate = parseFloat(document.getElementById('commission-rate').value);
                const deedPages = parseInt(document.getElementById('deed-pages').value);
                const mortgagePages = parseInt(document.getElementById('mortgage-pages').value);
                
                // Calculate standard closing costs
                const titleInsurance = Math.round(salesPrice * 0.003); // ~0.3% of sales price
                const attorneyFees = 800;
                const recordingDeed = deedPages * 25; // $25 per page
                const recordingMortgage = mortgagePages * 25; // $25 per page
                const transferTax = Math.round(salesPrice * 0.006); // ~0.6% transfer tax
                const inspection = 400;
                const survey = 300;
                const lenderFees = Math.round(mortgageAmount * 0.01); // 1% of loan amount
                const appraisal = 500;
                const creditReport = 75;
                const realEstateCommission = Math.round(salesPrice * (commissionRate / 100));
                
                // Calculate totals
                const totalRecordingFees = recordingDeed + recordingMortgage;
                const totalLenderFees = lenderFees + appraisal + creditReport;
                const otherFees = inspection + survey + attorneyFees;
                const totalClosingCosts = titleInsurance + totalRecordingFees + transferTax + totalLenderFees + otherFees + realEstateCommission;
                
                // Update DOM elements that actually exist in the HTML
                document.getElementById('buyer-total').textContent = '$' + totalClosingCosts.toLocaleString();
                document.getElementById('seller-total').textContent = '$' + realEstateCommission.toLocaleString();
                document.getElementById('mortgage-fees').textContent = '$' + totalLenderFees.toLocaleString();
                document.getElementById('settlement-fee').textContent = '$' + attorneyFees.toLocaleString();
                document.getElementById('title-search').textContent = '$' + Math.round(titleInsurance/2).toLocaleString();
                document.getElementById('association-fee').textContent = '$250';
                document.getElementById('survey').textContent = '$' + survey.toLocaleString();
                document.getElementById('termite').textContent = '$' + inspection.toLocaleString();
                document.getElementById('lien-search').textContent = '$75';
                document.getElementById('commission').textContent = '$' + realEstateCommission.toLocaleString();
                document.getElementById('owners-policy').textContent = '$' + Math.round(titleInsurance/2).toLocaleString();
                document.getElementById('lenders-policy').textContent = '$' + Math.round(titleInsurance/2).toLocaleString();
                document.getElementById('environmental').textContent = '$100';
                document.getElementById('alta-9').textContent = '$50';
                document.getElementById('alta-5').textContent = '$25';
                document.getElementById('alta-4').textContent = '$25';
                document.getElementById('recording').textContent = '$' + totalRecordingFees.toLocaleString();
                document.getElementById('doc-stamp-mortgage').textContent = '$' + Math.round(transferTax/2).toLocaleString();
                document.getElementById('intangible-tax').textContent = '$' + Math.round(transferTax/3).toLocaleString();
                document.getElementById('doc-stamp-deed').textContent = '$' + Math.round(transferTax/2).toLocaleString();
                
                // Update closing costs chart
                if (closingChart) {
                    closingChart.data.datasets[0].data = [
                        titleInsurance,
                        attorneyFees,
                        totalRecordingFees,
                        transferTax,
                        inspection,
                        survey,
                        totalLenderFees
                    ];
                    closingChart.update();
                }

                // Auto-scroll to results on mobile devices
                autoScrollToResults('closing');
            }

            // Calculate buyer costs
            function calculateBuyer() {
                // Get input values
                const salesPrice = parseFloat(document.getElementById('buyer-sales-price').value);
                const downPayment = parseFloat(document.getElementById('buyer-down-payment').value);
                const mortgageAmount = parseFloat(document.getElementById('buyer-mortgage').value);
                const mortgageRate = parseFloat(document.getElementById('buyer-mortgage-rate').value);
                const points = parseFloat(document.getElementById('buyer-points').value);
                const daysInterest = parseInt(document.getElementById('buyer-days-interest').value);
                
                // Calculate buyer costs
                const pointsCost = mortgageAmount * (points / 100);
                const dailyInterest = (mortgageAmount * (mortgageRate / 100)) / 365;
                const prepaidInterest = dailyInterest * daysInterest;
                const otherCosts = 2500; // Estimated other closing costs
                const totalDue = downPayment + pointsCost + prepaidInterest + otherCosts;
                
                // Update DOM elements (using safe checks)
                const buyerTotalElement = document.getElementById('buyer-total-due');
                const pointsCostElement = document.getElementById('buyer-points-cost');
                const buyerMortgageElement = document.getElementById('buyer-mortgage');
                const buyerPointsElement = document.getElementById('buyer-points');
                const buyerInterestElement = document.getElementById('buyer-interest');
                const buyerOtherCostsElement = document.getElementById('buyer-other-costs');
                
                if (buyerTotalElement) buyerTotalElement.textContent = '$' + Math.round(totalDue).toLocaleString();
                if (pointsCostElement) pointsCostElement.textContent = '$' + Math.round(pointsCost).toLocaleString();
                if (buyerMortgageElement) buyerMortgageElement.textContent = '$' + Math.round(mortgageAmount).toLocaleString();
                if (buyerPointsElement) buyerPointsElement.textContent = '$' + Math.round(pointsCost).toLocaleString();
                if (buyerInterestElement) buyerInterestElement.textContent = '$' + Math.round(prepaidInterest).toLocaleString();
                if (buyerOtherCostsElement) buyerOtherCostsElement.textContent = '$' + Math.round(otherCosts).toLocaleString();

                // Update buyer cost chart
                if (buyerChart) {
                    buyerChart.data.datasets[0].data = [
                        Math.round(downPayment),
                        Math.round(pointsCost),
                        Math.round(prepaidInterest),
                        Math.round(otherCosts)
                    ];
                    buyerChart.update();
                }

                // Auto-scroll to results on mobile devices
                autoScrollToResults('buyer');
            }

            // Calculate commission
            function calculateCommission() {
                // Get input values
                const salePrice = parseFloat(document.getElementById('sale-price').value);
                const commissionRate = parseFloat(document.getElementById('commission-rate-slider').value);
                const listingSplit = parseFloat(document.getElementById('listing-split-slider').value);
                const sellingSplit = parseFloat(document.getElementById('selling-split-slider').value);
                const transactionFee = parseFloat(document.getElementById('transaction-fee').value);
                const agentRole = document.getElementById('agent-role').value;
                
                // Calculate commission breakdown
                const totalCommission = salePrice * (commissionRate / 100);
                const listingSide = totalCommission / 2;
                const sellingSide = totalCommission / 2;
                
                let yourGrossCommission = 0;
                if (agentRole === 'listing') {
                    yourGrossCommission = listingSide * (listingSplit / 100);
                } else if (agentRole === 'selling') {
                    yourGrossCommission = sellingSide * (sellingSplit / 100);
                } else if (agentRole === 'both') {
                    yourGrossCommission = (listingSide * (listingSplit / 100)) + (sellingSide * (sellingSplit / 100));
                }
                
                const yourNetCommission = yourGrossCommission - transactionFee;
                
                // Update DOM elements
                document.getElementById('total-commission').textContent = '$' + Math.round(totalCommission).toLocaleString();
                document.getElementById('listing-side-total').textContent = '$' + Math.round(listingSide).toLocaleString();
                document.getElementById('selling-side-total').textContent = '$' + Math.round(sellingSide).toLocaleString();
                document.getElementById('your-gross-commission').textContent = '$' + Math.round(yourGrossCommission).toLocaleString();
                document.getElementById('your-net-commission').textContent = '$' + Math.round(yourNetCommission).toLocaleString();
                document.getElementById('your-commission-before-fees').textContent = '$' + Math.round(yourGrossCommission).toLocaleString();
                document.getElementById('total-fees').textContent = '$' + Math.round(transactionFee).toLocaleString();
                document.getElementById('final-commission').textContent = '$' + Math.round(yourNetCommission).toLocaleString();
                
                // Update commission chart
                if (commissionChart) {
                    const brokerageFee = yourGrossCommission - yourNetCommission;
                    const otherAgentCommission = totalCommission - yourGrossCommission;
                    
                    commissionChart.data.datasets[0].data = [
                        Math.round(yourNetCommission),
                        Math.round(brokerageFee),
                        Math.round(otherAgentCommission)
                    ];
                    commissionChart.update();
                }
                
                // Celebrate big commissions!
                if (yourNetCommission > 15000) {
                    hapticFeedback('heavy');
                }

                // Auto-scroll to results on mobile devices
                autoScrollToResults('commission');
            }

            // Calculate property comparison
            function calculateComparison() {
                // Get property data
                const properties = ['A', 'B', 'C'].map(letter => ({
                    name: `Property ${letter}`,
                    price: parseFloat(document.getElementById(`property${letter}-price`).value),
                    sqft: parseFloat(document.getElementById(`property${letter}-sqft`).value),
                    bedrooms: parseFloat(document.getElementById(`property${letter}-bedrooms`).value),
                    bathrooms: parseFloat(document.getElementById(`property${letter}-bathrooms`).value),
                    hoa: parseFloat(document.getElementById(`property${letter}-hoa`).value),
                    year: parseFloat(document.getElementById(`property${letter}-year`).value)
                }));
                
                // Calculate price per square foot for each property
                properties.forEach((prop, index) => {
                    const letter = ['A', 'B', 'C'][index];
                    const pricePerSqft = prop.sqft > 0 ? prop.price / prop.sqft : 0;
                    prop.pricePerSqft = pricePerSqft;
                    document.getElementById(`property${letter}-price-per-sqft`).textContent = '$' + Math.round(pricePerSqft) + '/sqft';
                });
                
                // Find best values
                const bestPricePerSqft = properties.reduce((best, current) => 
                    current.pricePerSqft < best.pricePerSqft && current.pricePerSqft > 0 ? current : best
                );
                const mostBedrooms = properties.reduce((most, current) => 
                    current.bedrooms > most.bedrooms ? current : most
                );
                const newestProperty = properties.reduce((newest, current) => 
                    current.year > newest.year ? current : newest
                );
                const lowestHoa = properties.reduce((lowest, current) => 
                    current.hoa < lowest.hoa ? current : lowest
                );
                
                // Calculate overall recommendation (simple scoring system)
                properties.forEach(prop => {
                    let score = 0;
                    
                    // Lower price per sqft is better
                    if (prop === bestPricePerSqft) score += 30;
                    
                    // More bedrooms is better
                    if (prop === mostBedrooms) score += 20;
                    
                    // Newer is better
                    if (prop === newestProperty) score += 15;
                    
                    // Lower HOA is better
                    if (prop === lowestHoa) score += 10;
                    
                    // Size bonus (bigger is generally better)
                    if (prop.sqft > 2200) score += 10;
                    
                    prop.score = score;
                });
                
                const recommended = properties.reduce((best, current) => 
                    current.score > best.score ? current : best
                );
                
                // Update DOM elements
                document.getElementById('best-price-per-sqft').textContent = bestPricePerSqft.name;
                document.getElementById('most-bedrooms').textContent = `${mostBedrooms.name} (${mostBedrooms.bedrooms} bedrooms)`;
                document.getElementById('newest-property').textContent = `${newestProperty.name} (${newestProperty.year})`;
                document.getElementById('lowest-hoa').textContent = `${lowestHoa.name} ($${lowestHoa.hoa}/month)`;
                document.getElementById('recommended-choice').textContent = recommended.name;
                
                // Update comparison chart
                if (comparisonChart) {
                    comparisonChart.data.labels = properties.map(p => p.name);
                    comparisonChart.data.datasets[0].data = properties.map(p => p.price);
                    comparisonChart.data.datasets[1].data = properties.map(p => p.pricePerSqft);
                    comparisonChart.update();
                }
                
                // Analysis messages available in the results section
                const analysisMessages = [
                    `📊 ${bestPricePerSqft.name} offers the best value at $${Math.round(bestPricePerSqft.pricePerSqft)}/sqft`,
                    `🏆 Based on all factors, ${recommended.name} appears to be the smartest choice`,
                    `💡 ${newestProperty.name} is the newest (${newestProperty.year}) but ${lowestHoa.name} has the lowest HOA fees`
                ];

                // Auto-scroll to results on mobile devices
                autoScrollToResults('comparison');
            }

            // Calculate Rent vs Buy
            function calculateRentBuy() {
                try {
                    // Get buying scenario inputs
                    const homePrice = parseFloat(document.getElementById('buy-home-price').value) || 0;
                    const downPaymentPercent = parseFloat(document.getElementById('buy-down-payment-slider').value) || 0;
                    const interestRate = parseFloat(document.getElementById('buy-interest-rate-slider').value) || 0;
                    const loanTerm = parseInt(document.getElementById('buy-loan-term').value) || 30;
                    const propertyTax = parseFloat(document.getElementById('buy-property-tax').value) || 0;
                    const homeInsurance = parseFloat(document.getElementById('buy-home-insurance').value) || 0;
                    const hoaFees = parseFloat(document.getElementById('buy-hoa').value) || 0;
                    const maintenancePercent = parseFloat(document.getElementById('buy-maintenance-slider').value) || 0;

                    // Get renting scenario inputs
                    const monthlyRent = parseFloat(document.getElementById('rent-monthly-rent').value) || 0;
                    const rentIncrease = parseFloat(document.getElementById('rent-annual-increase-slider').value) || 0;
                    const securityDeposit = parseFloat(document.getElementById('rent-security-deposit').value) || 0;

                    // Get investment assumptions
                    const investmentReturn = parseFloat(document.getElementById('investment-return-slider').value) || 0;
                    const homeAppreciation = parseFloat(document.getElementById('home-appreciation-slider').value) || 0;
                    const analysisPeriod = parseInt(document.getElementById('analysis-period').value) || 5;

                    // Calculate buying costs
                    const downPayment = homePrice * (downPaymentPercent / 100);
                    const loanAmount = homePrice - downPayment;
                    const monthlyInterestRate = interestRate / 100 / 12;
                    const numberOfPayments = loanTerm * 12;

                    // Monthly mortgage payment (P&I)
                    const monthlyMortgage = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                        (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);

                    // Monthly ownership costs
                    const monthlyPropertyTax = propertyTax / 12;
                    const monthlyInsurance = homeInsurance / 12;
                    const monthlyMaintenance = (homePrice * (maintenancePercent / 100)) / 12;
                    const totalMonthlyPayment = monthlyMortgage + monthlyPropertyTax + monthlyInsurance + hoaFees + monthlyMaintenance;

                    // Calculate total buying costs over analysis period
                    const totalMortgagePayments = monthlyMortgage * (analysisPeriod * 12);
                    const totalTaxesInsurance = (monthlyPropertyTax + monthlyInsurance + hoaFees + monthlyMaintenance) * (analysisPeriod * 12);
                    const futureHomeValue = homePrice * Math.pow(1 + (homeAppreciation / 100), analysisPeriod);

                    // Net buying cost (after home appreciation)
                    const buyingNetCost = downPayment + totalMortgagePayments + totalTaxesInsurance - (futureHomeValue - homePrice);

                    // Calculate renting costs over analysis period
                    let totalRentPaid = 0;
                    let currentRent = monthlyRent;
                    
                    for (let year = 0; year < analysisPeriod; year++) {
                        totalRentPaid += currentRent * 12;
                        currentRent *= (1 + (rentIncrease / 100));
                    }

                    // Calculate investment growth if renting (investing the down payment)
                    const investmentGrowth = downPayment * Math.pow(1 + (investmentReturn / 100), analysisPeriod);
                    const rentingNetCost = totalRentPaid + securityDeposit - investmentGrowth;

                    // Determine better option
                    const costDifference = Math.abs(buyingNetCost - rentingNetCost);
                    const betterOption = buyingNetCost < rentingNetCost ? 'Buying' : 'Renting';

                    // Update results
                    document.getElementById('better-option').textContent = betterOption;
                    document.getElementById('better-option').style.color = betterOption === 'Buying' ? '#10b981' : '#3b82f6';
                    document.getElementById('cost-difference').textContent = '$' + Math.round(costDifference).toLocaleString();

                    // Update buying costs breakdown
                    document.getElementById('buy-down-payment-total').textContent = '$' + Math.round(downPayment).toLocaleString();
                    document.getElementById('buy-monthly-payment').textContent = '$' + Math.round(totalMonthlyPayment).toLocaleString();
                    document.getElementById('buy-total-payments').textContent = '$' + Math.round(totalMortgagePayments).toLocaleString();
                    document.getElementById('buy-maintenance-taxes').textContent = '$' + Math.round(totalTaxesInsurance).toLocaleString();
                    document.getElementById('buy-home-value').textContent = '$' + Math.round(futureHomeValue).toLocaleString();
                    document.getElementById('buy-net-cost').textContent = '$' + Math.round(buyingNetCost).toLocaleString();

                    // Update renting costs breakdown
                    document.getElementById('rent-initial').textContent = '$' + Math.round(monthlyRent).toLocaleString();
                    document.getElementById('rent-final').textContent = '$' + Math.round(currentRent).toLocaleString();
                    document.getElementById('rent-total-paid').textContent = '$' + Math.round(totalRentPaid).toLocaleString();
                    document.getElementById('rent-security').textContent = '$' + Math.round(securityDeposit).toLocaleString();
                    document.getElementById('rent-investment-growth').textContent = '$' + Math.round(investmentGrowth).toLocaleString();
                    document.getElementById('rent-net-cost').textContent = '$' + Math.round(rentingNetCost).toLocaleString();

                    // Update rent vs buy chart
                    if (rentbuyChart) {
                        // Create data points for each year
                        const yearLabels = [];
                        const rentCosts = [];
                        const buyCosts = [];
                        
                        let cumulativeRentCost = securityDeposit;
                        let currentRentAmount = monthlyRent;
                        let cumulativeBuyCost = downPayment;
                        
                        for (let year = 1; year <= analysisPeriod; year++) {
                            yearLabels.push(`Year ${year}`);
                            
                            // Add annual rent (with increases)
                            cumulativeRentCost += currentRentAmount * 12;
                            currentRentAmount *= (1 + (rentIncrease / 100));
                            rentCosts.push(Math.round(cumulativeRentCost));
                            
                            // Add annual buy costs (mortgage + taxes + maintenance)
                            cumulativeBuyCost += totalMonthlyPayment * 12;
                            buyCosts.push(Math.round(cumulativeBuyCost));
                        }
                        
                        // Subtract investment growth for renting and home appreciation for buying
                        const finalRentCost = cumulativeRentCost - investmentGrowth;
                        const finalBuyCost = cumulativeBuyCost - (futureHomeValue - homePrice);
                        
                        rentCosts[rentCosts.length - 1] = Math.round(finalRentCost);
                        buyCosts[buyCosts.length - 1] = Math.round(finalBuyCost);
                        
                        rentbuyChart.data.labels = yearLabels;
                        rentbuyChart.data.datasets[0].data = rentCosts;
                        rentbuyChart.data.datasets[1].data = buyCosts;
                        rentbuyChart.update();
                    }

                    // Auto-scroll to results on mobile devices
                    autoScrollToResults('rentbuy');

                    // Auto-save to history
                    autoSaveCalculation('rentbuy', {
                        homePrice: homePrice,
                        downPaymentPercent: downPaymentPercent,
                        interestRate: interestRate,
                        monthlyRent: monthlyRent,
                        analysisPeriod: analysisPeriod
                    }, {
                        betterOption: betterOption,
                        costDifference: Math.round(costDifference),
                        buyingNetCost: Math.round(buyingNetCost),
                        rentingNetCost: Math.round(rentingNetCost)
                    });

                } catch (error) {
                    console.error('Rent vs Buy calculation error:', error);
                }
            }

            // Calculate Refinancing
            function calculateRefinance() {
                try {
                    // Get current loan inputs
                    const currentBalance = parseFloat(document.getElementById('refi-current-balance').value) || 0;
                    const currentRate = parseFloat(document.getElementById('refi-current-rate-slider').value) || 0;
                    const currentPayment = parseFloat(document.getElementById('refi-current-payment').value) || 0;
                    const yearsRemaining = parseInt(document.getElementById('refi-years-remaining').value) || 30;

                    // Get new loan inputs
                    const newRate = parseFloat(document.getElementById('refi-new-rate-slider').value) || 0;
                    const newTerm = parseInt(document.getElementById('refi-new-term').value) || 30;
                    const closingCosts = parseFloat(document.getElementById('refi-closing-costs').value) || 0;
                    const pointsPercent = parseFloat(document.getElementById('refi-points-slider').value) || 0;

                    // Calculate new loan details
                    const newMonthlyInterestRate = newRate / 100 / 12;
                    const newNumberOfPayments = newTerm * 12;
                    const pointsCost = currentBalance * (pointsPercent / 100);
                    const totalUpfrontCost = closingCosts + pointsCost;

                    // Calculate new monthly payment
                    const newMonthlyPayment = currentBalance * newMonthlyInterestRate * Math.pow(1 + newMonthlyInterestRate, newNumberOfPayments) / 
                        (Math.pow(1 + newMonthlyInterestRate, newNumberOfPayments) - 1);

                    // Calculate savings
                    const monthlySavings = currentPayment - newMonthlyPayment;
                    const annualSavings = monthlySavings * 12;

                    // Calculate break-even point
                    const breakEvenMonths = totalUpfrontCost / monthlySavings;
                    const fiveYearSavings = (monthlySavings * 60) - totalUpfrontCost; // 5 years minus upfront costs

                    // Update results
                    document.getElementById('refi-monthly-savings').textContent = '$' + Math.round(monthlySavings).toLocaleString();
                    document.getElementById('refi-monthly-savings').style.color = monthlySavings > 0 ? '#10b981' : '#ef4444';
                    
                    document.getElementById('refi-breakeven').textContent = breakEvenMonths.toFixed(1) + ' months';
                    
                    // Update payment comparison
                    document.getElementById('refi-current-monthly').textContent = '$' + Math.round(currentPayment).toLocaleString();
                    document.getElementById('refi-new-monthly').textContent = '$' + Math.round(newMonthlyPayment).toLocaleString();
                    document.getElementById('refi-savings-monthly').textContent = '$' + Math.round(monthlySavings).toLocaleString();
                    document.getElementById('refi-savings-annual').textContent = '$' + Math.round(annualSavings).toLocaleString();

                    // Update break-even analysis
                    document.getElementById('refi-total-costs').textContent = '$' + Math.round(closingCosts).toLocaleString();
                    document.getElementById('refi-points-cost').textContent = '$' + Math.round(pointsCost).toLocaleString();
                    document.getElementById('refi-upfront-total').textContent = '$' + Math.round(totalUpfrontCost).toLocaleString();
                    document.getElementById('refi-breakeven-months').textContent = breakEvenMonths.toFixed(1) + ' months';
                    document.getElementById('refi-five-year-savings').textContent = '$' + Math.round(fiveYearSavings).toLocaleString();
                    document.getElementById('refi-five-year-savings').style.color = fiveYearSavings > 0 ? '#10b981' : '#ef4444';

                    // Auto-scroll to results on mobile devices
                    autoScrollToResults('refinance');

                    // Auto-save to history
                    autoSaveCalculation('refinance', {
                        currentBalance: currentBalance,
                        currentRate: currentRate,
                        newRate: newRate,
                        newTerm: newTerm,
                        closingCosts: closingCosts
                    }, {
                        monthlySavings: Math.round(monthlySavings),
                        breakEvenMonths: breakEvenMonths.toFixed(1),
                        fiveYearSavings: Math.round(fiveYearSavings)
                    });

                } catch (error) {
                    console.error('Refinance calculation error:', error);
                }
            }

            // Calculate HELOC
            function calculateHELOC() {
                try {
                    // Get input values
                    const homeValue = parseFloat(document.getElementById('heloc-home-value').value) || 0;
                    const existingMortgage = parseFloat(document.getElementById('heloc-existing-mortgage').value) || 0;
                    const maxLtv = parseFloat(document.getElementById('heloc-ltv-slider').value) || 80;
                    const desiredCreditLimit = parseFloat(document.getElementById('heloc-credit-limit').value) || 0;
                    const currentBalance = parseFloat(document.getElementById('heloc-current-balance').value) || 0;
                    const interestRate = parseFloat(document.getElementById('heloc-interest-rate-slider').value) || 6.5;
                    const repaymentPeriod = parseInt(document.getElementById('heloc-repayment-period').value) || 15;

                    // Calculate equity and available credit
                    const currentEquity = homeValue - existingMortgage;
                    const maxCreditLine = (homeValue * (maxLtv / 100)) - existingMortgage;
                    const availableToBorrow = maxCreditLine - currentBalance;

                    // Calculate monthly payment based on current balance
                    const monthlyInterestRate = interestRate / 100 / 12;
                    const numberOfPayments = repaymentPeriod * 12;
                    const balanceToCalculate = currentBalance || desiredCreditLimit;
                    
                    const monthlyPayment = balanceToCalculate * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                        (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);

                    // Update results
                    document.getElementById('heloc-available-equity').textContent = '$' + Math.round(currentEquity).toLocaleString();
                    document.getElementById('heloc-monthly-payment').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
                    
                    // Update equity breakdown
                    document.getElementById('heloc-home-value-display').textContent = '$' + homeValue.toLocaleString();
                    document.getElementById('heloc-existing-mortgage-display').textContent = '$' + existingMortgage.toLocaleString();
                    document.getElementById('heloc-current-equity').textContent = '$' + Math.round(currentEquity).toLocaleString();
                    document.getElementById('heloc-max-credit-line').textContent = '$' + Math.round(maxCreditLine).toLocaleString();
                    document.getElementById('heloc-available-borrow').textContent = '$' + Math.round(availableToBorrow).toLocaleString();

                    // Update HELOC chart
                    if (helocChart) {
                        helocChart.data.datasets[0].data = [
                            Math.round(currentEquity - currentBalance),
                            Math.round(existingMortgage),
                            Math.round(currentBalance)
                        ];
                        helocChart.update();
                    }

                    // Auto-scroll to results on mobile devices
                    autoScrollToResults('heloc');

                    // Auto-save to history
                    autoSaveCalculation('heloc', {
                        homeValue: homeValue,
                        existingMortgage: existingMortgage,
                        maxLtv: maxLtv,
                        interestRate: interestRate,
                        repaymentPeriod: repaymentPeriod
                    }, {
                        availableEquity: Math.round(currentEquity),
                        monthlyPayment: Math.round(monthlyPayment),
                        maxCreditLine: Math.round(maxCreditLine),
                        availableToBorrow: Math.round(availableToBorrow)
                    });

                } catch (error) {
                    console.error('HELOC calculation error:', error);
                }
            }

            // Calculate Property Flip
            function calculateFlip() {
                try {
                    // Get input values
                    const purchasePrice = parseFloat(document.getElementById('flip-purchase-price').value) || 0;
                    const closingCosts = parseFloat(document.getElementById('flip-closing-costs').value) || 0;
                    const renovationBudget = parseFloat(document.getElementById('flip-renovation-budget').value) || 0;
                    const contingencyPercent = parseFloat(document.getElementById('flip-contingency-slider').value) || 15;
                    const holdingPeriod = parseInt(document.getElementById('flip-holding-period').value) || 6;
                    const carryingCosts = parseFloat(document.getElementById('flip-carrying-costs').value) || 0;
                    const arv = parseFloat(document.getElementById('flip-arv').value) || 0;
                    const saleCostsPercent = parseFloat(document.getElementById('flip-sale-costs-slider').value) || 8;

                    // Calculate costs
                    const contingencyAmount = renovationBudget * (contingencyPercent / 100);
                    const totalCarryingCosts = carryingCosts * holdingPeriod;
                    const saleCosts = arv * (saleCostsPercent / 100);
                    const totalInvestment = purchasePrice + closingCosts + renovationBudget + contingencyAmount + totalCarryingCosts;
                    
                    // Calculate profit
                    const netSalePrice = arv - saleCosts;
                    const netProfit = netSalePrice - totalInvestment;
                    const roi = (netProfit / totalInvestment) * 100;

                    // Update results
                    document.getElementById('flip-net-profit').textContent = '$' + Math.round(netProfit).toLocaleString();
                    document.getElementById('flip-net-profit').style.color = netProfit > 0 ? '#10b981' : '#ef4444';
                    document.getElementById('flip-roi').textContent = roi.toFixed(1) + '%';
                    document.getElementById('flip-roi').style.color = roi > 0 ? '#10b981' : '#ef4444';

                    // Update cost breakdown
                    document.getElementById('flip-purchase-display').textContent = '$' + purchasePrice.toLocaleString();
                    document.getElementById('flip-renovation-display').textContent = '$' + renovationBudget.toLocaleString();
                    document.getElementById('flip-contingency-display').textContent = '$' + Math.round(contingencyAmount).toLocaleString();
                    document.getElementById('flip-carrying-display').textContent = '$' + Math.round(totalCarryingCosts).toLocaleString();
                    document.getElementById('flip-sale-costs-display').textContent = '$' + Math.round(saleCosts).toLocaleString();
                    document.getElementById('flip-total-investment').textContent = '$' + Math.round(totalInvestment).toLocaleString();
                    document.getElementById('flip-arv-display').textContent = '$' + arv.toLocaleString();
                    document.getElementById('flip-profit-display').textContent = '$' + Math.round(netProfit).toLocaleString();

                    // Update Property Flip chart
                    if (flipChart) {
                        flipChart.data.datasets[0].data = [
                            Math.round(purchasePrice + closingCosts),
                            Math.round(renovationBudget),
                            Math.round(contingencyAmount),
                            Math.round(totalCarryingCosts),
                            Math.round(saleCosts),
                            Math.round(netProfit)
                        ];
                        flipChart.update();
                    }

                    // Auto-scroll to results on mobile devices
                    autoScrollToResults('flip');

                    // Auto-save to history
                    autoSaveCalculation('flip', {
                        purchasePrice: purchasePrice,
                        renovationBudget: renovationBudget,
                        holdingPeriod: holdingPeriod,
                        arv: arv,
                        saleCostsPercent: saleCostsPercent
                    }, {
                        netProfit: Math.round(netProfit),
                        roi: roi.toFixed(1),
                        totalInvestment: Math.round(totalInvestment)
                    });

                } catch (error) {
                    console.error('Property Flip calculation error:', error);
                }
            }

            // Calculate BRRRR Strategy
            function calculateBRRRR() {
                try {
                    // Get input values
                    const purchasePrice = parseFloat(document.getElementById('brrrr-purchase-price').value) || 0;
                    const rehabCosts = parseFloat(document.getElementById('brrrr-rehab-costs').value) || 0;
                    const closingCosts = parseFloat(document.getElementById('brrrr-closing-costs').value) || 0;
                    const monthlyRent = parseFloat(document.getElementById('brrrr-monthly-rent').value) || 0;
                    const expensesPercent = parseFloat(document.getElementById('brrrr-expenses-slider').value) || 35;
                    const arv = parseFloat(document.getElementById('brrrr-arv').value) || 0;
                    const refiLtv = parseFloat(document.getElementById('brrrr-refi-ltv-slider').value) || 75;
                    const refiRate = parseFloat(document.getElementById('brrrr-refi-rate-slider').value) || 5.5;
                    const refiTerm = parseInt(document.getElementById('brrrr-refi-term').value) || 30;

                    // Calculate total investment
                    const totalInvestment = purchasePrice + rehabCosts + closingCosts;

                    // Calculate refinance amount
                    const refinanceAmount = arv * (refiLtv / 100);

                    // Calculate cash left in deal
                    const cashLeftInDeal = totalInvestment - refinanceAmount;

                    // Calculate new mortgage payment
                    const monthlyRate = refiRate / 100 / 12;
                    const numberOfPayments = refiTerm * 12;
                    const mortgagePayment = refinanceAmount * monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments) / 
                        (Math.pow(1 + monthlyRate, numberOfPayments) - 1);

                    // Calculate cash flow
                    const monthlyExpenses = monthlyRent * (expensesPercent / 100);
                    const netCashFlow = monthlyRent - monthlyExpenses - mortgagePayment;

                    // Calculate cash-on-cash ROI
                    const annualCashFlow = netCashFlow * 12;
                    const cocRoi = cashLeftInDeal > 0 ? (annualCashFlow / cashLeftInDeal) * 100 : 0;

                    // Update results
                    document.getElementById('brrrr-money-left').textContent = '$' + Math.round(cashLeftInDeal).toLocaleString();
                    document.getElementById('brrrr-money-left').style.color = cashLeftInDeal < totalInvestment * 0.5 ? '#10b981' : '#3b82f6';
                    document.getElementById('brrrr-monthly-cashflow').textContent = '$' + Math.round(netCashFlow).toLocaleString();
                    document.getElementById('brrrr-monthly-cashflow').style.color = netCashFlow > 0 ? '#10b981' : '#ef4444';

                    // Update investment summary
                    document.getElementById('brrrr-total-investment').textContent = '$' + Math.round(totalInvestment).toLocaleString();
                    document.getElementById('brrrr-refi-amount').textContent = '$' + Math.round(refinanceAmount).toLocaleString();
                    document.getElementById('brrrr-cash-recovered').textContent = '$' + Math.round(refinanceAmount).toLocaleString();
                    document.getElementById('brrrr-cash-left').textContent = '$' + Math.round(cashLeftInDeal).toLocaleString();
                    document.getElementById('brrrr-mortgage-payment').textContent = '$' + Math.round(mortgagePayment).toLocaleString();
                    document.getElementById('brrrr-net-cashflow').textContent = '$' + Math.round(netCashFlow).toLocaleString();
                    document.getElementById('brrrr-coc-roi').textContent = cocRoi.toFixed(1) + '%';
                    document.getElementById('brrrr-coc-roi').style.color = cocRoi > 0 ? '#10b981' : '#ef4444';

                    // Update BRRRR Strategy chart
                    if (brrrrChart) {
                        brrrrChart.data.datasets[0].data = [
                            Math.round(purchasePrice),
                            Math.round(rehabCosts),
                            Math.round(closingCosts),
                            -Math.round(refinanceAmount),
                            Math.round(Math.max(cashLeftInDeal, 0)),
                            Math.round(netCashFlow * 12) // Annual cash flow
                        ];
                        brrrrChart.update();
                    }

                    // Auto-scroll to results on mobile devices
                    autoScrollToResults('brrrr');

                    // Auto-save to history
                    autoSaveCalculation('brrrr', {
                        purchasePrice: purchasePrice,
                        rehabCosts: rehabCosts,
                        monthlyRent: monthlyRent,
                        arv: arv,
                        refiLtv: refiLtv,
                        refiRate: refiRate
                    }, {
                        moneyLeftInDeal: Math.round(cashLeftInDeal),
                        monthlyCashFlow: Math.round(netCashFlow),
                        cocRoi: cocRoi.toFixed(1),
                        totalInvestment: Math.round(totalInvestment)
                    });

                } catch (error) {
                    console.error('BRRRR calculation error:', error);
                }
            }

            // Generate comprehensive report
            function generateReport() {
                try {
                    // Get report criteria from inputs
                    const reportPropertyType = document.getElementById('report-property-type').value;
                    const reportPropertyPrice = parseFloat(document.getElementById('report-property-price').value) || 400000;
                    const reportDownPayment = parseFloat(document.getElementById('report-down-payment').value) || 20;
                    const reportInterestRate = parseFloat(document.getElementById('report-interest-rate').value) || 4.5;
                    const reportRentAmount = parseFloat(document.getElementById('report-rent-amount').value) || 2500;
                    const reportHoldingPeriod = parseInt(document.getElementById('report-holding-period').value) || 10;

                    // Calculate key metrics for the report
                    const downPaymentAmount = reportPropertyPrice * (reportDownPayment / 100);
                    const loanAmount = reportPropertyPrice - downPaymentAmount;
                    const monthlyInterestRate = reportInterestRate / 100 / 12;
                    const numberOfPayments = 30 * 12; // 30 year loan
                    
                    // Monthly mortgage payment
                    const monthlyPayment = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                        (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
                    
                    // Add property tax and insurance estimates
                    const monthlyPropertyTax = (reportPropertyPrice * 0.015) / 12; // 1.5% annual property tax
                    const monthlyInsurance = (reportPropertyPrice * 0.005) / 12; // 0.5% annual insurance
                    const totalMonthlyPayment = monthlyPayment + monthlyPropertyTax + monthlyInsurance;
                    
                    // Calculate cash flow (if rental)
                    const netCashFlow = reportRentAmount - totalMonthlyPayment - (reportRentAmount * 0.15); // 15% for management/maintenance/vacancy
                    
                    // Calculate ROI
                    const annualCashFlow = netCashFlow * 12;
                    const cashOnCashROI = (annualCashFlow / downPaymentAmount) * 100;
                    
                    // Total investment for holding period
                    const totalInvestmentValue = reportPropertyPrice * Math.pow(1 + 0.03, reportHoldingPeriod); // 3% appreciation
                    
                    // Update report display elements
                    document.getElementById('report-total-investment').textContent = '$' + Math.round(downPaymentAmount).toLocaleString();
                    document.getElementById('report-total-return').textContent = '$' + Math.round(totalInvestmentValue).toLocaleString();
                    
                    // Update breakdown details
                    document.getElementById('report-principal-interest').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
                    document.getElementById('report-property-tax').textContent = '$' + Math.round(monthlyPropertyTax).toLocaleString();
                    document.getElementById('report-home-insurance').textContent = '$' + Math.round(monthlyInsurance).toLocaleString();
                    document.getElementById('report-hoa').textContent = '$0';
                    document.getElementById('report-management').textContent = '$' + Math.round(reportRentAmount * 0.08).toLocaleString();
                    document.getElementById('report-maintenance').textContent = '$' + Math.round(reportRentAmount * 0.05).toLocaleString();
                    document.getElementById('report-vacancy').textContent = '$' + Math.round(reportRentAmount * 0.02).toLocaleString();
                    document.getElementById('report-cash-flow').textContent = '$' + Math.round(netCashFlow).toLocaleString();

                    // Update report chart
                    if (reportChart) {
                        const roiValue = Math.max(cashOnCashROI * 1000, 0); // Scale for chart display
                        reportChart.data.datasets[0].data = [
                            Math.round(totalMonthlyPayment),
                            Math.round(netCashFlow),
                            Math.round(roiValue), 
                            Math.round(downPaymentAmount)
                        ];
                        reportChart.data.labels = [
                            'Monthly Payment',
                            'Net Cash Flow',
                            `ROI (${cashOnCashROI.toFixed(1)}%)`,
                            'Initial Investment'
                        ];
                        reportChart.update();
                    }

                    // Auto-scroll to results on mobile devices
                    autoScrollToResults('report');

                    // Auto-save to history
                    autoSaveCalculation('report', {
                        propertyPrice: reportPropertyPrice,
                        downPayment: reportDownPayment,
                        interestRate: reportInterestRate,
                        rentAmount: reportRentAmount,
                        holdingPeriod: reportHoldingPeriod
                    }, {
                        totalInvestment: Math.round(downPaymentAmount),
                        totalReturn: Math.round(totalInvestmentValue),
                        monthlyCashFlow: Math.round(netCashFlow),
                        roi: cashOnCashROI.toFixed(1)
                    });

                } catch (error) {
                    console.error('Report generation error:', error);
                }
            }

            // Modern Export System for Beautiful Reports
            class ExportManager {
                constructor() {
                    this.setupExportListeners();
                }

                setupExportListeners() {
                    // Add click listeners to all export options
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('export-option')) {
                            e.preventDefault();
                            const type = e.target.dataset.type;
                            const content = e.target.dataset.content;
                            const source = e.target.dataset.source;
                            
                            if (type === 'pdf') {
                                this.exportToPDF(source, content);
                            } else if (type === 'jpg') {
                                this.exportToJPG(source, content);
                            }
                        }
                    });
                }

                async exportToPDF(source, content) {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // Set up document
                        doc.setFontSize(20);
                        doc.setTextColor(37, 99, 235); // Primary blue
                        
                        // Title based on source
                        const titles = {
                            mortgage: 'Mortgage Calculator Report',
                            investment: 'Investment Property Analysis',
                            cashflow: 'Rental Cash Flow Analysis',
                            closing: 'Closing Costs Breakdown',
                            buyer: 'Buyer Cost Sheet',
                            commission: 'Real Estate Commission Analysis',
                            comparison: 'Property Comparison Report',
                            rentbuy: 'Rent vs Buy Analysis',
                            refinance: 'Refinancing Analysis',
                            heloc: 'HELOC Calculator Report',
                            flip: 'Property Flip Analysis',
                            brrrr: 'BRRRR Strategy Report',
                            report: 'Complete Property Analysis'
                        };
                        
                        doc.text(titles[source] || 'Property Report', 20, 20);
                        
                        // Add generated date
                        doc.setFontSize(10);
                        doc.setTextColor(107, 114, 128);
                        doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, 30);
                        

                        
                        let yPos = 50;
                        
                        if (content === 'summary' || content === 'full') {
                            yPos = await this.addCalculatorData(doc, source, yPos, content === 'full');
                        }
                        
                        if (content === 'current' || content === 'full') {
                            // Add chart if available
                            await this.addChartToPDF(doc, source, yPos);
                        }
                        
                        // Add footer
                        const pageHeight = doc.internal.pageSize.height;
                        doc.setFontSize(8);
                        doc.setTextColor(156, 163, 175);
                        doc.text('Generated by HouseMath.app - Professional Real Estate Calculator Suite', 20, pageHeight - 10);
                        
                        // Save the PDF
                        const filename = `${source}-report-${new Date().toISOString().split('T')[0]}.pdf`;
                        doc.save(filename);
                        
                    } catch (error) {
                        console.error('PDF Export Error:', error);
                        alert('PDF export failed. Please ensure you have a modern browser.');
                    }
                }

                async exportToJPG(source, content) {
                    try {
                        // Create a clean export canvas
                        const exportContainer = this.createExportContainer(source, content);
                        document.body.appendChild(exportContainer);
                        
                        // Use html2canvas to capture the container
                        const canvas = await html2canvas(exportContainer, {
                            backgroundColor: '#ffffff',
                            scale: 2, // Higher quality
                            useCORS: true,
                            scrollX: 0,
                            scrollY: 0
                        });
                        
                        // Remove the temporary container
                        document.body.removeChild(exportContainer);
                        
                        // Convert to image and download
                        const link = document.createElement('a');
                        link.download = `${source}-report-${new Date().toISOString().split('T')[0]}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.95);
                        link.click();
                        
                    } catch (error) {
                        console.error('JPG Export Error:', error);
                        alert('Image export failed. Please ensure you have a modern browser.');
                    }
                }

                createExportContainer(source, content) {
                    const container = document.createElement('div');
                    container.style.cssText = `
                        position: absolute;
                        top: -9999px;
                        left: -9999px;
                        width: 800px;
                        background: white;
                        padding: 40px;
                        font-family: 'Poppins', sans-serif;
                        color: #1f2937;
                        box-sizing: border-box;
                    `;
                    
                    // Title section
                    const titles = {
                        mortgage: 'Mortgage Calculator Report',
                        investment: 'Investment Property Analysis',
                        cashflow: 'Rental Cash Flow Analysis',
                        closing: 'Closing Costs Breakdown',
                        buyer: 'Buyer Cost Sheet',
                        report: 'Complete Property Analysis'
                    };
                    
                    container.innerHTML = `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="color: #2563eb; font-size: 28px; margin: 0 0 10px 0;">${titles[source] || 'Property Report'}</h1>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Generated on ${new Date().toLocaleDateString()}</p>
                            ${this.getCompanyBranding()}
                        </div>
                        <div id="export-content"></div>
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <p style="color: #9ca3af; font-size: 12px; margin: 0;">Generated by HouseMath.app - Professional Real Estate Calculator Suite</p>
                        </div>
                    `;
                    
                    // Add calculator-specific content
                    const exportContent = container.querySelector('#export-content');
                    this.addCalculatorContentToExport(exportContent, source, content);
                    
                    return container;
                }

                getCompanyBranding() {
                    return '';
                }

                addCalculatorContentToExport(container, source, content) {
                    const sourceElement = document.getElementById(`${source}-calculator`);
                    if (!sourceElement) return;
                    
                    // Extract key data from the calculator
                    const statsGrid = sourceElement.querySelector('.stats-grid');
                    const detailsTable = sourceElement.querySelector('.details-table');
                    
                    if (statsGrid) {
                        const statsClone = statsGrid.cloneNode(true);
                        statsClone.style.cssText = `
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin-bottom: 30px;
                        `;
                        
                        // Style stat boxes for export
                        const statBoxes = statsClone.querySelectorAll('.stat-box');
                        statBoxes.forEach(box => {
                            box.style.cssText = `
                                background: #f8fafc;
                                border: 1px solid #e2e8f0;
                                border-radius: 8px;
                                padding: 20px;
                                text-align: center;
                            `;
                            
                            const label = box.querySelector('.stat-label');
                            const value = box.querySelector('.stat-value');
                            
                            if (label) {
                                label.style.cssText = `
                                    font-size: 14px;
                                    color: #64748b;
                                    margin-bottom: 8px;
                                `;
                            }
                            
                            if (value) {
                                value.style.cssText = `
                                    font-size: 24px;
                                    font-weight: 600;
                                    color: #2563eb;
                                `;
                            }
                        });
                        
                        container.appendChild(statsClone);
                    }
                    
                    if (detailsTable && content !== 'summary') {
                        const tableClone = detailsTable.cloneNode(true);
                        tableClone.style.cssText = `
                            background: white;
                            border: 1px solid #e5e7eb;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-top: 20px;
                        `;
                        
                        // Style table rows
                        const rows = tableClone.querySelectorAll('.details-row');
                        rows.forEach((row, index) => {
                            row.style.cssText = `
                                display: flex;
                                justify-content: space-between;
                                padding: 12px 20px;
                                border-bottom: ${index < rows.length - 1 ? '1px solid #f3f4f6' : 'none'};
                                background: ${index % 2 === 0 ? '#f9fafb' : 'white'};
                            `;
                            
                            const label = row.querySelector('.details-label');
                            const value = row.querySelector('.details-value');
                            
                            if (label) {
                                label.style.cssText = `
                                    font-weight: 500;
                                    color: #374151;
                                `;
                            }
                            
                            if (value) {
                                value.style.cssText = `
                                    font-weight: 600;
                                    color: #2563eb;
                                `;
                            }
                        });
                        
                        container.appendChild(tableClone);
                    }
                }

                async addCalculatorData(doc, source, yPos, includeDetails) {
                    doc.setFontSize(14);
                    doc.setTextColor(31, 41, 55);
                    
                    const sourceElement = document.getElementById(`${source}-calculator`);
                    if (!sourceElement) return yPos;
                    
                    // Extract key statistics
                    const statBoxes = sourceElement.querySelectorAll('.stat-box');
                    if (statBoxes.length > 0) {
                        doc.setFontSize(16);
                        doc.setTextColor(37, 99, 235);
                        doc.text('Key Results', 20, yPos);
                        yPos += 15;
                        
                        statBoxes.forEach(box => {
                            const label = box.querySelector('.stat-label')?.textContent || '';
                            const value = box.querySelector('.stat-value')?.textContent || '';
                            
                            doc.setFontSize(12);
                            doc.setTextColor(75, 85, 99);
                            doc.text(label, 25, yPos);
                            doc.setTextColor(37, 99, 235);
                            doc.text(value, 120, yPos);
                            yPos += 10;
                        });
                        
                        yPos += 10;
                    }
                    
                    if (includeDetails) {
                        // Add detailed breakdown
                        const detailsTable = sourceElement.querySelector('.details-table');
                        if (detailsTable) {
                            doc.setFontSize(16);
                            doc.setTextColor(37, 99, 235);
                            doc.text('Detailed Breakdown', 20, yPos);
                            yPos += 15;
                            
                            const rows = detailsTable.querySelectorAll('.details-row');
                            rows.forEach(row => {
                                const label = row.querySelector('.details-label')?.textContent || '';
                                const value = row.querySelector('.details-value')?.textContent || '';
                                
                                doc.setFontSize(10);
                                doc.setTextColor(75, 85, 99);
                                doc.text(label, 25, yPos);
                                doc.setTextColor(37, 99, 235);
                                doc.text(value, 120, yPos);
                                yPos += 8;
                            });
                        }
                    }
                    
                    return yPos + 20;
                }

                async addChartToPDF(doc, source, yPos) {
                    try {
                        const chartCanvas = document.querySelector(`#${source}-calculator canvas`);
                        if (!chartCanvas) return;
                        
                        const chartImage = chartCanvas.toDataURL('image/png');
                        doc.addImage(chartImage, 'PNG', 20, yPos, 160, 80);
                    } catch (error) {
                        // Chart export failed - continue without chart
                    }
                }
            }

            // Generic auto-scroll function for mobile
            function autoScrollToResults(calculatorId) {
                if (window.innerWidth <= 768) {
                    // Find the results section (the card right after the inputs)
                    const calculator = document.getElementById(calculatorId + '-calculator');
                    const resultsCard = calculator.querySelector('.card:nth-child(2)'); // Second card is the results
                    
                    if (resultsCard) {
                        setTimeout(() => {
                            resultsCard.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start',
                                inline: 'nearest'
                            });
                        }, 100); // Small delay to ensure DOM is updated
                    }
                }
            }

            // Initialize the export manager
            const exportManager = new ExportManager();

            // Enhanced Mobile Menu Handler
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const mobileMenuClose = document.getElementById('mobile-menu-close');
            const mobileTabs = document.querySelectorAll('.mobile-tab');

            // Initialize mobile menu if elements exist
            if (mobileMenuToggle && mobileMenuOverlay && mobileMenuClose) {
                initializeMobileMenu();
            }

            function initializeMobileMenu() {
                // Open mobile menu
                mobileMenuToggle.addEventListener('click', () => {
                    mobileMenuOverlay.classList.add('show');
                    hapticFeedback('light');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                });

                // Close mobile menu
                function closeMobileMenu() {
                    mobileMenuOverlay.classList.remove('show');
                    document.body.style.overflow = '';
                }

                mobileMenuClose.addEventListener('click', closeMobileMenu);

                // Close when clicking overlay background
                mobileMenuOverlay.addEventListener('click', (e) => {
                    if (e.target === mobileMenuOverlay) {
                        closeMobileMenu();
                    }
                });

                // Handle mobile tab selection
                mobileTabs.forEach(mobileTab => {
                    mobileTab.addEventListener('click', () => {
                        // Remove active class from all mobile tabs
                        mobileTabs.forEach(t => t.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        mobileTab.classList.add('active');
                        
                        // Also update desktop tabs if visible
                        const tabId = mobileTab.getAttribute('data-tab');
                        const desktopTabs = document.querySelectorAll('.tab');
                        desktopTabs.forEach(t => t.classList.remove('active'));
                        const matchingDesktopTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
                        if (matchingDesktopTab) {
                            matchingDesktopTab.classList.add('active');
                        }
                        
                        // Hide all calculators and show selected one - COMPLETE LIST
                        const calculators = [
                            'home', 'mortgage', 'investment', 'cashflow', 'closing', 'buyer', 
                            'commission', 'comparison', 'rentbuy', 'refinance', 'heloc', 
                            'flip', 'brrrr', 'report'
                        ];
                        calculators.forEach(calc => {
                            const element = document.getElementById(`${calc}-calculator`);
                            if (element) element.classList.add('hidden');
                        });
                        
                        const selectedCalculator = document.getElementById(`${tabId}-calculator`);
                        if (selectedCalculator) {
                            selectedCalculator.classList.remove('hidden');
                        }
                        
                        // Always scroll to top when switching calculators
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        hapticFeedback('medium');
                        closeMobileMenu();
                    });
                });

                // Close menu with escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && mobileMenuOverlay.classList.contains('show')) {
                        closeMobileMenu();
                    }
                });
            }

            // Initialize mobile enhancements
            setupInputValidation();
            setupAutoSave();
            
            // Load any auto-saved data
            setTimeout(() => {
                loadAutoSavedData();
            }, 1000);

            // Set visited flag for first-time users
            setTimeout(() => {
                if (!localStorage.getItem('hasVisited')) {
                    try {
                        localStorage.setItem('hasVisited', 'true');
                    } catch (e) {
                        // localStorage not available
                    }
                }
            }, 2000);
        });

        // Hide loading screen after page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 1500); // Show loading for at least 1.5 seconds
        });

        // Production readiness check
        function performProductionChecks() {
            // Check if all required elements exist
            const requiredElements = [
                'app-title', 'mobile-menu-toggle', 'mobile-menu-overlay', 'mobile-menu-close',
                'mortgage-calculator', 'investment-calculator', 'cashflow-calculator',
                'closing-calculator', 'buyer-calculator', 'commission-calculator',
                'comparison-calculator'
            ];
            
            let allElementsExist = true;
            requiredElements.forEach(id => {
                if (!document.getElementById(id)) {
                    allElementsExist = false;
                }
            });
            
            // Check if Chart.js is loaded
            const chartsAvailable = typeof Chart !== 'undefined';
            
            // Check if export libraries are loaded
            const exportAvailable = typeof window.jspdf !== 'undefined' && typeof html2canvas !== 'undefined';
            
            // All checks passed - app is production ready
            return allElementsExist && chartsAvailable;
        }
        
        // Run production checks after page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                const isReady = performProductionChecks();
                if (isReady) {
                    document.body.classList.add('production-ready');
                }
            }, 100);
        });
    </script>
</body>
</html>